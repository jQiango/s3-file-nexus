<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 文件管理器 - 配置</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] {
            display: none !important;
        }

        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out;
        }

        @keyframes slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .animate-fade-in {
            animation: fade-in 0.4s ease-out;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .history-card {
            transition: all 0.2s ease;
        }
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 按钮动效 */
        button {
            transition: all 0.2s ease;
        }
        button:not(:disabled):hover {
            transform: translateY(-1px);
        }
        button:not(:disabled):active {
            transform: translateY(0);
        }

        /* Toast动效增强 */
        .toast-enter {
            animation: slide-in-right 0.3s ease-out;
        }
    </style>
</head>
<body class="h-full overflow-auto bg-gradient-to-br from-gray-50 via-white to-gray-50">
    <div id="app" v-cloak class="min-h-screen py-12 px-4 relative">
        <!-- 加载提示（右下角） -->
        <div v-if="loading" class="fixed bottom-6 right-6 z-50 bg-white rounded-xl shadow-2xl border border-gray-200 p-4 animate-slide-up max-w-xs">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center flex-shrink-0">
                    <i class="bi bi-arrow-clockwise text-white text-lg animate-spin"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">{{ loadingMessage }}</p>
                    <p class="text-xs text-gray-600 mt-0.5">请稍候...</p>
                </div>
            </div>
        </div>

        <!-- 主容器 -->
        <div class="max-w-xl mx-auto">
            <!-- Logo和标题 -->
            <div class="text-center mb-6 animate-fade-in">
                <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg mb-3">
                    <i class="bi bi-cloud-fill text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-1">S3 文件管理器</h1>
                <p class="text-sm text-gray-600">配置您的对象存储连接</p>
            </div>

            <!-- Toast 通知 -->
            <div v-if="alert.show"
                 class="mb-6 p-4 rounded-xl border-2 flex items-start gap-3 animate-slide-in-right"
                 :class="{
                     'bg-green-50 border-green-200': alert.type === 'success',
                     'bg-red-50 border-red-200': alert.type === 'error'
                 }">
                <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                     :class="{
                         'bg-green-100': alert.type === 'success',
                         'bg-red-100': alert.type === 'error'
                     }">
                    <i class="text-xl"
                       :class="{
                           'bi bi-check-circle text-green-600': alert.type === 'success',
                           'bi bi-x-circle text-red-600': alert.type === 'error'
                       }"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold text-sm mb-1"
                        :class="{
                            'text-green-900': alert.type === 'success',
                            'text-red-900': alert.type === 'error'
                        }">
                        {{ alert.type === 'success' ? '操作成功' : '操作失败' }}
                    </h4>
                    <p class="text-xs"
                       :class="{
                           'text-green-800': alert.type === 'success',
                           'text-red-800': alert.type === 'error'
                       }">{{ alert.message }}</p>
                </div>
                <button @click="alert.show = false" class="text-gray-500 hover:text-gray-700">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <!-- 配置表单卡片 -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-5 animate-slide-up">
                <form @submit.prevent="saveConfig">
                    <!-- Endpoint -->
                    <div class="mb-4">
                        <label class="flex items-center gap-1.5 text-xs font-medium text-gray-700 mb-2">
                            <i class="bi bi-link-45deg text-blue-600 text-sm"></i>
                            服务端点 (Endpoint) <span class="text-red-500">*</span>
                        </label>
                        <input
                            v-model="config.endpoint"
                            type="text"
                            placeholder="https://s3.amazonaws.com"
                            class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            required>
                        <p class="text-xs text-gray-500 mt-1.5">示例: http://minio:9000</p>
                    </div>

                    <!-- Access Key -->
                    <div class="mb-4">
                        <label class="flex items-center gap-1.5 text-xs font-medium text-gray-700 mb-2">
                            <i class="bi bi-key-fill text-blue-600 text-sm"></i>
                            Access Key ID <span class="text-red-500">*</span>
                        </label>
                        <input
                            v-model="config.accessKey"
                            type="text"
                            placeholder="输入您的 Access Key ID"
                            class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none font-mono transition-all"
                            required>
                    </div>

                    <!-- Secret Key -->
                    <div class="mb-4">
                        <label class="flex items-center gap-1.5 text-xs font-medium text-gray-700 mb-2">
                            <i class="bi bi-shield-lock-fill text-blue-600 text-sm"></i>
                            Secret Access Key <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input
                                v-model="config.secretKey"
                                :type="showSecret ? 'text' : 'password'"
                                placeholder="输入您的 Secret Access Key"
                                class="w-full px-4 py-2.5 pr-10 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none font-mono transition-all"
                                required>
                            <button
                                type="button"
                                @click="showSecret = !showSecret"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 transition-colors">
                                <i :class="showSecret ? 'bi-eye-slash' : 'bi-eye'"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Region 和 Bucket 并排 -->
                    <div class="grid grid-cols-2 gap-3 mb-5">
                        <!-- Region -->
                        <div>
                            <label class="flex items-center gap-1.5 text-xs font-medium text-gray-700 mb-2">
                                <i class="bi bi-globe2 text-blue-600 text-sm"></i>
                                区域
                            </label>
                            <input
                                v-model="config.region"
                                type="text"
                                placeholder="ap-beijing"
                                class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                        </div>

                        <!-- Default Bucket -->
                        <div>
                            <label class="flex items-center gap-1.5 text-xs font-medium text-gray-700 mb-2">
                                <i class="bi bi-database text-blue-600 text-sm"></i>
                                存储桶
                            </label>
                            <input
                                v-model="config.bucket"
                                type="text"
                                placeholder="my-bucket"
                                class="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                        </div>
                    </div>

                    <!-- 按钮组 -->
                    <div class="flex gap-2">
                        <button
                            type="button"
                            @click="testConnection"
                            :disabled="testing"
                            class="flex-1 flex items-center justify-center gap-1.5 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                            <i :class="testing ? 'bi-arrow-clockwise animate-spin' : 'bi-wifi'" class="text-sm"></i>
                            <span>{{ testing ? '测试中...' : '测试连接' }}</span>
                        </button>
                        <button
                            type="submit"
                            :disabled="saving"
                            class="flex-1 flex items-center justify-center gap-1.5 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <i :class="saving ? 'bi-arrow-clockwise animate-spin' : 'bi-check-circle'" class="text-sm"></i>
                            <span>{{ saving ? '保存中...' : '保存并进入' }}</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 历史配置 -->
            <div v-if="savedConfigs.length > 0" class="bg-white rounded-xl shadow-lg border border-gray-200 p-5 mb-5 animate-slide-up">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-bold text-gray-900 flex items-center gap-1.5">
                        <i class="bi bi-clock-history text-blue-600 text-sm"></i>
                        最近使用的配置
                    </h3>
                    <span class="text-xs text-gray-500">{{ savedConfigs.length }} 个</span>
                </div>

                <div class="grid gap-2">
                    <div
                        v-for="(item, index) in savedConfigs"
                        :key="index"
                        class="history-card flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-blue-300 cursor-pointer group bg-gray-50 hover:bg-white">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center">
                            <i class="bi bi-server text-blue-600"></i>
                        </div>
                        <div class="flex-1 min-w-0" @click="useConfig(index)">
                            <div class="font-medium text-sm text-gray-900 truncate">{{ item.name }}</div>
                            <div class="text-xs text-gray-500 truncate">{{ item.endpoint }}</div>
                        </div>
                        <div class="flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button
                                @click.stop="useConfig(index)"
                                class="px-2.5 py-1 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 hover:shadow-md flex items-center gap-1">
                                <i class="bi bi-box-arrow-in-right"></i>
                                使用
                            </button>
                            <button
                                @click.stop="deleteConfig(index)"
                                class="px-2 py-1 bg-red-600 text-white text-xs rounded-md hover:bg-red-700 hover:shadow-md">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 安全提示 -->
            <div class="flex items-start gap-2 justify-center text-sm text-gray-500 animate-fade-in">
                <i class="bi bi-shield-check mt-0.5"></i>
                <p>配置信息仅保存在本地浏览器中，不会上传到服务器。请妥善保管您的密钥信息。</p>
            </div>
        </div>
    </div>

    <!-- Vue 3 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.4.21/vue.global.prod.min.js"></script>

    <script>
        const { createApp } = Vue;
        const STORAGE_KEY = 's3_configs';

        createApp({
            data() {
                return {
                    config: {
                        name: '',
                        endpoint: '',
                        accessKey: '',
                        secretKey: '',
                        region: 'ap-beijing',
                        bucket: ''
                    },
                    savedConfigs: [],
                    showSecret: false,
                    testing: false,
                    saving: false,
                    loading: false,
                    loadingMessage: '正在加载配置',
                    alert: {
                        show: false,
                        type: 'success',
                        message: ''
                    }
                };
            },
            mounted() {
                this.loadSavedConfigs();
            },
            methods: {
                loadSavedConfigs() {
                    const configs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    this.savedConfigs = configs;
                },
                showAlert(message, type = 'success') {
                    this.alert = {
                        show: true,
                        type,
                        message
                    };
                    setTimeout(() => {
                        this.alert.show = false;
                    }, 5000);
                },
                async testConnection() {
                    // 验证必填字段
                    if (!this.config.endpoint || !this.config.accessKey || !this.config.secretKey) {
                        this.showAlert('请填写完整的连接信息（Endpoint、Access Key、Secret Key）', 'error');
                        return;
                    }

                    this.testing = true;
                    try {
                        const response = await fetch('/api/storage/config/test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.config)
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.showAlert('连接测试成功！可以正常访问存储服务。', 'success');
                        } else {
                            this.showAlert('连接测试失败: ' + (result.message || '未知错误'), 'error');
                        }
                    } catch (error) {
                        this.showAlert('连接测试失败: ' + error.message, 'error');
                    } finally {
                        this.testing = false;
                    }
                },
                async saveConfig() {
                    // 自动生成配置名称
                    if (!this.config.name) {
                        const now = new Date();
                        this.config.name = `配置-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                    }

                    // 验证必填字段
                    if (!this.config.endpoint || !this.config.accessKey || !this.config.secretKey) {
                        this.showAlert('请填写完整的配置信息（Endpoint、Access Key、Secret Key）', 'error');
                        return;
                    }

                    this.saving = true;
                    try {
                        const response = await fetch('/api/storage/config/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.config)
                        });

                        const result = await response.json();

                        if (result.success) {
                            // 保存到localStorage
                            const configs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                            const existingIndex = configs.findIndex(c => c.name === this.config.name);

                            if (existingIndex >= 0) {
                                configs[existingIndex] = { ...this.config };
                            } else {
                                configs.push({ ...this.config });
                                // 只保留最近10个配置
                                if (configs.length > 10) {
                                    configs.shift();
                                }
                            }

                            localStorage.setItem(STORAGE_KEY, JSON.stringify(configs));
                            sessionStorage.setItem('current_s3_config', JSON.stringify(this.config));

                            // 显示加载遮罩
                            this.loading = true;
                            this.loadingMessage = '配置保存成功，正在跳转';

                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 1000);
                        } else {
                            this.showAlert('配置保存失败: ' + (result.message || '未知错误'), 'error');
                        }
                    } catch (error) {
                        this.showAlert('配置保存失败: ' + error.message, 'error');
                    } finally {
                        this.saving = false;
                    }
                },
                async useConfig(index) {
                    const config = this.savedConfigs[index];
                    if (!config) return;

                    // 显示加载遮罩
                    this.loading = true;
                    this.loadingMessage = '正在加载配置';

                    try {
                        const response = await fetch('/api/storage/config/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(config)
                        });

                        const result = await response.json();

                        if (result.success) {
                            sessionStorage.setItem('current_s3_config', JSON.stringify(config));
                            this.loadingMessage = '配置加载成功，正在跳转';
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 800);
                        } else {
                            this.loading = false;
                            this.showAlert('加载配置失败: ' + (result.message || '未知错误'), 'error');
                        }
                    } catch (error) {
                        this.loading = false;
                        this.showAlert('加载配置失败: ' + error.message, 'error');
                    }
                },
                deleteConfig(index) {
                    const config = this.savedConfigs[index];
                    if (!confirm(`确定要删除配置"${config.name}"吗？`)) {
                        return;
                    }

                    const configs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    configs.splice(index, 1);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(configs));
                    this.loadSavedConfigs();
                    this.showAlert('配置已删除', 'success');
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
