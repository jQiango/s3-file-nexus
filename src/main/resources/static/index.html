<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Êñá‰ª∂ÁÆ°ÁêÜÂô®</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Bootstrap Icons - BootCDN -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">

    <!-- Highlight.js - Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Marked.js - Markdown Parser -->
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/11.1.1/marked.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] {
            display: none !important;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out;
        }

        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }

        /* Êñá‰ª∂Âç°ÁâáÊÇ¨ÂÅúÊïàÊûú */
        .file-card {
            transition: all 0.2s ease;
        }
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* MarkdownÊ∏≤ÊüìÊ†∑Âºè */
        .markdown-content {
            line-height: 1.8;
            color: #333;
        }
        .markdown-content h1 {
            font-size: 2em;
            font-weight: bold;
            margin: 1em 0 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 2px solid #e5e7eb;
        }
        .markdown-content h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0.8em 0 0.4em;
            padding-bottom: 0.2em;
            border-bottom: 1px solid #e5e7eb;
        }
        .markdown-content h3 {
            font-size: 1.25em;
            font-weight: bold;
            margin: 0.6em 0 0.3em;
        }
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            font-weight: bold;
            margin: 0.5em 0 0.2em;
        }
        .markdown-content p {
            margin: 1em 0;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        .markdown-content li {
            margin: 0.5em 0;
        }
        .markdown-content blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            border-left: 4px solid #3b82f6;
            background: #f3f4f6;
            color: #6b7280;
        }
        .markdown-content code {
            padding: 0.2em 0.4em;
            background: #f3f4f6;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        .markdown-content pre {
            margin: 1em 0;
            padding: 1em;
            background: #1f2937;
            border-radius: 6px;
            overflow-x: auto;
        }
        .markdown-content pre code {
            padding: 0;
            background: transparent;
            color: #e5e7eb;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5em 1em;
            text-align: left;
        }
        .markdown-content th {
            background: #f3f4f6;
            font-weight: bold;
        }
        .markdown-content a {
            color: #3b82f6;
            text-decoration: none;
        }
        .markdown-content a:hover {
            text-decoration: underline;
        }
        .markdown-content img {
            max-width: 100%;
            height: auto;
        }
        .markdown-content hr {
            margin: 2em 0;
            border: none;
            border-top: 1px solid #e5e7eb;
        }

        /* Âè≥ÈîÆËèúÂçïÊ†∑Âºè */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 4px;
            min-width: 180px;
            z-index: 9999;
            border: 1px solid #e5e7eb;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
            transition: all 0.15s;
        }
        .context-menu-item:hover {
            background: #f3f4f6;
            color: #1f2937;
        }
        .context-menu-item.danger:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        .context-menu-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }
    </style>
</head>
<body class="h-full overflow-hidden bg-gray-50">
    <div id="app" v-cloak class="flex h-screen w-full">
        <!-- Â∑¶‰æßËæπÊ†è -->
        <aside class="w-64 bg-gradient-to-b from-blue-600 to-blue-700 text-white flex flex-col h-full flex-shrink-0 shadow-lg">
            <!-- LogoÂå∫Âüü -->
            <div class="p-6 border-b border-blue-500/30">
                <div class="flex items-center gap-3 mb-1">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shrink-0 shadow-md">
                        <i class="bi bi-cloud-fill text-blue-600 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h1 class="font-bold text-lg">S3Êñá‰ª∂ÁÆ°ÁêÜÂô®</h1>
                        <p class="text-xs text-blue-100">ÂØπË±°Â≠òÂÇ®</p>
                    </div>
                </div>
            </div>

            <!-- Â≠òÂÇ®Ê°∂ÂàÜÁ±ªÂàóË°® -->
            <div class="flex-1 overflow-y-auto scrollbar-thin p-4">
                <div class="mb-4">
                    <p class="text-xs font-semibold text-blue-100 uppercase tracking-wider mb-2 px-2">Â≠òÂÇ®Ê°∂ÂàóË°®</p>
                    <div class="space-y-1">
                        <button
                            v-for="bucket in buckets"
                            :key="bucket"
                            @click="selectBucket(bucket)"
                            :class="currentBucket === bucket ? 'bg-white text-blue-700 shadow-md' : 'text-white hover:bg-blue-500'"
                            class="w-full px-3 py-2.5 rounded-lg text-left flex items-center gap-3 transition-all text-sm">
                            <i class="bi bi-database text-lg"></i>
                            <span class="truncate flex-1">{{ bucket }}</span>
                            <div v-if="currentBucket === bucket" class="w-2 h-2 rounded-full bg-blue-600"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Âà∑Êñ∞ÊåâÈíÆ -->
            <div class="p-4 border-t border-blue-500/30">
                <button
                    @click="loadFiles"
                    class="w-full bg-white hover:bg-blue-50 text-blue-700 px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 shadow-md">
                    <i class="bi bi-arrow-clockwise"></i>
                    Âà∑Êñ∞ÂàóË°®
                </button>
            </div>
        </aside>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <main class="flex-1 flex flex-col min-w-0 bg-white">
            <!-- È°∂ÈÉ®Ê†áÈ¢òÊ†è -->
            <div class="px-8 py-6 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">{{ currentBucket || 'ËØ∑ÈÄâÊã©Â≠òÂÇ®Ê°∂' }}</h2>
                    <div class="flex items-center gap-3">
                        <!-- ËßÜÂõæÂàáÊç¢ -->
                        <div class="flex items-center gap-1 bg-blue-50 rounded-lg p-1">
                            <button
                                @click="viewMode = 'list'"
                                :class="viewMode === 'list' ? 'bg-white shadow-sm' : 'hover:bg-gray-100'"
                                class="p-2 rounded-md transition-colors text-gray-700"
                                title="ÂàóË°®ËßÜÂõæ">
                                <i class="bi bi-list-ul text-lg"></i>
                            </button>
                            <button
                                @click="viewMode = 'grid'"
                                :class="viewMode === 'grid' ? 'bg-white shadow-sm' : 'hover:bg-gray-100'"
                                class="p-2 rounded-md transition-colors text-gray-700"
                                title="ÁΩëÊ†ºËßÜÂõæ">
                                <i class="bi bi-grid-3x3-gap text-lg"></i>
                            </button>
                        </div>

                        <!-- ËøîÂõûÈÖçÁΩÆ -->
                        <button
                            @click="goToConfig"
                            class="p-2 rounded-lg hover:bg-gray-100 text-gray-700"
                            title="ÈÖçÁΩÆÁÆ°ÁêÜ">
                            <i class="bi bi-gear-fill text-lg"></i>
                        </button>

                        <!-- Ê∏ÖÈô§ÁºìÂ≠ò -->
                        <button
                            @click="clearServiceWorkerCache"
                            class="p-2 rounded-lg hover:bg-gray-100 text-gray-700"
                            title="Ê∏ÖÈô§ÁºìÂ≠ò">
                            <i class="bi bi-trash-fill text-lg"></i>
                        </button>

                        <div class="h-6 w-px bg-gray-300"></div>

                        <!-- ‰∏ä‰º†ÊåâÈíÆ -->
                        <button
                            @click="showUploadDialog = true"
                            class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-md">
                            <i class="bi bi-cloud-upload"></i>
                            ‰∏ä‰º†Êñá‰ª∂
                        </button>
                        <!-- Êñ∞Âª∫Êñá‰ª∂Â§π -->
                        <button
                            @click="showCreateFolderDialog = true"
                            class="flex items-center gap-2 bg-white hover:bg-gray-50 text-blue-700 px-4 py-2 rounded-lg transition-colors shadow-md">
                            <i class="bi bi-folder-plus"></i>
                            Êñ∞Âª∫Êñá‰ª∂Â§π
                        </button>
                    </div>
                </div>

                <!-- ÊêúÁ¥¢Ê°Ü -->
                <div class="relative">
                    <i class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-lg"></i>
                    <input
                        type="text"
                        v-model="searchKeyword"
                        @keyup.enter="handleSearch"
                        placeholder="ÊåâÊñá‰ª∂ÂêçÊàñÂâçÁºÄÊêúÁ¥¢"
                        class="w-full pl-12 pr-4 py-3 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                </div>

                <!-- È´òÁ∫ßÁ≠õÈÄâ -->
                <div class="flex items-center gap-3 mt-3">
                    <button
                        @click="showAdvancedFilters = !showAdvancedFilters"
                        class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="bi bi-funnel text-lg"></i>
                        <span>È´òÁ∫ßÁ≠õÈÄâ</span>
                        <i :class="showAdvancedFilters ? 'bi-chevron-up' : 'bi-chevron-down'" class="text-xs"></i>
                    </button>
                    <div v-if="hasActiveFilters" class="flex items-center gap-2">
                        <span class="text-xs text-gray-600">Â∑≤ÂêØÁî® {{ activeFilterCount }} ‰∏™Á≠õÈÄâ</span>
                        <button
                            @click="clearFilters"
                            class="text-xs text-blue-600 hover:text-blue-700 underline">
                            Ê∏ÖÈô§ÂÖ®ÈÉ®
                        </button>
                    </div>
                </div>

                <!-- Á≠õÈÄâÈù¢Êùø -->
                <div v-if="showAdvancedFilters" class="mt-3 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Êñá‰ª∂Á±ªÂûãÁ≠õÈÄâ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Êñá‰ª∂Á±ªÂûã</label>
                            <select
                                v-model="filters.fileType"
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                                <option value="">ÂÖ®ÈÉ®Á±ªÂûã</option>
                                <option value="folder">üìÅ Êñá‰ª∂Â§π</option>
                                <option value="image">üñºÔ∏è ÂõæÁâá</option>
                                <option value="video">üé¨ ËßÜÈ¢ë</option>
                                <option value="audio">üéµ Èü≥È¢ë</option>
                                <option value="document">üìÑ ÊñáÊ°£</option>
                                <option value="archive">üì¶ ÂéãÁº©ÂåÖ</option>
                                <option value="code">üíª ‰ª£Á†Å</option>
                                <option value="other">üìã ÂÖ∂‰ªñ</option>
                            </select>
                        </div>

                        <!-- Êó∂Èó¥ËåÉÂõ¥ - ÂºÄÂßã -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÂºÄÂßãÊó•Êúü</label>
                            <input
                                type="date"
                                v-model="filters.startDate"
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        </div>

                        <!-- Êó∂Èó¥ËåÉÂõ¥ - ÁªìÊùü -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÁªìÊùüÊó•Êúü</label>
                            <input
                                type="date"
                                v-model="filters.endDate"
                                class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        </div>
                    </div>

                    <!-- Âø´Êç∑Êó∂Èó¥ÈÄâÊã© -->
                    <div class="flex items-center gap-2 mt-3">
                        <span class="text-xs text-gray-600">Âø´Êç∑ÈÄâÊã©:</span>
                        <button
                            @click="setQuickDateRange('today')"
                            class="px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded">
                            ‰ªäÂ§©
                        </button>
                        <button
                            @click="setQuickDateRange('week')"
                            class="px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded">
                            ÊúÄËøë7Â§©
                        </button>
                        <button
                            @click="setQuickDateRange('month')"
                            class="px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded">
                            ÊúÄËøë30Â§©
                        </button>
                        <button
                            @click="setQuickDateRange('year')"
                            class="px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded">
                            ÊúÄËøë‰∏ÄÂπ¥
                        </button>
                    </div>
                </div>
            </div>

            <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
            <div class="px-8 py-4 border-b border-gray-200 bg-gray-50">
                <nav class="flex items-center gap-2 text-sm">
                    <button
                        @click="navigateToPath('')"
                        @contextmenu="showContextMenu($event, 'breadcrumb', '')"
                        class="flex items-center gap-2 px-3 py-1.5 rounded-md hover:bg-gray-100 text-gray-700 hover:text-blue-600 transition-colors">
                        <i class="bi bi-house-fill"></i>
                        <span>Ê†πÁõÆÂΩï</span>
                    </button>
                    <template v-for="(part, index) in pathParts" :key="index">
                        <i class="bi bi-chevron-right text-gray-500 text-xs"></i>
                        <button
                            @click="navigateToPath(getPathUpTo(index))"
                            @contextmenu="showContextMenu($event, 'breadcrumb', getPathUpTo(index))"
                            class="px-3 py-1.5 rounded-md hover:bg-gray-100 font-medium"
                            :class="index === pathParts.length - 1 ? 'text-blue-600' : 'text-gray-700 hover:text-blue-600'">
                            {{ part }}
                        </button>
                    </template>
                </nav>
            </div>

            <!-- Êñá‰ª∂ÂàóË°®Âå∫Âüü -->
            <div class="flex-1 overflow-y-auto scrollbar-thin p-8">
                <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                <div v-if="loading" class="flex flex-col items-center justify-center h-64">
                    <i class="bi bi-arrow-clockwise text-6xl text-gray-400 mb-4 opacity-50 animate-spin"></i>
                    <p class="text-gray-700">Âä†ËΩΩ‰∏≠...</p>
                </div>

                <!-- Á©∫Áä∂ÊÄÅ -->
                <div v-else-if="displayFiles.length === 0" class="flex flex-col items-center justify-center h-64">
                    <i class="bi bi-folder2-open text-6xl text-gray-400 mb-4 opacity-50"></i>
                    <p class="text-gray-700">Êú™ÊâæÂà∞Êñá‰ª∂</p>
                </div>

                <!-- ÂàóË°®ËßÜÂõæ -->
                <div v-else-if="viewMode === 'list'" class="space-y-1">
                    <div
                        v-for="file in displayFiles"
                        :key="file.key"
                        @click="handleFileClick(file)"
                        @contextmenu="showContextMenu($event, 'file', file)"
                        class="file-card flex items-center gap-3 px-4 py-2.5 border border-gray-200 bg-white rounded-lg cursor-pointer group">
                        <!-- Êñá‰ª∂ÂõæÊ†á -->
                        <div class="flex-shrink-0">
                            <i :class="[getFileIcon(file), getFileColor(file)]" class="text-2xl"></i>
                        </div>

                        <!-- Êñá‰ª∂‰ø°ÊÅØ -->
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-900 truncate">{{ file.name }}</h3>
                            <div class="flex items-center gap-3 text-xs text-gray-600">
                                <span v-if="!file.isFolder">{{ formatFileSize(file.size) }}</span>
                                <span v-if="file.isFolder && folderSizes[file.key]">
                                    <i class="bi bi-hdd"></i> {{ formatFileSize(folderSizes[file.key]) }}
                                </span>
                                <span v-if="!file.isFolder">{{ formatDate(file.lastModified) }}</span>
                            </div>
                        </div>

                        <!-- Êìç‰ΩúÊåâÈíÆÔºàÊÇ¨ÂÅúÊòæÁ§∫Ôºâ -->
                        <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button
                                v-if="!file.isFolder && canPreview(file)"
                                @click.stop="previewFile(file)"
                                class="p-1.5 hover:bg-gray-50 rounded text-gray-600 hover:text-green-600"
                                title="È¢ÑËßà">
                                <i class="bi bi-eye text-sm"></i>
                            </button>
                            <button
                                v-if="!file.isFolder"
                                @click.stop="downloadFile(file)"
                                class="p-1.5 hover:bg-gray-50 rounded text-gray-600 hover:text-blue-600"
                                title="‰∏ãËΩΩ">
                                <i class="bi bi-download text-sm"></i>
                            </button>
                            <button
                                @click.stop="renameFile(file)"
                                class="p-1.5 hover:bg-gray-50 rounded text-gray-600 hover:text-purple-600"
                                title="ÈáçÂëΩÂêç">
                                <i class="bi bi-pencil text-sm"></i>
                            </button>
                            <button
                                @click.stop="deleteFile(file)"
                                class="p-1.5 hover:bg-gray-50 rounded text-gray-600 hover:text-red-600"
                                title="Âà†Èô§">
                                <i class="bi bi-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÁΩëÊ†ºËßÜÂõæ -->
                <div v-else-if="viewMode === 'grid'" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <div
                        v-for="file in displayFiles"
                        :key="file.key"
                        @click="handleFileClick(file)"
                        @contextmenu="showContextMenu($event, 'file', file)"
                        class="file-card group relative flex flex-col items-center p-4 border border-gray-200 bg-white rounded-lg cursor-pointer hover:border-blue-400">
                        <!-- Êñá‰ª∂ÂõæÊ†á -->
                        <i :class="[getFileIcon(file), getFileColor(file)]" class="text-5xl mb-3"></i>

                        <!-- Êñá‰ª∂Âêç -->
                        <h3 class="text-sm font-medium text-gray-900 text-center truncate w-full px-2" :title="file.name">
                            {{ file.name }}
                        </h3>

                        <!-- Êñá‰ª∂‰ø°ÊÅØ -->
                        <div v-if="!file.isFolder" class="text-xs text-gray-600 mt-1 text-center">
                            <div>{{ formatFileSize(file.size) }}</div>
                            <div class="truncate w-full px-2">{{ formatDate(file.lastModified) }}</div>
                        </div>
                        <div v-else-if="file.isFolder && folderSizes[file.key]" class="text-xs text-gray-600 mt-1 text-center">
                            <div><i class="bi bi-hdd"></i> {{ formatFileSize(folderSizes[file.key]) }}</div>
                        </div>

                        <!-- Êìç‰ΩúÊåâÈíÆÔºàÊÇ¨ÂÅúÊòæÁ§∫Ôºâ -->
                        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white rounded-lg shadow-lg p-1">
                            <button
                                v-if="!file.isFolder && canPreview(file)"
                                @click.stop="previewFile(file)"
                                class="p-1.5 hover:bg-blue-50 rounded text-gray-600 hover:text-green-600"
                                title="È¢ÑËßà">
                                <i class="bi bi-eye text-sm"></i>
                            </button>
                            <button
                                v-if="!file.isFolder"
                                @click.stop="downloadFile(file)"
                                class="p-1.5 hover:bg-blue-50 rounded text-gray-600 hover:text-blue-600"
                                title="‰∏ãËΩΩ">
                                <i class="bi bi-download text-sm"></i>
                            </button>
                            <button
                                @click.stop="renameFile(file)"
                                class="p-1.5 hover:bg-blue-50 rounded text-gray-600 hover:text-purple-600"
                                title="ÈáçÂëΩÂêç">
                                <i class="bi bi-pencil text-sm"></i>
                            </button>
                            <button
                                @click.stop="deleteFile(file)"
                                class="p-1.5 hover:bg-blue-50 rounded text-gray-600 hover:text-red-600"
                                title="Âà†Èô§">
                                <i class="bi bi-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÂàÜÈ°µ -->
                <div v-if="!loading && totalPages > 1" class="flex items-center justify-between mt-8 pt-6 border-t border-gray-200">
                    <div class="text-sm text-gray-700">
                        ÊòæÁ§∫ {{ (currentPage - 1) * pageSize + 1 }}-{{ Math.min(currentPage * pageSize, sortedFiles.length) }} / ÂÖ± {{ sortedFiles.length }} È°π
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="currentPage = 1" :disabled="currentPage === 1" class="px-3 py-1.5 rounded-lg bg-white hover:bg-white text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="bi bi-chevron-bar-left"></i>
                        </button>
                        <button @click="currentPage--" :disabled="currentPage === 1" class="px-3 py-1.5 rounded-lg bg-white hover:bg-white text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span class="px-4 py-1.5 text-sm text-gray-900">Á¨¨ {{ currentPage }} / {{ totalPages }} È°µ</span>
                        <button @click="currentPage++" :disabled="currentPage === totalPages" class="px-3 py-1.5 rounded-lg bg-white hover:bg-white text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <button @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="px-3 py-1.5 rounded-lg bg-white hover:bg-white text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="bi bi-chevron-bar-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- ‰∏ä‰º†ÂØπËØùÊ°Ü -->
        <div v-if="showUploadDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showUploadDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
                <h3 class="text-xl font-bold mb-4 text-gray-900">‰∏ä‰º†Êñá‰ª∂</h3>
                <input
                    type="file"
                    multiple
                    @change="handleFileSelect"
                    class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 mb-4">
                <div class="flex justify-end gap-3">
                    <button @click="showUploadDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="doUploadFiles" :disabled="uploadFiles.length === 0" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">‰∏ä‰º†</button>
                </div>
            </div>
        </div>

        <!-- ÂàõÂª∫Êñá‰ª∂Â§πÂØπËØùÊ°Ü -->
        <div v-if="showCreateFolderDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showCreateFolderDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
                <h3 class="text-xl font-bold mb-4 text-gray-900">Êñ∞Âª∫Êñá‰ª∂Â§π</h3>
                <input
                    v-model="folderName"
                    type="text"
                    placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 bg-white text-gray-900 placeholder-gray-500">
                <div class="flex justify-end gap-3">
                    <button @click="showCreateFolderDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="createFolder" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ÂàõÂª∫</button>
                </div>
            </div>
        </div>

        <!-- Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°Ü -->
        <div v-if="showDeleteDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showDeleteDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                        <i class="bi bi-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-gray-900">Á°ÆËÆ§Âà†Èô§</h3>
                        <p class="text-sm text-gray-600 mt-1">Ê≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç</p>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-3">
                        <i :class="[getFileIcon(fileToDelete), getFileColor(fileToDelete)]" class="text-2xl"></i>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate">{{ fileToDelete?.name }}</p>
                            <p class="text-xs text-gray-600 mt-0.5">
                                {{ fileToDelete?.isFolder ? 'Êñá‰ª∂Â§π' : formatFileSize(fileToDelete?.size) }}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3">
                    <button @click="showDeleteDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2">
                        <i class="bi bi-trash"></i>
                        Á°ÆËÆ§Âà†Èô§
                    </button>
                </div>
            </div>
        </div>

        <!-- ÈáçÂëΩÂêçÂØπËØùÊ°Ü -->
        <div v-if="showRenameDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showRenameDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                        <i class="bi bi-pencil-square text-blue-600 text-2xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-gray-900">ÈáçÂëΩÂêç</h3>
                        <p class="text-sm text-gray-600 mt-1">{{ fileToRename?.isFolder ? 'Êñá‰ª∂Â§π' : 'Êñá‰ª∂' }}</p>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-3">
                        <i :class="[getFileIcon(fileToRename), getFileColor(fileToRename)]" class="text-2xl"></i>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate">{{ fileToRename?.name }}</p>
                            <p class="text-xs text-gray-600 mt-0.5">
                                {{ fileToRename?.isFolder ? 'Êñá‰ª∂Â§π' : formatFileSize(fileToRename?.size) }}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Êñ∞ÂêçÁß∞</label>
                    <input
                        v-model="newFileName"
                        type="text"
                        placeholder="ËØ∑ËæìÂÖ•Êñ∞ÂêçÁß∞"
                        @keyup.enter="confirmRename"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                </div>
                <div class="flex justify-end gap-3">
                    <button @click="showRenameDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">ÂèñÊ∂à</button>
                    <button @click="confirmRename" :disabled="!newFileName.trim()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="bi bi-check-lg"></i>
                        Á°ÆËÆ§ÈáçÂëΩÂêç
                    </button>
                </div>
            </div>
        </div>

        <!-- ÂàÜ‰∫´ÈìæÊé•ÂØπËØùÊ°Ü -->
        <div v-if="showShareDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showShareDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                        <i class="bi bi-share text-green-600 text-2xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-gray-900">ÁîüÊàêÂàÜ‰∫´ÈìæÊé•</h3>
                        <p class="text-sm text-gray-600 mt-1">ËÆæÁΩÆÈìæÊé•ËøáÊúüÊó∂Èó¥</p>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-3">
                        <i :class="[getFileIcon(fileToShare), getFileColor(fileToShare)]" class="text-2xl"></i>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate">{{ fileToShare?.name }}</p>
                            <p class="text-xs text-gray-600 mt-0.5">{{ formatFileSize(fileToShare?.size) }}</p>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ËøáÊúüÊó∂Èó¥</label>
                    <select
                        v-model="shareExpiration"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        <option value="3600">1Â∞èÊó∂</option>
                        <option value="21600">6Â∞èÊó∂</option>
                        <option value="86400">1Â§©</option>
                        <option value="259200">3Â§©</option>
                        <option value="604800">7Â§©</option>
                    </select>
                </div>

                <div v-if="shareUrl" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜ‰∫´ÈìæÊé•</label>
                    <div class="flex items-center gap-2">
                        <input
                            :value="shareUrl"
                            readonly
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm"
                            @focus="$event.target.select()">
                        <button
                            @click="copyShareUrl"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 whitespace-nowrap">
                            <i class="bi bi-clipboard"></i>
                            Â§çÂà∂
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mt-2">
                        ÈìæÊé•Â∞Ü‰∫é {{ formatExpirationTime(shareExpiresAt) }} ËøáÊúü
                    </p>
                </div>

                <div class="flex justify-end gap-3">
                    <button @click="showShareDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">ÂèñÊ∂à</button>
                    <button
                        v-if="!shareUrl"
                        @click="generateShareUrl"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                        <i class="bi bi-link-45deg"></i>
                        ÁîüÊàêÈìæÊé•
                    </button>
                </div>
            </div>
        </div>

        <!-- Êñá‰ª∂È¢ÑËßàÂØπËØùÊ°Ü -->
        <div v-if="showPreviewDialog" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" @click.self="showPreviewDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <i :class="[getFileIcon(currentPreviewFile), getFileColor(currentPreviewFile)]" class="text-2xl"></i>
                        <h3 class="text-lg font-bold truncate text-gray-900">{{ currentPreviewFile?.name }}</h3>
                    </div>
                    <button @click="showPreviewDialog = false" class="p-2 hover:bg-gray-100 rounded-lg text-gray-700">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-auto p-6">
                    <div v-if="previewLoading" class="flex items-center justify-center h-full">
                        <i class="bi bi-arrow-clockwise text-6xl text-gray-500 animate-spin"></i>
                    </div>
                    <div v-else-if="isImageFile(currentPreviewFile)" class="flex flex-col items-center justify-center h-full gap-4">
                        <!-- ÂõæÁâáÊéßÂà∂Ê†è -->
                        <div class="flex items-center gap-3 bg-gray-100 px-4 py-2 rounded-lg">
                            <button @click="zoomOut" class="p-2 hover:bg-gray-200 rounded-lg" title="Áº©Â∞è">
                                <i class="bi bi-zoom-out text-lg"></i>
                            </button>
                            <span class="text-sm font-medium min-w-16 text-center">{{ Math.round(imageZoom * 100) }}%</span>
                            <button @click="zoomIn" class="p-2 hover:bg-gray-200 rounded-lg" title="ÊîæÂ§ß">
                                <i class="bi bi-zoom-in text-lg"></i>
                            </button>
                            <div class="w-px h-6 bg-gray-300"></div>
                            <button @click="resetZoom" class="p-2 hover:bg-gray-200 rounded-lg" title="ÈáçÁΩÆ">
                                <i class="bi bi-arrow-clockwise text-lg"></i>
                            </button>
                            <button @click="rotateImage" class="p-2 hover:bg-gray-200 rounded-lg" title="ÊóãËΩ¨">
                                <i class="bi bi-arrow-repeat text-lg"></i>
                            </button>
                            <div class="w-px h-6 bg-gray-300"></div>
                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" v-model="imageCompression" class="rounded" @change="toggleCompression">
                                <span>ÂéãÁº©ÊòæÁ§∫</span>
                            </label>
                        </div>
                        <!-- ÂõæÁâáÊòæÁ§∫Âå∫Âüü -->
                        <div class="flex-1 overflow-auto flex items-center justify-center">
                            <img
                                :src="displayImageUrl"
                                :alt="currentPreviewFile?.name"
                                :style="{
                                    transform: `scale(${imageZoom}) rotate(${imageRotation}deg)`,
                                    transition: 'transform 0.3s ease',
                                    maxWidth: imageCompression ? '800px' : 'none'
                                }"
                                class="rounded-lg">
                        </div>
                    </div>
                    <div v-else-if="isMarkdownFile(currentPreviewFile)" class="h-full overflow-auto">
                        <div class="markdown-content p-6 bg-white" v-html="renderedMarkdown"></div>
                    </div>
                    <div v-else-if="isCodeFile(currentPreviewFile)" class="h-full overflow-auto">
                        <pre class="h-full m-0"><code :class="getCodeLanguage(currentPreviewFile)" class="block h-full" v-html="highlightedCode"></code></pre>
                    </div>
                    <div v-else-if="isTextFile(currentPreviewFile)" class="h-full">
                        <pre class="text-sm bg-gray-50 p-4 rounded-lg overflow-auto h-full font-mono text-gray-900">{{ previewContent }}</pre>
                    </div>
                    <div v-else-if="isPdfFile(currentPreviewFile)" class="h-full">
                        <iframe :src="previewUrl" class="w-full h-full rounded-lg border-0"></iframe>
                    </div>
                    <div v-else-if="isVideoFile(currentPreviewFile)" class="flex items-center justify-center h-full bg-black rounded-lg">
                        <video
                            :src="previewUrl"
                            controls
                            autoplay
                            class="max-w-full max-h-full rounded-lg"
                            style="max-height: calc(90vh - 200px);">
                            ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ
                        </video>
                    </div>
                    <div v-else-if="isAudioFile(currentPreviewFile)" class="flex flex-col items-center justify-center h-full">
                        <div class="w-full max-w-2xl bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-8 shadow-lg">
                            <div class="flex items-center justify-center mb-6">
                                <div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-xl">
                                    <i class="bi bi-music-note-beamed text-white text-6xl"></i>
                                </div>
                            </div>
                            <h3 class="text-xl font-bold text-center text-gray-900 mb-6">{{ currentPreviewFile?.name }}</h3>
                            <audio
                                :src="previewUrl"
                                controls
                                autoplay
                                class="w-full rounded-lg shadow-md">
                                ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ
                            </audio>
                            <div class="mt-4 text-center text-sm text-gray-600">
                                <p>Êñá‰ª∂Â§ßÂ∞è: {{ formatFileSize(currentPreviewFile?.size) }}</p>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="isOfficeFile(currentPreviewFile)" class="flex flex-col items-center justify-center h-full p-8">
                        <div class="w-full max-w-3xl bg-white rounded-2xl p-8 shadow-lg border-2 border-gray-200">
                            <div class="flex items-center justify-center mb-6">
                                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center shadow-xl">
                                    <i class="bi bi-file-earmark-word text-white text-4xl"></i>
                                </div>
                            </div>
                            <h3 class="text-2xl font-bold text-center text-gray-900 mb-4">{{ currentPreviewFile?.name }}</h3>
                            <div class="text-center text-gray-600 mb-6">
                                <p class="text-lg">OfficeÊñáÊ°£Âú®Á∫øÈ¢ÑËßà</p>
                                <p class="text-sm mt-2">Êñá‰ª∂Â§ßÂ∞è: {{ formatFileSize(currentPreviewFile?.size) }}</p>
                            </div>
                            <div class="space-y-4">
                                <button
                                    @click="previewOfficeWithGoogleDocs"
                                    class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-4 rounded-lg transition-all flex items-center justify-center gap-3 shadow-md">
                                    <i class="bi bi-google text-2xl"></i>
                                    <span class="text-lg">‰ΩøÁî® Google Docs Viewer È¢ÑËßà</span>
                                </button>
                                <button
                                    @click="previewOfficeWithMicrosoft"
                                    class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white px-6 py-4 rounded-lg transition-all flex items-center justify-center gap-3 shadow-md">
                                    <i class="bi bi-microsoft text-2xl"></i>
                                    <span class="text-lg">‰ΩøÁî® Microsoft Office Online È¢ÑËßà</span>
                                </button>
                                <button
                                    @click="downloadFile(currentPreviewFile)"
                                    class="w-full bg-gray-100 hover:bg-gray-200 text-gray-900 px-6 py-4 rounded-lg transition-all flex items-center justify-center gap-3">
                                    <i class="bi bi-download text-xl"></i>
                                    <span>‰∏ãËΩΩÂà∞Êú¨Âú∞Êü•Áúã</span>
                                </button>
                            </div>
                            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <i class="bi bi-info-circle mr-2"></i>
                                    ÊèêÁ§∫ÔºöÂú®Á∫øÈ¢ÑËßàÈúÄË¶ÅÊñá‰ª∂URLÂèØÂÖ¨ÁΩëËÆøÈóÆ„ÄÇÂ¶ÇÊûúÈ¢ÑËßàÂ§±Ë¥•ÔºåËØ∑‰∏ãËΩΩÂà∞Êú¨Âú∞Êü•Áúã„ÄÇ
                                </p>
                            </div>
                        </div>
                    </div>
                    <div v-else class="flex flex-col items-center justify-center h-full text-gray-600">
                        <i class="bi bi-file-earmark-x text-6xl mb-4"></i>
                        <p>Ê≠§Êñá‰ª∂Á±ªÂûã‰∏çÊîØÊåÅÈ¢ÑËßà</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast ÈÄöÁü•ÔºàÂè≥‰∏äËßíÔºâ -->
        <div class="fixed top-6 right-6 z-50 space-y-3 w-96">
            <div
                v-for="toast in toasts"
                :key="toast.id"
                class="bg-white rounded-xl shadow-2xl border p-4 flex items-start gap-3 animate-slide-in-right"
                :class="{
                    'border-green-200': toast.type === 'success',
                    'border-red-200': toast.type === 'error',
                    'border-blue-200': toast.type === 'info'
                }">
                <div
                    class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                    :class="{
                        'bg-green-100': toast.type === 'success',
                        'bg-red-100': toast.type === 'error',
                        'bg-blue-100': toast.type === 'info'
                    }">
                    <i
                        class="text-xl"
                        :class="{
                            'bi-check-circle text-green-600': toast.type === 'success',
                            'bi-x-circle text-red-600': toast.type === 'error',
                            'bi-info-circle text-blue-600': toast.type === 'info'
                        }"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h4
                        class="font-semibold text-sm mb-1"
                        :class="{
                            'text-green-900': toast.type === 'success',
                            'text-red-900': toast.type === 'error',
                            'text-blue-900': toast.type === 'info'
                        }">
                        {{ toast.type === 'success' ? '‰∏ä‰º†ÊàêÂäü' : toast.type === 'error' ? '‰∏ãËΩΩÂ§±Ë¥•' : 'ÈÄöÁü•' }}
                    </h4>
                    <p class="text-xs text-gray-700">{{ toast.message }}</p>
                </div>
                <button @click="removeToast(toast.id)" class="text-gray-600 hover:text-gray-800">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- ‰∏ä‰º†ËøõÂ∫¶Âç°ÁâáÔºàÂè≥‰∏ãËßíÔºâ -->
        <div v-if="uploadProgress.show" class="fixed bottom-6 right-6 z-50 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 p-4 animate-slide-up">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-sm text-gray-900">Êñá‰ª∂‰∏ä‰º†‰∏≠...</h4>
                <button @click="uploadProgress.show = false" class="text-gray-600 hover:text-gray-800">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            <div class="flex items-center gap-3">
                <i class="bi bi-file-earmark text-blue-600 text-2xl flex-shrink-0"></i>
                <div class="flex-1">
                    <p class="text-sm text-gray-900 truncate mb-1">{{ uploadProgress.fileName }}</p>
                    <div class="flex items-center gap-2 text-xs text-gray-700">
                        <span>{{ formatFileSize(uploadProgress.loaded) }} / {{ formatFileSize(uploadProgress.total) }}</span>
                        <span class="text-blue-600 font-semibold">{{ uploadProgress.percent }}%</span>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div
                        class="bg-blue-600 h-full transition-all duration-300 rounded-full"
                        :style="{ width: uploadProgress.percent + '%' }"></div>
                </div>
            </div>
            <p class="text-xs text-gray-700 mt-2">Ââ©‰ΩôÊó∂Èó¥: Á∫¶ {{ uploadProgress.remainingTime }}</p>
        </div>

        <!-- Âè≥ÈîÆËèúÂçï -->
        <div v-if="contextMenu.show"
             class="context-menu"
             :style="{ left: contextMenu.x + 'px', top: contextMenu.y + 'px' }"
             @click.stop>
            <template v-if="contextMenu.type === 'breadcrumb'">
                <div class="context-menu-item" @click="openInNewTab(contextMenu.path)">
                    <i class="bi bi-box-arrow-up-right"></i>
                    <span>Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ</span>
                </div>
                <div class="context-menu-item" @click="copyPath(contextMenu.path)">
                    <i class="bi bi-clipboard"></i>
                    <span>Â§çÂà∂Ë∑ØÂæÑ</span>
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" @click="refreshFolder">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Âà∑Êñ∞</span>
                </div>
            </template>
            <template v-if="contextMenu.type === 'file'">
                <div v-if="!contextMenu.file.isFolder && canPreview(contextMenu.file)"
                     class="context-menu-item" @click="previewFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-eye"></i>
                    <span>È¢ÑËßà</span>
                </div>
                <div v-if="contextMenu.file.isFolder"
                     class="context-menu-item" @click="handleFileClick(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-folder-open"></i>
                    <span>ÊâìÂºÄ</span>
                </div>
                <div v-if="contextMenu.file.isFolder"
                     class="context-menu-item" @click="calculateFolderSize(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-hdd"></i>
                    <span>ËÆ°ÁÆóÂ§ßÂ∞è</span>
                </div>
                <div v-if="!contextMenu.file.isFolder"
                     class="context-menu-item" @click="downloadFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-download"></i>
                    <span>‰∏ãËΩΩ</span>
                </div>
                <div v-if="!contextMenu.file.isFolder"
                     class="context-menu-item" @click="shareFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-share"></i>
                    <span>ÁîüÊàêÂàÜ‰∫´ÈìæÊé•</span>
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" @click="renameFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-pencil"></i>
                    <span>ÈáçÂëΩÂêç</span>
                </div>
                <div class="context-menu-item" @click="copyFileName(contextMenu.file)">
                    <i class="bi bi-clipboard"></i>
                    <span>Â§çÂà∂ÂêçÁß∞</span>
                </div>
                <div class="context-menu-item" @click="copyFilePath(contextMenu.file)">
                    <i class="bi bi-link-45deg"></i>
                    <span>Â§çÂà∂ÂÆåÊï¥Ë∑ØÂæÑ</span>
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item danger" @click="deleteFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-trash"></i>
                    <span>Âà†Èô§</span>
                </div>
            </template>
        </div>
    </div>

    <!-- Vue 3 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.4.21/vue.global.prod.min.js"></script>
    <!-- Axios -->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.7/axios.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    viewMode: 'list', // 'list' Êàñ 'grid'
                    buckets: [],
                    currentBucket: '',
                    currentPath: '',
                    files: [],
                    selectedFile: null,
                    loading: false,
                    searchKeyword: '',
                    showUploadDialog: false,
                    showCreateFolderDialog: false,
                    uploadFiles: [],
                    folderName: '',
                    toasts: [],
                    toastId: 0,
                    showPreviewDialog: false,
                    currentPreviewFile: null,
                    previewLoading: false,
                    previewUrl: '',
                    previewContent: '',
                    renderedMarkdown: '',
                    highlightedCode: '',
                    showDeleteDialog: false,
                    fileToDelete: null,
                    showRenameDialog: false,
                    fileToRename: null,
                    newFileName: '',
                    showAdvancedFilters: false,
                    filters: {
                        fileType: '',
                        startDate: '',
                        endDate: ''
                    },
                    sortBy: 'time',
                    sortOrder: 'desc',
                    currentPage: 1,
                    pageSize: 50,
                    uploadProgress: {
                        show: false,
                        fileName: '',
                        loaded: 0,
                        total: 0,
                        percent: 0,
                        remainingTime: 'ËÆ°ÁÆó‰∏≠...'
                    },
                    contextMenu: {
                        show: false,
                        type: '', // 'breadcrumb' or 'file'
                        x: 0,
                        y: 0,
                        path: '',
                        file: null
                    },
                    showShareDialog: false,
                    fileToShare: null,
                    shareExpiration: '3600', // ÈªòËÆ§1Â∞èÊó∂
                    shareUrl: '',
                    shareExpiresAt: null,
                    // ÂõæÁâáÊéßÂà∂
                    imageZoom: 1,
                    imageRotation: 0,
                    imageCompression: false,
                    compressedImageUrl: '',
                    // Êñá‰ª∂Â§πÂ§ßÂ∞èÁºìÂ≠ò
                    folderSizes: {}
                }
            },
            computed: {
                pathParts() {
                    if (!this.currentPath) return [];
                    return this.currentPath.split('/').filter(part => part);
                },
                filteredFiles() {
                    let result = [...this.files];

                    // ÂÖ≥ÈîÆËØçÊêúÁ¥¢
                    if (this.searchKeyword.trim()) {
                        const keyword = this.searchKeyword.toLowerCase();
                        result = result.filter(f => f.name.toLowerCase().includes(keyword));
                    }

                    // Êñá‰ª∂Á±ªÂûãÁ≠õÈÄâ
                    if (this.filters.fileType) {
                        result = result.filter(f => this.matchesFileType(f, this.filters.fileType));
                    }

                    // Êó∂Èó¥ËåÉÂõ¥Á≠õÈÄâ
                    if (this.filters.startDate || this.filters.endDate) {
                        result = result.filter(f => this.matchesDateRange(f));
                    }

                    return result;
                },
                hasActiveFilters() {
                    return !!(this.filters.fileType || this.filters.startDate || this.filters.endDate);
                },
                activeFilterCount() {
                    let count = 0;
                    if (this.filters.fileType) count++;
                    if (this.filters.startDate || this.filters.endDate) count++;
                    return count;
                },
                sortedFiles() {
                    let result = [...this.filteredFiles];
                    result.sort((a, b) => {
                        if (a.isFolder && !b.isFolder) return -1;
                        if (!a.isFolder && b.isFolder) return 1;
                        let compareResult = 0;
                        if (this.sortBy === 'name') {
                            compareResult = a.name.localeCompare(b.name, 'zh-CN');
                        } else if (this.sortBy === 'size') {
                            compareResult = (a.size || 0) - (b.size || 0);
                        } else if (this.sortBy === 'time') {
                            const timeA = new Date(a.lastModified).getTime() || 0;
                            const timeB = new Date(b.lastModified).getTime() || 0;
                            compareResult = timeA - timeB;
                        }
                        return this.sortOrder === 'asc' ? compareResult : -compareResult;
                    });
                    return result;
                },
                displayFiles() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.sortedFiles.slice(start, end);
                },
                totalPages() {
                    return Math.ceil(this.sortedFiles.length / this.pageSize);
                },
                displayImageUrl() {
                    return this.imageCompression && this.compressedImageUrl ? this.compressedImageUrl : this.previewUrl;
                }
            },
            mounted() {
                this.loadBuckets();
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÂè≥ÈîÆËèúÂçï
                document.addEventListener('click', () => {
                    this.contextMenu.show = false;
                });
                // ÂàùÂßãÂåñÂõæÁâáÊáíÂä†ËΩΩ
                this.initLazyLoading();
            },
            methods: {
                goToConfig() {
                    window.location.href = 'config.html';
                },
                async loadBuckets() {
                    try {
                        const response = await axios.get('/api/storage/buckets');
                        if (response.data.success) {
                            this.buckets = response.data.data;
                            if (this.buckets.length > 0 && !this.currentBucket) {
                                const savedBucket = localStorage.getItem('currentBucket');
                                if (savedBucket && this.buckets.includes(savedBucket)) {
                                    this.currentBucket = savedBucket;
                                } else {
                                    this.currentBucket = this.buckets[0];
                                }
                                await this.loadFiles();
                            }
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩÂ≠òÂÇ®Ê°∂Â§±Ë¥•:', error);
                        this.showToast('error', 'Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®');
                    }
                },
                async selectBucket(bucket) {
                    this.currentBucket = bucket;
                    localStorage.setItem('currentBucket', bucket);
                    this.currentPath = '';
                    await this.loadFiles();
                },
                async loadFiles() {
                    if (!this.currentBucket) return;
                    this.loading = true;
                    try {
                        const requestData = {
                            bucketName: this.currentBucket,
                            prefix: this.currentPath,
                            delimiter: '/',
                            pageSize: 1000
                        };
                        const response = await axios.post('/api/storage/files/list', requestData);
                        if (response.data.success) {
                            const data = response.data.data;
                            const newFiles = [];
                            if (data.folders && data.folders.length > 0) {
                                data.folders.forEach(folder => {
                                    newFiles.push({
                                        key: folder.key,
                                        name: folder.name,
                                        isFolder: true,
                                        size: 0,
                                        lastModified: new Date()
                                    });
                                });
                            }
                            if (data.files && data.files.length > 0) {
                                data.files.forEach(file => {
                                    let fileName = file.key;
                                    if (this.currentPath && fileName.startsWith(this.currentPath)) {
                                        fileName = fileName.substring(this.currentPath.length);
                                    }
                                    if (fileName.startsWith('/')) {
                                        fileName = fileName.substring(1);
                                    }
                                    if (fileName && !fileName.includes('/')) {
                                        newFiles.push({
                                            key: file.key,
                                            name: fileName,
                                            size: file.size || 0,
                                            lastModified: file.lastModified,
                                            storageClass: file.storageClass,
                                            isFolder: false
                                        });
                                    }
                                });
                            }
                            this.files = newFiles;
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
                        this.showToast('error', 'Êó†Ê≥ïÂä†ËΩΩÊñá‰ª∂ÂàóË°®');
                    } finally {
                        this.loading = false;
                    }
                },
                navigateToPath(path) {
                    this.currentPath = path;
                    this.loadFiles();
                },
                getPathUpTo(index) {
                    const parts = this.currentPath.split('/').filter(part => part);
                    if (index >= 0 && index < parts.length) {
                        return parts.slice(0, index + 1).join('/') + '/';
                    }
                    return '';
                },
                handleFileClick(file) {
                    if (file.isFolder) {
                        this.navigateToPath(file.key);
                    } else {
                        this.selectedFile = file;
                    }
                },
                handleSearch() {
                    // Search handled by computed property
                },
                handleFileSelect(event) {
                    this.uploadFiles = Array.from(event.target.files);
                },
                async doUploadFiles() {
                    if (this.uploadFiles.length === 0) return;
                    this.showUploadDialog = false;

                    for (let file of this.uploadFiles) {
                        try {
                            this.uploadProgress.show = true;
                            this.uploadProgress.fileName = file.name;
                            this.uploadProgress.loaded = 0;
                            this.uploadProgress.total = file.size;
                            this.uploadProgress.percent = 0;

                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('bucketName', this.currentBucket);
                            if (this.currentPath) {
                                formData.append('objectKey', this.currentPath + file.name);
                            }

                            const response = await axios.post('/api/storage/upload', formData, {
                                headers: { 'Content-Type': 'multipart/form-data' },
                                onUploadProgress: (progressEvent) => {
                                    this.uploadProgress.loaded = progressEvent.loaded;
                                    this.uploadProgress.total = progressEvent.total;
                                    this.uploadProgress.percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                                }
                            });

                            if (response.data.success) {
                                this.showToast('success', `Êñá‰ª∂ "${file.name}" Â∑≤ÊàêÂäü‰∏ä‰º†„ÄÇ`);
                            } else {
                                this.showToast('error', `Êñá‰ª∂ "${file.name}" ‰∏ä‰º†Â§±Ë¥•„ÄÇ`);
                            }
                        } catch (error) {
                            console.error(`‰∏ä‰º†Â§±Ë¥•: ${file.name}`, error);
                            this.showToast('error', `Êñá‰ª∂ "${file.name}" ‰∏ä‰º†Â§±Ë¥•„ÄÇ`);
                        }
                    }

                    this.uploadProgress.show = false;
                    this.uploadFiles = [];
                    await this.loadFiles();
                },
                async downloadFile(file) {
                    try {
                        const url = `/api/storage/download?bucketName=${encodeURIComponent(this.currentBucket)}&objectKey=${encodeURIComponent(file.key)}`;
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = file.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch (error) {
                        console.error('‰∏ãËΩΩÊñá‰ª∂Â§±Ë¥•:', error);
                        this.showToast('error', '‰∏ãËΩΩÊñá‰ª∂Â§±Ë¥•');
                    }
                },
                deleteFile(file) {
                    this.fileToDelete = file;
                    this.showDeleteDialog = true;
                },
                async confirmDelete() {
                    if (!this.fileToDelete) return;
                    this.showDeleteDialog = false;
                    const fileToDelete = this.fileToDelete;
                    this.fileToDelete = null;

                    try {
                        const response = await axios.delete('/api/storage/files', {
                            params: {
                                bucketName: this.currentBucket,
                                objectKey: fileToDelete.key
                            }
                        });
                        if (response.data.success) {
                            this.showToast('success', 'Êñá‰ª∂Â∑≤Âà†Èô§');
                            await this.loadFiles();
                        } else {
                            this.showToast('error', 'Âà†Èô§Â§±Ë¥•: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('Âà†Èô§Êñá‰ª∂Â§±Ë¥•:', error);
                        this.showToast('error', 'Âà†Èô§Êñá‰ª∂Â§±Ë¥•');
                    }
                },
                renameFile(file) {
                    this.fileToRename = file;
                    this.newFileName = file.name;
                    this.showRenameDialog = true;
                },
                async confirmRename() {
                    if (!this.fileToRename || !this.newFileName.trim()) return;

                    const oldName = this.fileToRename.name;
                    const newName = this.newFileName.trim();

                    if (oldName === newName) {
                        this.showToast('error', 'Êñ∞ÂêçÁß∞‰∏éÂéüÂêçÁß∞Áõ∏Âêå');
                        return;
                    }

                    this.showRenameDialog = false;
                    const fileToRename = this.fileToRename;
                    this.fileToRename = null;
                    this.newFileName = '';

                    try {
                        const oldKey = fileToRename.key;
                        let newKey;

                        if (fileToRename.isFolder) {
                            const parentPath = this.currentPath;
                            newKey = parentPath + newName + '/';
                        } else {
                            const lastSlash = oldKey.lastIndexOf('/');
                            const parentPath = lastSlash >= 0 ? oldKey.substring(0, lastSlash + 1) : '';
                            newKey = parentPath + newName;
                        }

                        const response = await axios.put('/api/storage/files/rename', null, {
                            params: {
                                bucketName: this.currentBucket,
                                oldKey: oldKey,
                                newKey: newKey
                            }
                        });

                        if (response.data.success) {
                            this.showToast('success', 'ÈáçÂëΩÂêçÊàêÂäü');
                            await this.loadFiles();
                        } else {
                            this.showToast('error', 'ÈáçÂëΩÂêçÂ§±Ë¥•: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('ÈáçÂëΩÂêçÊñá‰ª∂Â§±Ë¥•:', error);
                        this.showToast('error', 'ÈáçÂëΩÂêçÂ§±Ë¥•: ' + (error.response?.data?.message || error.message));
                    }
                },
                async createFolder() {
                    if (!this.folderName.trim()) {
                        this.showToast('error', 'ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞');
                        return;
                    }
                    try {
                        const folderPath = this.currentPath + this.folderName.trim() + '/';
                        const response = await axios.post('/api/storage/folder', null, {
                            params: {
                                bucketName: this.currentBucket,
                                folderPath: folderPath
                            }
                        });
                        if (response.data.success) {
                            this.showToast('success', 'Êñá‰ª∂Â§πÂ∑≤ÂàõÂª∫');
                            this.showCreateFolderDialog = false;
                            this.folderName = '';
                            await this.loadFiles();
                        } else {
                            this.showToast('error', 'ÂàõÂª∫Â§±Ë¥•: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                        this.showToast('error', 'ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•');
                    }
                },
                getFileIcon(file) {
                    if (file.isFolder) {
                        return 'bi-folder-fill';
                    }
                    const ext = file.name.split('.').pop().toLowerCase();
                    const iconMap = {
                        'png': 'bi-file-image', 'jpg': 'bi-file-image', 'jpeg': 'bi-file-image', 'gif': 'bi-file-image', 'svg': 'bi-file-image',
                        'pdf': 'bi-file-pdf',
                        'doc': 'bi-file-word', 'docx': 'bi-file-word',
                        'xls': 'bi-file-excel', 'xlsx': 'bi-file-excel',
                        'ppt': 'bi-file-ppt', 'pptx': 'bi-file-ppt',
                        'zip': 'bi-file-zip', 'rar': 'bi-file-zip', '7z': 'bi-file-zip',
                        'mp4': 'bi-file-play', 'avi': 'bi-file-play', 'mov': 'bi-file-play',
                        'mp3': 'bi-file-music', 'wav': 'bi-file-music', 'flac': 'bi-file-music',
                        'txt': 'bi-file-text', 'md': 'bi-file-text',
                        'js': 'bi-file-code', 'ts': 'bi-file-code', 'html': 'bi-file-code',
                        'css': 'bi-file-code', 'json': 'bi-file-code', 'xml': 'bi-file-code'
                    };
                    return iconMap[ext] || 'bi-file-earmark';
                },
                getFileColor(file) {
                    if (file.isFolder) {
                        return 'text-blue-500';
                    }
                    const ext = file.name.split('.').pop().toLowerCase();
                    const colorMap = {
                        'png': 'text-green-500', 'jpg': 'text-green-500', 'jpeg': 'text-green-500', 'gif': 'text-green-500',
                        'pdf': 'text-red-500',
                        'doc': 'text-blue-500', 'docx': 'text-blue-500',
                        'xls': 'text-green-500', 'xlsx': 'text-green-500',
                        'zip': 'text-yellow-500', 'rar': 'text-yellow-500',
                        'mp4': 'text-purple-500', 'avi': 'text-purple-500',
                        'mp3': 'text-pink-500'
                    };
                    return colorMap[ext] || 'text-gray-500';
                },
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                formatDate(date) {
                    if (!date) return '';
                    try {
                        return new Date(date).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch {
                        return '';
                    }
                },
                showToast(type, message) {
                    const id = this.toastId++;
                    this.toasts.push({ id, type, message });
                    setTimeout(() => {
                        this.removeToast(id);
                    }, 5000);
                },
                removeToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index > -1) {
                        this.toasts.splice(index, 1);
                    }
                },
                canPreview(file) {
                    if (!file || file.isFolder) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const previewableTypes = [
                        'png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg',
                        'txt', 'md', 'json', 'xml', 'csv', 'log',
                        'js', 'ts', 'jsx', 'tsx', 'vue', 'html', 'css', 'scss', 'less',
                        'java', 'py', 'go', 'rs', 'c', 'cpp', 'h', 'hpp',
                        'yml', 'yaml', 'toml', 'ini', 'conf', 'properties',
                        'sh', 'bat', 'ps1', 'sql', 'pdf',
                        'mp4', 'webm', 'ogg', 'avi', 'mov', 'wmv', 'flv', 'mkv',
                        'mp3', 'wav', 'flac', 'aac', 'm4a', 'wma',
                        'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'
                    ];
                    return previewableTypes.includes(ext);
                },
                isImageFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'].includes(ext);
                },
                isTextFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const textTypes = [
                        'txt', 'md', 'json', 'xml', 'csv', 'log',
                        'js', 'ts', 'jsx', 'tsx', 'vue', 'html', 'css', 'scss', 'less',
                        'java', 'py', 'go', 'rs', 'c', 'cpp', 'h', 'hpp',
                        'yml', 'yaml', 'toml', 'ini', 'conf', 'properties',
                        'sh', 'bat', 'ps1', 'sql'
                    ];
                    return textTypes.includes(ext);
                },
                isPdfFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ext === 'pdf';
                },
                isVideoFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['mp4', 'webm', 'ogg', 'avi', 'mov', 'wmv', 'flv', 'mkv'].includes(ext);
                },
                isAudioFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg', 'wma'].includes(ext);
                },
                isMarkdownFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ext === 'md';
                },
                isCodeFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const codeTypes = [
                        'js', 'ts', 'jsx', 'tsx', 'vue', 'html', 'css', 'scss', 'less',
                        'java', 'py', 'go', 'rs', 'c', 'cpp', 'h', 'hpp',
                        'json', 'xml', 'yml', 'yaml', 'toml', 'ini', 'conf', 'properties',
                        'sh', 'bat', 'ps1', 'sql'
                    ];
                    return codeTypes.includes(ext);
                },
                isOfficeFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(ext);
                },
                getCodeLanguage(file) {
                    if (!file) return 'language-plaintext';
                    const ext = file.name.split('.').pop().toLowerCase();
                    const languageMap = {
                        'js': 'language-javascript',
                        'ts': 'language-typescript',
                        'jsx': 'language-javascript',
                        'tsx': 'language-typescript',
                        'vue': 'language-javascript',
                        'html': 'language-html',
                        'css': 'language-css',
                        'scss': 'language-scss',
                        'less': 'language-less',
                        'java': 'language-java',
                        'py': 'language-python',
                        'go': 'language-go',
                        'rs': 'language-rust',
                        'c': 'language-c',
                        'cpp': 'language-cpp',
                        'h': 'language-c',
                        'hpp': 'language-cpp',
                        'json': 'language-json',
                        'xml': 'language-xml',
                        'yml': 'language-yaml',
                        'yaml': 'language-yaml',
                        'toml': 'language-toml',
                        'ini': 'language-ini',
                        'conf': 'language-plaintext',
                        'properties': 'language-properties',
                        'sh': 'language-bash',
                        'bat': 'language-batch',
                        'ps1': 'language-powershell',
                        'sql': 'language-sql'
                    };
                    return languageMap[ext] || 'language-plaintext';
                },
                async previewFile(file) {
                    this.currentPreviewFile = file;
                    this.showPreviewDialog = true;
                    this.previewLoading = true;
                    this.previewUrl = '';
                    this.previewContent = '';
                    this.renderedMarkdown = '';
                    this.highlightedCode = '';
                    // ÈáçÁΩÆÂõæÁâáÊéßÂà∂Áä∂ÊÄÅ
                    this.imageZoom = 1;
                    this.imageRotation = 0;
                    this.imageCompression = false;
                    this.compressedImageUrl = '';

                    try {
                        const url = `/api/storage/download?bucketName=${encodeURIComponent(this.currentBucket)}&objectKey=${encodeURIComponent(file.key)}`;

                        if (this.isImageFile(file) || this.isPdfFile(file) || this.isVideoFile(file) || this.isAudioFile(file)) {
                            this.previewUrl = url;
                        } else if (this.isMarkdownFile(file)) {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•');
                            const markdownText = await response.text();

                            // Configure marked for better rendering
                            marked.setOptions({
                                breaks: true,
                                gfm: true,
                                highlight: function(code, lang) {
                                    if (lang && hljs.getLanguage(lang)) {
                                        try {
                                            return hljs.highlight(code, { language: lang }).value;
                                        } catch (e) {
                                            console.error('Highlight error:', e);
                                        }
                                    }
                                    return hljs.highlightAuto(code).value;
                                }
                            });

                            this.renderedMarkdown = marked.parse(markdownText);
                        } else if (this.isCodeFile(file)) {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•');
                            const codeText = await response.text();

                            // Get language from file extension
                            const ext = file.name.split('.').pop().toLowerCase();
                            const langMap = {
                                'js': 'javascript', 'ts': 'typescript', 'jsx': 'javascript', 'tsx': 'typescript',
                                'py': 'python', 'java': 'java', 'go': 'go', 'rs': 'rust',
                                'c': 'c', 'cpp': 'cpp', 'h': 'c', 'hpp': 'cpp',
                                'html': 'html', 'css': 'css', 'scss': 'scss', 'less': 'less',
                                'json': 'json', 'xml': 'xml', 'yml': 'yaml', 'yaml': 'yaml',
                                'sh': 'bash', 'bat': 'batch', 'ps1': 'powershell', 'sql': 'sql'
                            };

                            const lang = langMap[ext] || 'plaintext';

                            if (hljs.getLanguage(lang)) {
                                this.highlightedCode = hljs.highlight(codeText, { language: lang }).value;
                            } else {
                                this.highlightedCode = hljs.highlightAuto(codeText).value;
                            }
                        } else if (this.isTextFile(file)) {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•');
                            this.previewContent = await response.text();
                        }
                    } catch (error) {
                        console.error('È¢ÑËßàÊñá‰ª∂Â§±Ë¥•:', error);
                        this.showToast('error', 'È¢ÑËßàÊñá‰ª∂Â§±Ë¥•');
                        this.showPreviewDialog = false;
                    } finally {
                        this.previewLoading = false;
                    }
                },
                matchesFileType(file, type) {
                    if (type === 'folder') return file.isFolder;
                    if (file.isFolder) return false;

                    const ext = file.name.split('.').pop().toLowerCase();
                    const typeMap = {
                        'image': ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'],
                        'video': ['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv', 'webm'],
                        'audio': ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg', 'wma'],
                        'document': ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'md'],
                        'archive': ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'],
                        'code': ['js', 'ts', 'jsx', 'tsx', 'vue', 'html', 'css', 'scss', 'less', 'java', 'py', 'go', 'rs', 'c', 'cpp', 'h', 'hpp', 'json', 'xml', 'yml', 'yaml']
                    };

                    if (type === 'other') {
                        for (let key in typeMap) {
                            if (typeMap[key].includes(ext)) return false;
                        }
                        return true;
                    }

                    return typeMap[type] && typeMap[type].includes(ext);
                },
                matchesDateRange(file) {
                    if (!file.lastModified) return false;

                    const fileDate = new Date(file.lastModified);
                    fileDate.setHours(0, 0, 0, 0);

                    if (this.filters.startDate) {
                        const startDate = new Date(this.filters.startDate);
                        startDate.setHours(0, 0, 0, 0);
                        if (fileDate < startDate) return false;
                    }

                    if (this.filters.endDate) {
                        const endDate = new Date(this.filters.endDate);
                        endDate.setHours(23, 59, 59, 999);
                        if (fileDate > endDate) return false;
                    }

                    return true;
                },
                clearFilters() {
                    this.filters.fileType = '';
                    this.filters.startDate = '';
                    this.filters.endDate = '';
                },
                setQuickDateRange(range) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    this.filters.endDate = today.toISOString().split('T')[0];

                    switch (range) {
                        case 'today':
                            this.filters.startDate = today.toISOString().split('T')[0];
                            break;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            this.filters.startDate = weekAgo.toISOString().split('T')[0];
                            break;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setDate(monthAgo.getDate() - 30);
                            this.filters.startDate = monthAgo.toISOString().split('T')[0];
                            break;
                        case 'year':
                            const yearAgo = new Date(today);
                            yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                            this.filters.startDate = yearAgo.toISOString().split('T')[0];
                            break;
                    }
                },
                // Âè≥ÈîÆËèúÂçïÊñπÊ≥ï
                showContextMenu(event, type, data) {
                    event.preventDefault();
                    this.contextMenu.show = true;
                    this.contextMenu.type = type;
                    this.contextMenu.x = event.clientX;
                    this.contextMenu.y = event.clientY;

                    if (type === 'breadcrumb') {
                        this.contextMenu.path = data;
                    } else if (type === 'file') {
                        this.contextMenu.file = data;
                    }
                },
                hideContextMenu() {
                    this.contextMenu.show = false;
                },
                openInNewTab(path) {
                    const url = new URL(window.location.href);
                    url.searchParams.set('bucket', this.currentBucket);
                    url.searchParams.set('path', path);
                    window.open(url.toString(), '_blank');
                    this.hideContextMenu();
                },
                copyPath(path) {
                    const fullPath = this.currentBucket + '/' + path;
                    navigator.clipboard.writeText(fullPath).then(() => {
                        this.showToast('success', 'Ë∑ØÂæÑÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    }).catch(() => {
                        this.showToast('error', 'Â§çÂà∂Â§±Ë¥•');
                    });
                    this.hideContextMenu();
                },
                copyFileName(file) {
                    navigator.clipboard.writeText(file.name).then(() => {
                        this.showToast('success', 'Êñá‰ª∂ÂêçÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    }).catch(() => {
                        this.showToast('error', 'Â§çÂà∂Â§±Ë¥•');
                    });
                    this.hideContextMenu();
                },
                copyFilePath(file) {
                    const fullPath = this.currentBucket + '/' + file.key;
                    navigator.clipboard.writeText(fullPath).then(() => {
                        this.showToast('success', 'ÂÆåÊï¥Ë∑ØÂæÑÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    }).catch(() => {
                        this.showToast('error', 'Â§çÂà∂Â§±Ë¥•');
                    });
                    this.hideContextMenu();
                },
                refreshFolder() {
                    this.loadFiles();
                    this.showToast('info', 'Â∑≤Âà∑Êñ∞');
                    this.hideContextMenu();
                },
                // ÂàÜ‰∫´Êñá‰ª∂
                shareFile(file) {
                    this.fileToShare = file;
                    this.shareUrl = '';
                    this.shareExpiresAt = null;
                    this.shareExpiration = '3600'; // ÈªòËÆ§1Â∞èÊó∂
                    this.showShareDialog = true;
                },
                async generateShareUrl() {
                    try {
                        const response = await axios.get('/api/storage/share', {
                            params: {
                                bucketName: this.currentBucket,
                                objectKey: this.fileToShare.key,
                                expirationSeconds: parseInt(this.shareExpiration)
                            }
                        });

                        if (response.data.success) {
                            this.shareUrl = response.data.data.url;
                            this.shareExpiresAt = response.data.data.expiresAt;
                            this.showToast('success', 'ÂàÜ‰∫´ÈìæÊé•Â∑≤ÁîüÊàê');
                        } else {
                            this.showToast('error', 'ÁîüÊàêÂ§±Ë¥•: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('ÁîüÊàêÂàÜ‰∫´ÈìæÊé•Â§±Ë¥•:', error);
                        this.showToast('error', 'ÁîüÊàêÂàÜ‰∫´ÈìæÊé•Â§±Ë¥•');
                    }
                },
                copyShareUrl() {
                    navigator.clipboard.writeText(this.shareUrl).then(() => {
                        this.showToast('success', 'ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    }).catch(() => {
                        this.showToast('error', 'Â§çÂà∂Â§±Ë¥•');
                    });
                },
                formatExpirationTime(timestamp) {
                    if (!timestamp) return '';
                    return new Date(timestamp).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                // ÂõæÁâáÊéßÂà∂ÊñπÊ≥ï
                zoomIn() {
                    this.imageZoom = Math.min(this.imageZoom + 0.25, 3);
                },
                zoomOut() {
                    this.imageZoom = Math.max(this.imageZoom - 0.25, 0.25);
                },
                resetZoom() {
                    this.imageZoom = 1;
                    this.imageRotation = 0;
                },
                rotateImage() {
                    this.imageRotation = (this.imageRotation + 90) % 360;
                },
                async toggleCompression() {
                    if (!this.imageCompression) {
                        this.compressedImageUrl = '';
                        return;
                    }

                    // ‰ΩøÁî®CanvasÂéãÁº©ÂõæÁâá
                    try {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.src = this.previewUrl;

                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = reject;
                        });

                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // ËÆ°ÁÆóÂéãÁº©ÂêéÁöÑÂ∞∫ÂØ∏ÔºàÊúÄÂ§ß800pxÔºâ
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // ÂéãÁº©Ë¥®Èáè0.7
                        this.compressedImageUrl = canvas.toDataURL('image/jpeg', 0.7);
                    } catch (error) {
                        console.error('ÂõæÁâáÂéãÁº©Â§±Ë¥•:', error);
                        this.showToast('error', 'ÂõæÁâáÂéãÁº©Â§±Ë¥•');
                        this.imageCompression = false;
                    }
                },
                // ËÆ°ÁÆóÊñá‰ª∂Â§πÂ§ßÂ∞è
                async calculateFolderSize(folder) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊúâÁºìÂ≠òÔºåÁõ¥Êé•ËøîÂõû
                    if (this.folderSizes[folder.key]) {
                        this.showToast('info', `Êñá‰ª∂Â§πÂ§ßÂ∞è: ${this.formatFileSize(this.folderSizes[folder.key])}`);
                        return;
                    }

                    try {
                        this.showToast('info', 'Ê≠£Âú®ËÆ°ÁÆóÊñá‰ª∂Â§πÂ§ßÂ∞è...');

                        const response = await axios.get('/api/storage/folder/size', {
                            params: {
                                bucketName: this.currentBucket,
                                folderPath: folder.key
                            }
                        });

                        if (response.data.success) {
                            const totalSize = response.data.data.totalSize;
                            // ÁºìÂ≠òÁªìÊûú
                            this.folderSizes[folder.key] = totalSize;
                            this.showToast('success', `Êñá‰ª∂Â§πÂ§ßÂ∞è: ${this.formatFileSize(totalSize)}`);
                        } else {
                            this.showToast('error', 'ËÆ°ÁÆóÂ§±Ë¥•: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('ËÆ°ÁÆóÊñá‰ª∂Â§πÂ§ßÂ∞èÂ§±Ë¥•:', error);
                        this.showToast('error', 'ËÆ°ÁÆóÊñá‰ª∂Â§πÂ§ßÂ∞èÂ§±Ë¥•');
                    }
                },
                // ÂàùÂßãÂåñÂõæÁâáÊáíÂä†ËΩΩ
                initLazyLoading() {
                    // ÂàõÂª∫Intersection Observer
                    this.imageObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.dataset.src;
                                if (src) {
                                    img.src = src;
                                    img.removeAttribute('data-src');
                                    this.imageObserver.unobserve(img);
                                }
                            }
                        });
                    }, {
                        rootMargin: '50px' // ÊèêÂâç50pxÂºÄÂßãÂä†ËΩΩ
                    });
                },
                // ‰ΩøÁî®Google Docs ViewerÈ¢ÑËßàOfficeÊñáÊ°£
                async previewOfficeWithGoogleDocs() {
                    try {
                        // Ëé∑ÂèñÊñá‰ª∂ÁöÑÈ¢ÑÁ≠æÂêçURL
                        const response = await axios.get('/api/storage/share', {
                            params: {
                                bucketName: this.currentBucket,
                                objectKey: this.currentPreviewFile.key,
                                expirationSeconds: 3600 // 1Â∞èÊó∂
                            }
                        });

                        if (response.data.success) {
                            const fileUrl = encodeURIComponent(response.data.data.url);
                            const googleViewerUrl = `https://docs.google.com/viewer?url=${fileUrl}&embedded=true`;
                            window.open(googleViewerUrl, '_blank');
                        } else {
                            this.showToast('error', 'Ëé∑ÂèñÊñá‰ª∂URLÂ§±Ë¥•: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('‰ΩøÁî®Google DocsÈ¢ÑËßàÂ§±Ë¥•:', error);
                        this.showToast('error', 'È¢ÑËßàÂ§±Ë¥•ÔºåËØ∑Á°Æ‰øùÊñá‰ª∂URLÂèØÂÖ¨ÁΩëËÆøÈóÆ');
                    }
                },
                // ‰ΩøÁî®Microsoft Office OnlineÈ¢ÑËßàOfficeÊñáÊ°£
                async previewOfficeWithMicrosoft() {
                    try {
                        // Ëé∑ÂèñÊñá‰ª∂ÁöÑÈ¢ÑÁ≠æÂêçURL
                        const response = await axios.get('/api/storage/share', {
                            params: {
                                bucketName: this.currentBucket,
                                objectKey: this.currentPreviewFile.key,
                                expirationSeconds: 3600 // 1Â∞èÊó∂
                            }
                        });

                        if (response.data.success) {
                            const fileUrl = encodeURIComponent(response.data.data.url);
                            const ext = this.currentPreviewFile.name.split('.').pop().toLowerCase();

                            // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÈÄâÊã©‰∏çÂêåÁöÑÈ¢ÑËßàÊúçÂä°
                            let officeViewerUrl;
                            if (['doc', 'docx'].includes(ext)) {
                                officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${fileUrl}`;
                            } else if (['xls', 'xlsx'].includes(ext)) {
                                officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${fileUrl}`;
                            } else if (['ppt', 'pptx'].includes(ext)) {
                                officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${fileUrl}`;
                            }

                            window.open(officeViewerUrl, '_blank');
                        } else {
                            this.showToast('error', 'Ëé∑ÂèñÊñá‰ª∂URLÂ§±Ë¥•: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('‰ΩøÁî®Microsoft Office OnlineÈ¢ÑËßàÂ§±Ë¥•:', error);
                        this.showToast('error', 'È¢ÑËßàÂ§±Ë¥•ÔºåËØ∑Á°Æ‰øùÊñá‰ª∂URLÂèØÂÖ¨ÁΩëËÆøÈóÆ');
                    }
                },
                // Ê∏ÖÈô§Service WorkerÁºìÂ≠ò
                async clearServiceWorkerCache() {
                    if (!('serviceWorker' in navigator)) {
                        this.showToast('error', 'ÊµèËßàÂô®‰∏çÊîØÊåÅService Worker');
                        return;
                    }

                    try {
                        const registration = await navigator.serviceWorker.ready;

                        // ÂêëService WorkerÂèëÈÄÅÊ∏ÖÈô§ÁºìÂ≠òÊ∂àÊÅØ
                        const messageChannel = new MessageChannel();

                        const promise = new Promise((resolve, reject) => {
                            messageChannel.port1.onmessage = (event) => {
                                if (event.data.success) {
                                    resolve();
                                } else {
                                    reject(new Error('Ê∏ÖÈô§Â§±Ë¥•'));
                                }
                            };

                            setTimeout(() => reject(new Error('Ê∏ÖÈô§Ë∂ÖÊó∂')), 5000);
                        });

                        registration.active.postMessage(
                            { type: 'CLEAR_CACHE' },
                            [messageChannel.port2]
                        );

                        await promise;
                        this.showToast('success', 'ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§ÔºåÈ°µÈù¢Â∞ÜÂà∑Êñ∞');

                        // Âª∂ËøüÂà∑Êñ∞È°µÈù¢
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } catch (error) {
                        console.error('Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•:', error);
                        this.showToast('error', 'Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•: ' + error.message);
                    }
                }
            }
        }).mount('#app');

        // Service Worker Ê≥®ÂÜå
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('[App] Service Worker Ê≥®ÂÜåÊàêÂäü:', registration.scope);

                        // Ê£ÄÊü•Êõ¥Êñ∞
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('[App] ÂèëÁé∞Êñ∞ÁöÑ Service Worker');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[App] Êñ∞ÁöÑ Service Worker Â∑≤ÂÆâË£ÖÔºåÂà∑Êñ∞È°µÈù¢‰ª•ÊøÄÊ¥ª');
                                    // ÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫ÊèêÁ§∫ËÆ©Áî®Êà∑Âà∑Êñ∞È°µÈù¢
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('[App] Service Worker Ê≥®ÂÜåÂ§±Ë¥•:', error);
                    });
            });
        } else {
            console.log('[App] ÊµèËßàÂô®‰∏çÊîØÊåÅ Service Worker');
        }
    </script>
</body>
</html>
