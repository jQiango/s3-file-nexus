<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 文件管理器</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="manifest" href="/manifest.json">

    <!-- Bootstrap Icons - jsDelivr (主CDN) with Unpkg fallback -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
          onerror="this.onerror=null;this.href='https://unpkg.com/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css'">

    <!-- Highlight.js - Code Syntax Highlighting (jsDelivr) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>

    <!-- Marked.js - Markdown Parser (jsDelivr) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <!-- SheetJS - Excel/CSV Parser (jsDelivr) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- PDF.js - PDF Viewer (使用更稳定的版本) -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
    <script>
        // 配置 PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
        }
    </script>

    <!-- Tailwind CSS (Official CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] {
            display: none !important;
        }

        /* 自定义下拉框样式 */
        select {
            background-image: none;
        }

        /* 浏览器原生下拉菜单圆角 */
        select option {
            border-radius: 8px;
            padding: 8px 12px;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out;
        }

        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }

        @keyframes slide-down {
            from {
                transform: translateY(-8px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .animate-slide-down {
            animation: slide-down 0.15s ease-out;
        }

        /* 工具栏滑入动画 */
        .toolbar-slide-enter-active,
        .toolbar-slide-leave-active {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toolbar-slide-enter-from {
            transform: translate(-50%, 20px);
            opacity: 0;
        }
        .toolbar-slide-leave-to {
            transform: translate(-50%, 20px);
            opacity: 0;
        }

        /* 文件卡片悬停效果 */
        .file-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .file-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
        }
        .file-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: inherit;
            pointer-events: none;
        }
        .file-card:hover::before {
            opacity: 1;
        }

        /* Markdown渲染样式 */
        .markdown-content {
            line-height: 1.8;
            color: #333;
        }
        .markdown-content h1 {
            font-size: 2em;
            font-weight: bold;
            margin: 1em 0 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 2px solid #e5e7eb;
        }
        .markdown-content h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0.8em 0 0.4em;
            padding-bottom: 0.2em;
            border-bottom: 1px solid #e5e7eb;
        }
        .markdown-content h3 {
            font-size: 1.25em;
            font-weight: bold;
            margin: 0.6em 0 0.3em;
        }
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            font-weight: bold;
            margin: 0.5em 0 0.2em;
        }
        .markdown-content p {
            margin: 1em 0;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        .markdown-content li {
            margin: 0.5em 0;
        }
        .markdown-content blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            border-left: 4px solid #3b82f6;
            background: #f3f4f6;
            color: #6b7280;
        }
        .markdown-content code {
            padding: 0.2em 0.4em;
            background: #f3f4f6;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        .markdown-content pre {
            margin: 1em 0;
            padding: 1em;
            background: #1f2937;
            border-radius: 6px;
            overflow-x: auto;
        }
        .markdown-content pre code {
            padding: 0;
            background: transparent;
            color: #e5e7eb;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5em 1em;
            text-align: left;
        }
        .markdown-content th {
            background: #f3f4f6;
            font-weight: bold;
        }
        .markdown-content a {
            color: #3b82f6;
            text-decoration: none;
        }
        .markdown-content a:hover {
            text-decoration: underline;
        }
        .markdown-content img {
            max-width: 100%;
            height: auto;
        }
        .markdown-content hr {
            margin: 2em 0;
            border: none;
            border-top: 1px solid #e5e7eb;
        }

        /* Excel/CSV 表格样式 */
        .excel-table-container {
            overflow: auto;
            max-height: 600px;
        }
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .excel-table th {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            font-weight: 600;
            text-align: left;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #374151;
        }
        .excel-table td {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            color: #1f2937;
        }
        .excel-table tr:hover {
            background: #f9fafb;
        }
        .excel-table tr:nth-child(even) {
            background: #fafafa;
        }
        .excel-table tr:nth-child(even):hover {
            background: #f3f4f6;
        }

        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 6px;
            min-width: 200px;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        .context-menu-item {
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }
        .context-menu-item i {
            font-size: 16px;
            width: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .context-menu-item:hover {
            background: #f3f4f6;
            color: #1f2937;
            transform: translateX(2px);
        }
        .context-menu-item.danger {
            color: #dc2626;
        }
        .context-menu-item.danger:hover {
            background: #fee2e2;
            color: #b91c1c;
        }
        .context-menu-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 6px 8px;
        }

        /* 复选框简单优化 */
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        /* 统一按钮动效系统 */
        button, .button {
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 禁用按钮样式 */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }

        /* 主要按钮（带渐变背景）hover效果 - 向上浮动 */
        button:not(:disabled)[class*="bg-gradient"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        button:not(:disabled)[class*="bg-gradient"]:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* 次要按钮（无背景/灰色背景）hover效果 - 轻微缩放 */
        button:not(:disabled):not([class*="bg-gradient"]):hover {
            transform: scale(1.02);
        }

        button:not(:disabled):not([class*="bg-gradient"]):active {
            transform: scale(0.98);
        }

        /* 卡片式可点击元素通用hover效果 */
        button[class*="rounded-xl"]:not(:disabled):hover,
        .file-card:not(.selected):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        button[class*="rounded-xl"]:not(:disabled):active,
        .file-card:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        /* 工具栏小按钮hover效果 */
        [class*="toolbar"] button:not(:disabled):hover,
        [class*="flex"] > button:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* 关闭按钮（X）hover效果 - 旋转 */
        button:hover .bi-x-lg,
        button:hover .bi-x {
            transform: rotate(90deg);
            transition: transform 0.2s ease;
        }

        /* 刷新按钮旋转效果 */
        button:hover .bi-arrow-clockwise,
        button:hover .bi-arrow-repeat {
            animation: spin 0.6s linear;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 删除按钮抖动效果 */
        button:hover .bi-trash,
        button:hover .bi-trash3 {
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px) rotate(-5deg); }
            75% { transform: translateX(2px) rotate(5deg); }
        }

        /* 下载按钮向下移动效果 */
        button:hover .bi-download {
            animation: download 0.6s ease;
        }

        @keyframes download {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(3px); }
        }

        /* 文件夹按钮弹跳效果 */
        button:hover .bi-folder-fill,
        button:hover .bi-folder2-open {
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* 复选框打勾动画 */
        button:hover .bi-check-lg,
        button:hover .bi-check-circle-fill {
            animation: checkPulse 0.3s ease;
        }

        @keyframes checkPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* 上传按钮向上移动效果 */
        button:hover .bi-upload,
        button:hover .bi-cloud-upload {
            animation: upload 0.6s ease;
        }

        @keyframes upload {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* 箭头按钮移动效果 */
        button:hover .bi-chevron-right {
            animation: slideRight 0.3s ease;
        }

        button:hover .bi-chevron-left {
            animation: slideLeft 0.3s ease;
        }

        @keyframes slideRight {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(3px); }
        }

        @keyframes slideLeft {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-3px); }
        }

        /* 眼睛预览按钮闪烁效果 */
        button:hover .bi-eye,
        button:hover .bi-eye-fill {
            animation: blink 0.5s ease;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 选中的文件卡片样式 */
        .file-card.selected {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .file-card.selected::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            padding: 2px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            animation: borderPulse 2s ease-in-out infinite;
        }
        @keyframes borderPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="h-full overflow-hidden bg-gray-50">
    <div id="app" v-cloak class="flex h-screen w-full">
        <!-- 左侧边栏 -->
        <aside :style="{ width: sidebarWidth + 'px' }" class="bg-white border-r border-gray-200 flex flex-col h-full flex-shrink-0 shadow-sm relative">
            <!-- Logo区域 -->
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center gap-3 mb-1">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shrink-0 shadow-md">
                        <i class="bi bi-cloud-fill text-white text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h1 class="font-bold text-lg text-gray-900">S3文件管理器</h1>
                        <p class="text-xs text-gray-500">对象存储服务</p>
                    </div>
                </div>
            </div>

            <!-- 存储桶分类列表 -->
            <div class="flex-1 overflow-y-auto scrollbar-thin p-4 bg-gray-50/50">
                <div class="mb-4">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">存储桶</p>
                    <div class="space-y-1.5">
                        <button
                            v-for="bucket in buckets"
                            :key="bucket"
                            @click="selectBucket(bucket)"
                            :class="currentBucket === bucket ? 'bg-blue-50 text-blue-700 border-blue-200 shadow-sm' : 'text-gray-700 hover:bg-white hover:border-gray-300 border-transparent'"
                            class="w-full px-4 py-3 rounded-lg text-left flex items-center gap-3 transition-all duration-200 text-sm font-medium group border">
                            <i class="bi bi-database text-lg transition-transform group-hover:scale-110" :class="currentBucket === bucket ? 'text-blue-600' : 'text-gray-400'"></i>
                            <span class="truncate flex-1">{{ bucket }}</span>
                            <i v-if="currentBucket === bucket" class="bi bi-check-circle-fill text-sm text-blue-600"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 刷新按钮 -->
            <div class="p-3 border-t border-gray-200 bg-white space-y-2">
                <button
                    @click="loadFiles"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white h-10 rounded-lg font-medium transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg text-sm">
                    <i class="bi bi-arrow-clockwise"></i>
                    刷新列表
                </button>
            </div>

            <!-- 拖拽调整宽度的把手 -->
            <div
                @mousedown="startResizeSidebar"
                class="absolute top-0 right-0 w-1 h-full cursor-ew-resize hover:bg-blue-300 transition-colors group">
                <div class="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-16 bg-gray-300 rounded-full group-hover:bg-blue-400 group-hover:shadow-md transition-all duration-200"></div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="flex-1 flex flex-col min-w-0 bg-gradient-to-br from-gray-50 via-white to-blue-50/30">
            <!-- ========== 第一层：面包屑导航 ========== -->
            <div class="px-8 py-3 border-b border-gray-200 bg-gray-50/50">
                <nav class="flex items-center gap-1.5">
                    <button
                        @click="navigateToPath('')"
                        @contextmenu="showContextMenu($event, 'breadcrumb', '')"
                        class="flex items-center gap-2 px-2.5 h-7 rounded-lg hover:bg-white text-gray-700 hover:text-blue-600 transition-all group">
                        <i class="bi bi-house-fill text-sm group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs font-medium">根目录</span>
                    </button>
                    <template v-for="(part, index) in pathParts" :key="index">
                        <i class="bi bi-chevron-right text-gray-400 text-xs"></i>
                        <button
                            @click="navigateToPath(getPathUpTo(index))"
                            @contextmenu="showContextMenu($event, 'breadcrumb', getPathUpTo(index))"
                            class="px-2.5 h-7 rounded-lg hover:bg-white font-medium transition-all text-xs"
                            :class="index === pathParts.length - 1 ? 'text-blue-600 bg-blue-50' : 'text-gray-700 hover:text-blue-600'">
                            {{ part }}
                        </button>
                    </template>
                </nav>
            </div>

            <!-- ========== 第二层：工具栏（搜索 + 筛选 + 视图 + 操作） ========== -->
            <div class="px-8 py-3 border-b border-gray-200 bg-white">
                <div class="flex items-center justify-between gap-4">
                    <!-- 左侧：搜索框 + 内容筛选 + 批量操作 + 视图切换 -->
                    <div class="flex items-center gap-2.5 flex-1">
                        <!-- 搜索框 -->
                        <div class="relative flex-1 max-w-md">
                            <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                            <input
                                type="text"
                                v-model="searchKeyword"
                                @keyup.enter="handleSearch"
                                placeholder="搜索文件名或前缀..."
                                class="w-full h-8 pl-10 pr-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 placeholder-gray-400 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400/20 outline-none transition-all">
                        </div>

                        <!-- 高级筛选按钮 -->
                        <button
                            @click="showAdvancedFilters = !showAdvancedFilters"
                            :class="showAdvancedFilters || hasActiveFilters ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-700 hover:bg-gray-100'"
                            class="flex items-center gap-1.5 px-3 h-8 rounded-lg border transition-all relative">
                            <i class="bi bi-funnel text-sm"></i>
                            <span class="text-xs font-medium">筛选</span>
                            <span v-if="hasActiveFilters" class="absolute -top-1 -right-1 w-4 h-4 bg-blue-600 text-white text-xs rounded-full flex items-center justify-center font-semibold">{{ activeFilterCount }}</span>
                        </button>


                        <!-- 批量操作 -->
                        <div class="flex items-center gap-1 bg-gray-50 rounded-lg p-0.5 border border-gray-200">
                            <button
                                @click="batchMode = !batchMode"
                                :class="batchMode ? 'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-sm' : 'text-gray-700 hover:bg-white'"
                                class="flex items-center gap-1.5 px-2.5 h-8 rounded-md transition-all">
                                <i :class="batchMode ? 'bi-check-square-fill' : 'bi-ui-checks'" class="text-sm"></i>
                                <span class="text-xs font-medium">批量</span>
                                <span v-if="batchMode && selectedFilesCount > 0" class="px-1.5 py-0.5 bg-white/30 text-white text-xs rounded font-bold">{{ selectedFilesCount }}</span>
                            </button>
                        </div>

                        <div class="w-px h-5 bg-gray-300"></div>

                        <!-- 视图切换 -->
                        <div class="flex items-center gap-1 bg-gray-50 rounded-lg p-0.5 border border-gray-200">
                            <button
                                @click="viewMode = 'list'"
                                :class="viewMode === 'list' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:bg-white'"
                                class="flex items-center gap-1.5 px-2.5 h-8 rounded-md transition-all"
                                title="列表视图">
                                <i class="bi bi-list-ul text-sm"></i>
                                <span class="text-xs font-medium">列表</span>
                            </button>
                            <button
                                @click="viewMode = 'grid'"
                                :class="viewMode === 'grid' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:bg-white'"
                                class="flex items-center gap-1.5 px-2.5 h-8 rounded-md transition-all"
                                title="网格视图">
                                <i class="bi bi-grid-3x3-gap text-sm"></i>
                                <span class="text-xs font-medium">网格</span>
                            </button>
                        </div>
                    </div>

                    <!-- 右侧：主操作 + 系统功能 -->
                    <div class="flex items-center gap-2.5">
                        <button
                            @click="showUploadDialog = true"
                            class="flex items-center gap-1.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 h-8 rounded-lg transition-all shadow-sm hover:shadow-md text-xs font-medium">
                            <i class="bi bi-cloud-upload text-sm"></i>
                            <span>上传</span>
                        </button>
                        <button
                            @click="showCreateFolderDialog = true"
                            class="flex items-center gap-1.5 bg-white hover:bg-gray-50 text-gray-700 px-3 h-8 rounded-lg transition-all border border-gray-200 hover:border-gray-300 text-xs font-medium">
                            <i class="bi bi-folder-plus text-sm"></i>
                            <span>新建</span>
                        </button>

                        <div class="w-px h-5 bg-gray-300"></div>

                        <button
                            @click="goToConfig"
                            class="flex items-center gap-1.5 px-3 h-8 text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg transition-all"
                            title="配置存储后端">
                            <i class="bi bi-gear-fill text-sm"></i>
                            <span class="text-xs font-medium">配置</span>
                        </button>
                        <button
                            @click="clearAllCaches"
                            class="flex items-center gap-1.5 px-3 h-8 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all"
                            title="清除所有缓存并刷新">
                            <i class="bi bi-trash-fill text-sm"></i>
                            <span class="text-xs font-medium">清除缓存</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 高级筛选区域（保持原样） -->
            <div v-if="showAdvancedFilters || hasActiveFilters" class="px-8 bg-white border-b border-gray-200">
                <!-- 已启用筛选标签 -->
                <div v-if="hasActiveFilters && !showAdvancedFilters" class="flex items-center gap-2 mt-2">
                    <span class="text-xs text-gray-500">已启用:</span>
                    <div class="flex items-center gap-2">
                        <span v-if="filters.fileType" class="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded-md">
                            文件类型
                            <button @click="filters.fileType = ''" class="hover:bg-blue-100 rounded">
                                <i class="bi bi-x text-sm"></i>
                            </button>
                        </span>
                        <span v-if="filters.startDate || filters.endDate" class="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded-md">
                            时间范围
                            <button @click="filters.startDate = ''; filters.endDate = ''" class="hover:bg-blue-100 rounded">
                                <i class="bi bi-x text-sm"></i>
                            </button>
                        </span>
                        <button
                            @click="clearFilters"
                            class="text-xs text-gray-500 hover:text-gray-700 underline">
                            清除全部
                        </button>
                    </div>
                </div>

                <!-- 筛选面板 -->
                <div v-if="showAdvancedFilters" class="mt-3 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                            <i class="bi bi-sliders text-blue-600 text-sm"></i>
                            高级筛选
                        </h3>
                        <button v-if="hasActiveFilters" @click="clearFilters" class="flex items-center gap-1.5 px-3 h-8 text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg transition-all">
                            <i class="bi bi-arrow-counterclockwise text-sm"></i>
                            <span class="text-xs font-medium">重置</span>
                        </button>
                    </div>

                    <!-- 筛选说明 -->
                    <div class="mb-3 p-2 bg-amber-50 border border-amber-200 rounded-lg">
                        <div class="flex items-start gap-2">
                            <i class="bi bi-info-circle text-amber-600 text-sm mt-0.5"></i>
                            <p class="text-xs text-amber-800 leading-relaxed">
                                <span class="font-semibold">提示：</span>筛选仅对当前页的文件有效。由于使用后端分页，筛选不会跨页搜索。
                            </p>
                        </div>
                    </div>

                    <!-- 文件类型和日期筛选 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <!-- 文件类型筛选 -->
                        <div>
                            <label class="flex items-center gap-1.5 text-xs font-medium text-gray-700 mb-1.5">
                                <i class="bi bi-file-earmark text-gray-500"></i>
                                文件类型
                            </label>
                            <div class="relative" v-click-outside="() => fileTypeDropdownOpen = false">
                                <i class="bi bi-funnel absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none z-10"></i>
                                <button
                                    @click="fileTypeDropdownOpen = !fileTypeDropdownOpen"
                                    type="button"
                                    class="w-full h-9 pl-9 pr-9 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-900 hover:bg-white hover:border-blue-300 hover:shadow-sm focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400/20 outline-none transition-all text-left flex items-center justify-between">
                                    <span>{{ getFileTypeLabel(filters.fileType) }}</span>
                                </button>
                                <i :class="fileTypeDropdownOpen ? 'bi-chevron-up' : 'bi-chevron-down'" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none z-10 transition-transform"></i>

                                <!-- 下拉菜单 -->
                                <div v-if="fileTypeDropdownOpen" class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden animate-slide-down">
                                    <div class="max-h-64 overflow-y-auto scrollbar-thin py-1">
                                        <button
                                            v-for="option in fileTypeOptions"
                                            :key="option.value"
                                            @click="selectFileType(option.value)"
                                            type="button"
                                            :class="filters.fileType === option.value ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-50'"
                                            class="w-full px-3 py-2 text-xs text-left transition-colors flex items-center gap-2">
                                            <span>{{ option.emoji }}</span>
                                            <span class="font-medium">{{ option.label }}</span>
                                            <i v-if="filters.fileType === option.value" class="bi bi-check2 ml-auto text-blue-600 font-bold"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 时间范围 - 开始 -->
                        <div>
                            <label class="flex items-center gap-1.5 text-xs font-medium text-gray-700 mb-1.5">
                                <i class="bi bi-calendar-check text-gray-500"></i>
                                开始日期
                            </label>
                            <div class="relative" v-click-outside="() => startDatePickerOpen = false">
                                <i class="bi bi-calendar-event absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none z-10"></i>
                                <button
                                    @click="startDatePickerOpen = !startDatePickerOpen"
                                    type="button"
                                    class="w-full h-9 pl-9 pr-9 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-900 hover:bg-white hover:border-blue-300 hover:shadow-sm focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400/20 outline-none transition-all text-left flex items-center justify-between">
                                    <span :class="filters.startDate ? 'text-gray-900' : 'text-gray-400'">
                                        {{ formatDisplayDate(filters.startDate) || '请选择日期' }}
                                    </span>
                                </button>
                                <i :class="startDatePickerOpen ? 'bi-chevron-up' : 'bi-chevron-down'" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none z-10 transition-transform"></i>

                                <!-- 日历面板 -->
                                <div v-if="startDatePickerOpen" class="absolute z-50 w-72 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden animate-slide-down">
                                    <div class="p-3">
                                        <!-- 年月选择 -->
                                        <div class="flex items-center justify-between mb-3">
                                            <button @click="changeStartMonth(-1)" type="button" class="p-1 hover:bg-gray-100 rounded transition-colors">
                                                <i class="bi bi-chevron-left text-gray-600"></i>
                                            </button>
                                            <div class="flex items-center gap-2">
                                                <select v-model="startCalendarYear" class="px-2 py-1 text-xs border border-gray-200 rounded-lg focus:border-blue-400 focus:ring-1 focus:ring-blue-400 outline-none">
                                                    <option v-for="y in yearOptions" :key="y" :value="y">{{ y }}年</option>
                                                </select>
                                                <select v-model="startCalendarMonth" class="px-2 py-1 text-xs border border-gray-200 rounded-lg focus:border-blue-400 focus:ring-1 focus:ring-blue-400 outline-none">
                                                    <option v-for="m in 12" :key="m" :value="m">{{ m }}月</option>
                                                </select>
                                            </div>
                                            <button @click="changeStartMonth(1)" type="button" class="p-1 hover:bg-gray-100 rounded transition-colors">
                                                <i class="bi bi-chevron-right text-gray-600"></i>
                                            </button>
                                        </div>
                                        <!-- 星期标题 -->
                                        <div class="grid grid-cols-7 gap-1 mb-2">
                                            <div v-for="day in ['日','一','二','三','四','五','六']" :key="day" class="text-center text-xs font-medium text-gray-500 py-1">
                                                {{ day }}
                                            </div>
                                        </div>
                                        <!-- 日期网格 -->
                                        <div class="grid grid-cols-7 gap-1">
                                            <button
                                                v-for="date in getStartCalendarDates()"
                                                :key="date.key"
                                                @click="selectStartDate(date)"
                                                type="button"
                                                :disabled="!date.isCurrentMonth"
                                                :class="[
                                                    'py-1.5 text-xs rounded-lg transition-all',
                                                    date.isToday ? 'font-bold' : '',
                                                    date.isSelected ? 'bg-blue-500 text-white' : date.isCurrentMonth ? 'hover:bg-blue-50 text-gray-900' : 'text-gray-300 cursor-not-allowed'
                                                ]">
                                                {{ date.day }}
                                            </button>
                                        </div>
                                        <!-- 底部按钮 -->
                                        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
                                            <button @click="setStartToday" type="button" class="flex-1 px-3 py-1.5 text-xs text-blue-600 hover:bg-blue-50 rounded-lg transition-all">
                                                今天
                                            </button>
                                            <button v-if="filters.startDate" @click="clearStartDate" type="button" class="flex-1 px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
                                                清除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 时间范围 - 结束 -->
                        <div>
                            <label class="flex items-center gap-1.5 text-xs font-medium text-gray-700 mb-1.5">
                                <i class="bi bi-calendar-x text-gray-500"></i>
                                结束日期
                            </label>
                            <div class="relative" v-click-outside="() => endDatePickerOpen = false">
                                <i class="bi bi-calendar-event absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none z-10"></i>
                                <button
                                    @click="endDatePickerOpen = !endDatePickerOpen"
                                    type="button"
                                    class="w-full h-9 pl-9 pr-9 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-900 hover:bg-white hover:border-blue-300 hover:shadow-sm focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-400/20 outline-none transition-all text-left flex items-center justify-between">
                                    <span :class="filters.endDate ? 'text-gray-900' : 'text-gray-400'">
                                        {{ formatDisplayDate(filters.endDate) || '请选择日期' }}
                                    </span>
                                </button>
                                <i :class="endDatePickerOpen ? 'bi-chevron-up' : 'bi-chevron-down'" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none z-10 transition-transform"></i>

                                <!-- 日历面板 -->
                                <div v-if="endDatePickerOpen" class="absolute z-50 w-72 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden animate-slide-down">
                                    <div class="p-3">
                                        <!-- 年月选择 -->
                                        <div class="flex items-center justify-between mb-3">
                                            <button @click="changeEndMonth(-1)" type="button" class="p-1 hover:bg-gray-100 rounded transition-colors">
                                                <i class="bi bi-chevron-left text-gray-600"></i>
                                            </button>
                                            <div class="flex items-center gap-2">
                                                <select v-model="endCalendarYear" class="px-2 py-1 text-xs border border-gray-200 rounded-lg focus:border-blue-400 focus:ring-1 focus:ring-blue-400 outline-none">
                                                    <option v-for="y in yearOptions" :key="y" :value="y">{{ y }}年</option>
                                                </select>
                                                <select v-model="endCalendarMonth" class="px-2 py-1 text-xs border border-gray-200 rounded-lg focus:border-blue-400 focus:ring-1 focus:ring-blue-400 outline-none">
                                                    <option v-for="m in 12" :key="m" :value="m">{{ m }}月</option>
                                                </select>
                                            </div>
                                            <button @click="changeEndMonth(1)" type="button" class="p-1 hover:bg-gray-100 rounded transition-colors">
                                                <i class="bi bi-chevron-right text-gray-600"></i>
                                            </button>
                                        </div>
                                        <!-- 星期标题 -->
                                        <div class="grid grid-cols-7 gap-1 mb-2">
                                            <div v-for="day in ['日','一','二','三','四','五','六']" :key="day" class="text-center text-xs font-medium text-gray-500 py-1">
                                                {{ day }}
                                            </div>
                                        </div>
                                        <!-- 日期网格 -->
                                        <div class="grid grid-cols-7 gap-1">
                                            <button
                                                v-for="date in getEndCalendarDates()"
                                                :key="date.key"
                                                @click="selectEndDate(date)"
                                                type="button"
                                                :disabled="!date.isCurrentMonth"
                                                :class="[
                                                    'py-1.5 text-xs rounded-lg transition-all',
                                                    date.isToday ? 'font-bold' : '',
                                                    date.isSelected ? 'bg-blue-500 text-white' : date.isCurrentMonth ? 'hover:bg-blue-50 text-gray-900' : 'text-gray-300 cursor-not-allowed'
                                                ]">
                                                {{ date.day }}
                                            </button>
                                        </div>
                                        <!-- 底部按钮 -->
                                        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
                                            <button @click="setEndToday" type="button" class="flex-1 px-3 py-1.5 text-xs text-blue-600 hover:bg-blue-50 rounded-lg transition-all">
                                                今天
                                            </button>
                                            <button v-if="filters.endDate" @click="clearEndDate" type="button" class="flex-1 px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
                                                清除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 快捷时间选择 -->
                    <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
                        <span class="text-xs font-medium text-gray-600">
                            <i class="bi bi-lightning text-gray-400 mr-1"></i>
                            快速选择:
                        </span>
                        <div class="flex items-center gap-2">
                            <button
                                @click="setQuickDateRange('today')"
                                class="px-3 h-8 text-xs font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-all">
                                今天
                            </button>
                            <button
                                @click="setQuickDateRange('week')"
                                class="px-3 h-8 text-xs font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-all">
                                最近7天
                            </button>
                            <button
                                @click="setQuickDateRange('month')"
                                class="px-3 h-8 text-xs font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-all">
                                最近30天
                            </button>
                            <button
                                @click="setQuickDateRange('year')"
                                class="px-3 h-8 text-xs font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-all">
                                最近一年
                            </button>
                        </div>
                    </div>

                    <!-- 保存/加载筛选条件 -->
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs font-medium text-gray-600">
                                <i class="bi bi-bookmark text-gray-400 mr-1"></i>
                                已保存的筛选条件:
                            </span>
                        </div>
                        <!-- 已保存的筛选条件列表 -->
                        <div v-if="savedFilters.length > 0" class="space-y-2 mb-3">
                            <div v-for="(saved, index) in savedFilters" :key="index"
                                 class="flex items-center justify-between p-2 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-all">
                                <button @click="loadSavedFilter(saved)"
                                        class="flex-1 text-left text-xs font-medium text-gray-700 hover:text-blue-600 transition-colors">
                                    {{ saved.name }}
                                </button>
                                <button @click="deleteSavedFilter(index)"
                                        class="p-1 hover:bg-red-100 rounded text-gray-400 hover:text-red-600 transition-colors">
                                    <i class="bi bi-x text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div v-else class="text-xs text-gray-400 text-center py-2 mb-3">
                            暂无保存的筛选条件
                        </div>
                        <!-- 保存当前筛选条件 -->
                        <button v-if="hasActiveFilters"
                                @click="showSaveFilterDialog = true"
                                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-all">
                            <i class="bi bi-bookmark-plus"></i>
                            保存当前筛选条件
                        </button>
                    </div>
                </div>
            </div>

            <!-- 文件列表区域 -->
            <div class="flex-1 overflow-y-auto scrollbar-thin p-8">
                <!-- 批量操作工具栏 -->
                <div v-if="batchMode && !loading && displayFiles.length > 0" class="mb-4 flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-xl">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-info-circle text-purple-600 text-lg"></i>
                        <span class="text-sm text-purple-900">
                            <span class="font-semibold">批量操作模式</span>
                            <span class="text-purple-700">- 点击文件选择，支持 Ctrl/Shift 多选</span>
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button
                            @click="selectAll"
                            class="flex items-center gap-1.5 px-3 py-1.5 bg-white hover:bg-purple-50 text-purple-700 text-sm font-medium rounded-lg transition-all duration-200 border border-purple-200">
                            <i class="bi bi-check-all"></i>
                            全选
                        </button>
                        <button
                            @click="clearSelection"
                            class="flex items-center gap-1.5 px-3 py-1.5 bg-white hover:bg-purple-50 text-purple-700 text-sm font-medium rounded-lg transition-all duration-200 border border-purple-200">
                            <i class="bi bi-x-circle"></i>
                            清空
                        </button>
                        <button
                            @click="invertSelection"
                            class="flex items-center gap-1.5 px-3 py-1.5 bg-white hover:bg-purple-50 text-purple-700 text-sm font-medium rounded-lg transition-all duration-200 border border-purple-200">
                            <i class="bi bi-arrow-left-right"></i>
                            反选
                        </button>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div v-if="loading" class="flex flex-col items-center justify-center h-64">
                    <i class="bi bi-arrow-clockwise text-6xl text-gray-400 mb-4 opacity-50 animate-spin"></i>
                    <p class="text-gray-700">加载中...</p>
                </div>

                <!-- 空状态 -->
                <div v-else-if="displayFiles.length === 0" class="flex flex-col items-center justify-center h-64">
                    <i class="bi bi-folder2-open text-6xl text-gray-400 mb-4 opacity-50"></i>
                    <p class="text-gray-700">未找到文件</p>
                </div>

                <!-- 列表视图 -->
                <div v-else-if="viewMode === 'list'" class="space-y-0.5">
                    <div
                        v-for="file in displayFiles"
                        :key="file.key"
                        @click="batchMode ? toggleFileSelection(file, $event) : handleFileClick(file)"
                        @contextmenu="showContextMenu($event, 'file', file)"
                        :class="['file-card', {'selected': batchMode && isFileSelected(file)}]"
                        class="flex items-center gap-2.5 px-3 py-1.5 border border-gray-200 bg-white rounded-md cursor-pointer group hover:border-blue-300 transition-all">
                        <!-- 复选框（批量模式） -->
                        <div v-if="batchMode" class="flex-shrink-0">
                            <input
                                type="checkbox"
                                :checked="isFileSelected(file)"
                                @click.stop="toggleFileSelection(file, $event)"
                                class="w-4 h-4">
                        </div>

                        <!-- 文件图标 -->
                        <div class="flex-shrink-0 w-7 flex items-center justify-center">
                            <i :class="[getFileIcon(file), getFileColor(file)]" class="text-xl"></i>
                        </div>

                        <!-- 文件名 -->
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-900 truncate">{{ file.name }}</h3>
                        </div>

                        <!-- 文件大小 -->
                        <div class="w-20 text-right flex-shrink-0">
                            <span v-if="!file.isFolder" class="text-xs text-gray-600">{{ formatFileSize(file.size) }}</span>
                            <span v-if="file.isFolder && folderSizes[file.key]" class="text-xs text-gray-600">
                                {{ formatFileSize(folderSizes[file.key]) }}
                            </span>
                            <span v-if="file.isFolder && !folderSizes[file.key]" class="text-xs text-gray-400">--</span>
                        </div>

                        <!-- 修改时间 -->
                        <div class="w-28 text-right flex-shrink-0">
                            <span v-if="!file.isFolder" class="text-xs text-gray-500">{{ formatDate(file.lastModified) }}</span>
                            <span v-if="file.isFolder" class="text-xs text-gray-400">--</span>
                        </div>

                        <!-- 文件类型标签 -->
                        <div class="w-16 flex-shrink-0 flex items-center justify-center">
                            <span v-if="!file.isFolder"
                                  :class="getFileTypeBadgeClass(file)"
                                  class="px-2 py-0.5 rounded text-xs font-medium">
                                {{ getFileTypeLabel(file) }}
                            </span>
                        </div>

                        <!-- 文件路径（仅当路径与文件名不同时显示） -->
                        <div v-if="shouldShowPath(file)" class="flex-1 min-w-0 px-2">
                            <div class="text-xs text-gray-400 truncate" :title="file.key">
                                {{ file.key }}
                            </div>
                        </div>
                        <div v-else class="flex-1 min-w-0 px-2"></div>

                        <!-- 快捷操作按钮（始终显示） -->
                        <div class="flex items-center justify-end gap-1 flex-shrink-0">
                            <button
                                v-if="!file.isFolder && canPreview(file)"
                                @click.stop="previewFile(file)"
                                class="p-1.5 hover:bg-green-50 rounded text-gray-400 hover:text-green-600 transition-colors"
                                title="预览">
                                <i class="bi bi-eye text-sm"></i>
                            </button>
                            <button
                                v-if="!file.isFolder"
                                @click.stop="downloadFile(file)"
                                class="p-1.5 hover:bg-blue-50 rounded text-gray-400 hover:text-blue-600 transition-colors"
                                title="下载">
                                <i class="bi bi-download text-sm"></i>
                            </button>
                            <button
                                v-if="!file.isFolder"
                                @click.stop="shareFile(file)"
                                class="p-1.5 hover:bg-purple-50 rounded text-gray-400 hover:text-purple-600 transition-colors"
                                title="分享">
                                <i class="bi bi-share text-sm"></i>
                            </button>
                            <button
                                @click.stop="renameFile(file)"
                                class="p-1.5 hover:bg-yellow-50 rounded text-gray-400 hover:text-yellow-600 transition-colors"
                                title="重命名">
                                <i class="bi bi-pencil text-sm"></i>
                            </button>
                            <button
                                @click.stop="deleteFile(file)"
                                class="p-1.5 hover:bg-red-50 rounded text-gray-400 hover:text-red-600 transition-colors"
                                title="删除">
                                <i class="bi bi-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 网格视图 -->
                <div v-else-if="viewMode === 'grid'" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-3">
                    <div
                        v-for="file in displayFiles"
                        :key="file.key"
                        @click="batchMode ? toggleFileSelection(file, $event) : handleFileClick(file)"
                        @contextmenu="showContextMenu($event, 'file', file)"
                        :class="{'selected': batchMode && isFileSelected(file)}"
                        class="file-card group relative flex flex-col items-center border border-gray-200 bg-white rounded-lg cursor-pointer hover:border-blue-400"
                        :style="file.isFolder ? 'padding: 0.5rem' : 'padding: 0.75rem'">
                        <!-- 复选框（批量模式，左上角） -->
                        <div v-if="batchMode" class="absolute top-1.5 left-1.5 z-10">
                            <input
                                type="checkbox"
                                :checked="isFileSelected(file)"
                                @click.stop="toggleFileSelection(file, $event)"
                                class="w-4 h-4 cursor-pointer">
                        </div>

                        <!-- 文件图标 -->
                        <i :class="[getFileIcon(file), getFileColor(file)]" :style="file.isFolder ? 'font-size: 2.5rem; margin-bottom: 0.25rem' : 'font-size: 3rem; margin-bottom: 0.5rem'"></i>

                        <!-- 文件名 -->
                        <h3 class="text-xs font-medium text-gray-900 text-center truncate w-full px-1" :title="file.name">
                            {{ file.name }}
                        </h3>

                        <!-- 文件信息 -->
                        <div v-if="!file.isFolder" class="text-xs text-gray-500 mt-0.5 text-center">
                            {{ formatFileSize(file.size) }}
                        </div>
                        <div v-else-if="file.isFolder && folderSizes[file.key]" class="text-xs text-gray-500 mt-0.5 text-center">
                            <i class="bi bi-hdd"></i> {{ formatFileSize(folderSizes[file.key]) }}
                        </div>

                        <!-- 操作按钮（悬停显示） -->
                        <div class="absolute top-1 right-1 flex gap-0.5 opacity-0 group-hover:opacity-100 transition-all duration-200 bg-white/90 backdrop-blur-sm rounded-lg shadow-lg p-0.5">
                            <button
                                v-if="!file.isFolder && canPreview(file)"
                                @click.stop="previewFile(file)"
                                class="p-1.5 hover:bg-gradient-to-br hover:from-green-50 hover:to-green-100 rounded-lg text-gray-600 hover:text-green-600 transition-all duration-200"
                                title="预览">
                                <i class="bi bi-eye text-sm"></i>
                            </button>
                            <button
                                v-if="!file.isFolder"
                                @click.stop="downloadFile(file)"
                                class="p-1.5 hover:bg-gradient-to-br hover:from-blue-50 hover:to-blue-100 rounded-lg text-gray-600 hover:text-blue-600 transition-all duration-200"
                                title="下载">
                                <i class="bi bi-download text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- v2 API使用无限滚动，无需分页按钮 -->
            </div>
        </main>

        <!-- 上传对话框 -->
        <div v-if="showUploadDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showUploadDialog = false">
            <div class="bg-gradient-to-br from-white to-blue-50/30 rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up border border-blue-100">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <i class="bi bi-cloud-upload text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold bg-gradient-to-r from-gray-900 to-blue-900 bg-clip-text text-transparent">上传文件</h3>
                </div>

                <!-- 上传模式选择 -->
                <div class="flex gap-2 mb-4">
                    <button
                        @click="uploadMode = 'file'"
                        :class="uploadMode === 'file' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-50'"
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-200 transition-all text-sm font-medium">
                        <i class="bi bi-file-earmark mr-2"></i>
                        上传文件
                    </button>
                    <button
                        @click="uploadMode = 'folder'"
                        :class="uploadMode === 'folder' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-50'"
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-200 transition-all text-sm font-medium">
                        <i class="bi bi-folder-fill mr-2"></i>
                        上传文件夹
                    </button>
                </div>

                <!-- 文件/文件夹选择 -->
                <!-- 隐藏的文件输入 -->
                <input
                    v-if="uploadMode === 'file'"
                    type="file"
                    multiple
                    ref="fileInput"
                    @change="handleFileSelect"
                    class="hidden">
                <input
                    v-else
                    type="file"
                    webkitdirectory
                    directory
                    multiple
                    ref="folderInput"
                    @change="handleFolderSelect"
                    class="hidden">

                <!-- 自定义选择按钮 -->
                <div class="mb-4">
                    <button
                        type="button"
                        @click="triggerFileInput"
                        class="w-full flex items-center justify-center gap-3 px-6 py-4 bg-gradient-to-br from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 border-2 border-dashed border-blue-300 hover:border-blue-400 rounded-xl transition-all duration-200 group">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-md group-hover:shadow-lg group-hover:scale-110 transition-all duration-200">
                            <i :class="uploadMode === 'file' ? 'bi bi-file-earmark-plus' : 'bi bi-folder2-open'" class="text-white text-lg"></i>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-semibold text-gray-900">
                                {{ uploadMode === 'file' ? '选择文件' : '选择文件夹' }}
                            </div>
                            <div class="text-xs text-gray-600 mt-0.5">
                                {{ uploadMode === 'file' ? '支持多文件选择' : '保持目录结构上传' }}
                            </div>
                        </div>
                        <i class="bi bi-chevron-right text-gray-400 ml-auto group-hover:text-blue-600 transition-colors"></i>
                    </button>
                </div>

                <!-- 已选择的文件信息 -->
                <div v-if="uploadFiles.length > 0" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center gap-2 text-sm text-blue-900">
                        <i class="bi bi-info-circle"></i>
                        <span>已选择 <span class="font-semibold">{{ uploadFiles.length }}</span> 个文件</span>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button @click="showUploadDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-all duration-200">取消</button>
                    <button @click="doUploadFiles" :disabled="uploadFiles.length === 0" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 shadow-lg shadow-blue-500/30">上传</button>
                </div>
            </div>
        </div>

        <!-- 创建文件夹对话框 -->
        <div v-if="showCreateFolderDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showCreateFolderDialog = false">
            <div class="bg-gradient-to-br from-white to-blue-50/30 rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up border border-blue-100">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <i class="bi bi-folder-plus text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold bg-gradient-to-r from-gray-900 to-blue-900 bg-clip-text text-transparent">新建文件夹</h3>
                </div>
                <input
                    v-model="folderName"
                    type="text"
                    placeholder="请输入文件夹名称"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 bg-white text-gray-900 placeholder-gray-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all duration-200">
                <div class="flex justify-end gap-3">
                    <button @click="showCreateFolderDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-all duration-200">取消</button>
                    <button @click="createFolder" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-lg shadow-blue-500/30">创建</button>
                </div>
            </div>
        </div>

        <!-- 删除确认对话框 -->
        <div v-if="showDeleteDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showDeleteDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-slide-up">
                <!-- 标题栏 -->
                <div class="flex items-center justify-between p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-lg shadow-red-500/30">
                            <i class="bi bi-exclamation-triangle text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">确认删除</h3>
                            <p class="text-sm text-gray-500 mt-1">此操作不可恢复</p>
                        </div>
                    </div>
                </div>

                <!-- 内容区 -->
                <div class="px-6 pb-6">
                    <div class="flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-xl border border-gray-200">
                        <i :class="[getFileIcon(fileToDelete), getFileColor(fileToDelete)]" class="text-2xl"></i>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate">{{ fileToDelete?.name }}</p>
                            <p class="text-xs text-gray-500 mt-0.5">
                                {{ fileToDelete?.isFolder ? '文件夹' : formatFileSize(fileToDelete?.size) }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 底部操作栏 -->
                <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-100 bg-gray-50">
                    <button @click="showDeleteDialog = false"
                            class="px-5 py-2.5 text-gray-700 hover:bg-white rounded-xl transition-all border border-transparent hover:border-gray-200">
                        取消
                    </button>
                    <button @click="confirmDelete"
                            class="px-6 py-2.5 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl hover:from-red-700 hover:to-red-800 transition-all shadow-lg shadow-red-500/20 flex items-center gap-2 font-medium">
                        <i class="bi bi-trash"></i>
                        <span>确认删除</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 批量删除确认对话框 -->
        <div v-if="showBatchDeleteDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showBatchDeleteDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-slide-up">
                <!-- 标题栏 -->
                <div class="flex items-center justify-between p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-lg shadow-red-500/30">
                            <i class="bi bi-exclamation-triangle text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">批量删除确认</h3>
                            <p class="text-sm text-gray-500 mt-1">此操作不可恢复</p>
                        </div>
                    </div>
                </div>

                <!-- 内容区 -->
                <div class="px-6 pb-6">
                    <div class="flex items-start gap-3 px-4 py-3 bg-amber-50 rounded-xl border border-amber-200 mb-4">
                        <i class="bi bi-info-circle text-amber-600 text-lg flex-shrink-0 mt-0.5"></i>
                        <div class="text-sm text-amber-900">
                            <p class="font-medium">即将删除 <span class="font-bold text-amber-700">{{ selectedFilesCount }}</span> 个文件</p>
                        </div>
                    </div>

                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        <div v-for="file in selectedFilesList.slice(0, 5)" :key="file.key"
                             class="flex items-center gap-3 px-4 py-2.5 bg-gray-50 rounded-lg border border-gray-200">
                            <i :class="[getFileIcon(file), getFileColor(file)]" class="text-xl"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">{{ file.name }}</p>
                            </div>
                        </div>
                        <div v-if="selectedFilesCount > 5" class="text-center py-2 text-sm text-gray-500">
                            还有 {{ selectedFilesCount - 5 }} 个文件...
                        </div>
                    </div>
                </div>

                <!-- 底部操作栏 -->
                <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-100 bg-gray-50">
                    <button @click="showBatchDeleteDialog = false"
                            class="px-5 py-2.5 text-gray-700 hover:bg-white rounded-xl transition-all border border-transparent hover:border-gray-200">
                        取消
                    </button>
                    <button @click="confirmBatchDelete"
                            class="px-6 py-2.5 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl hover:from-red-700 hover:to-red-800 transition-all shadow-lg shadow-red-500/20 flex items-center gap-2 font-medium">
                        <i class="bi bi-trash"></i>
                        <span>确认删除全部</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 重命名对话框 -->
        <div v-if="showRenameDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showRenameDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-slide-up">
                <!-- 标题栏 -->
                <div class="flex items-center justify-between p-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                            <i class="bi bi-pencil-square text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">重命名</h3>
                            <p class="text-sm text-gray-500 mt-1">{{ fileToRename?.isFolder ? '文件夹' : '文件' }}</p>
                        </div>
                    </div>
                </div>

                <!-- 内容区 -->
                <div class="px-6 pb-6 space-y-4">
                    <div class="flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-xl border border-gray-200">
                        <i :class="[getFileIcon(fileToRename), getFileColor(fileToRename)]" class="text-2xl"></i>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate">{{ fileToRename?.name }}</p>
                            <p class="text-xs text-gray-500 mt-0.5">
                                {{ fileToRename?.isFolder ? '文件夹' : formatFileSize(fileToRename?.size) }}
                            </p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">新名称</label>
                        <input
                            v-model="newFileName"
                            type="text"
                            placeholder="请输入新名称"
                            @keyup.enter="confirmRename"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-white text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all">
                    </div>
                </div>

                <!-- 底部操作栏 -->
                <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-100 bg-gray-50">
                    <button @click="showRenameDialog = false"
                            class="px-5 py-2.5 text-gray-700 hover:bg-white rounded-xl transition-all border border-transparent hover:border-gray-200">
                        取消
                    </button>
                    <button @click="confirmRename"
                            :disabled="!newFileName.trim()"
                            class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 disabled:opacity-40 disabled:cursor-not-allowed transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2 font-medium">
                        <i class="bi bi-check-lg"></i>
                        <span>确认重命名</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 分享链接对话框 -->
        <div v-if="showShareDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showShareDialog = false">
            <div class="bg-gradient-to-br from-white to-green-50/30 rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up border border-green-200">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-green-500/30">
                        <i class="bi bi-share text-white text-2xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold bg-gradient-to-r from-gray-900 to-green-900 bg-clip-text text-transparent">生成分享链接</h3>
                        <p class="text-sm text-gray-600 mt-1">设置链接过期时间</p>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-3">
                        <i :class="[getFileIcon(fileToShare), getFileColor(fileToShare)]" class="text-2xl"></i>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate">{{ fileToShare?.name }}</p>
                            <p class="text-xs text-gray-600 mt-0.5">{{ formatFileSize(fileToShare?.size) }}</p>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">过期时间</label>
                    <select
                        v-model="shareExpiration"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-green-500/20 focus:border-green-500 outline-none transition-all duration-200">
                        <option value="3600">1小时</option>
                        <option value="21600">6小时</option>
                        <option value="86400">1天</option>
                        <option value="259200">3天</option>
                        <option value="604800">7天</option>
                    </select>
                </div>

                <div v-if="shareUrl" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">分享链接</label>
                    <div class="flex items-center gap-2">
                        <input
                            :value="shareUrl"
                            readonly
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm"
                            @focus="$event.target.select()">
                        <button
                            @click="copyShareUrl"
                            class="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 flex items-center gap-2 whitespace-nowrap transition-all duration-200 shadow-lg shadow-green-500/30">
                            <i class="bi bi-clipboard"></i>
                            复制
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mt-2">
                        链接将于 {{ formatExpirationTime(shareExpiresAt) }} 过期
                    </p>
                </div>

                <div class="flex justify-end gap-3">
                    <button @click="showShareDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-all duration-200">取消</button>
                    <button
                        v-if="!shareUrl"
                        @click="generateShareUrl"
                        class="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 flex items-center gap-2 transition-all duration-200 shadow-lg shadow-green-500/30">
                        <i class="bi bi-link-45deg"></i>
                        生成链接
                    </button>
                </div>
            </div>
        </div>

        <!-- 文件预览对话框 -->
        <div v-if="showPreviewDialog" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" @click.self="closePreview">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[85vh] flex flex-col">
                <!-- 标题栏 - 紧凑设计 -->
                <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-gray-50">
                    <div class="flex items-center gap-2 min-w-0 flex-1">
                        <i :class="[getFileIcon(currentPreviewFile), getFileColor(currentPreviewFile)]" class="text-lg flex-shrink-0"></i>
                        <h3 class="text-sm font-semibold truncate text-gray-900">{{ currentPreviewFile?.name }}</h3>
                    </div>
                    <button @click="closePreview" class="p-1.5 hover:bg-gray-200 rounded-lg text-gray-600 hover:text-gray-900 transition-colors flex-shrink-0 ml-2">
                        <i class="bi bi-x-lg text-sm"></i>
                    </button>
                </div>
                <!-- 内容区域 -->
                <div class="flex-1 overflow-auto">
                    <div v-if="previewLoading" class="flex items-center justify-center h-full">
                        <i class="bi bi-arrow-clockwise text-6xl text-gray-500 animate-spin"></i>
                    </div>
                    <div v-else-if="isImageFile(currentPreviewFile)" class="flex flex-col h-full">
                        <!-- 图片控制栏 - 紧凑设计 -->
                        <div class="flex items-center justify-center gap-2 bg-gray-50 px-3 py-2 border-b border-gray-200">
                            <button @click="zoomOut" class="p-1.5 hover:bg-gray-200 rounded transition-colors" title="缩小">
                                <i class="bi bi-zoom-out text-sm"></i>
                            </button>
                            <span class="text-xs font-medium min-w-12 text-center text-gray-700">{{ Math.round(imageZoom * 100) }}%</span>
                            <button @click="zoomIn" class="p-1.5 hover:bg-gray-200 rounded transition-colors" title="放大">
                                <i class="bi bi-zoom-in text-sm"></i>
                            </button>
                            <div class="w-px h-4 bg-gray-300 mx-1"></div>
                            <button @click="resetZoom" class="p-1.5 hover:bg-gray-200 rounded transition-colors" title="重置">
                                <i class="bi bi-arrow-clockwise text-sm"></i>
                            </button>
                            <button @click="rotateImage" class="p-1.5 hover:bg-gray-200 rounded transition-colors" title="旋转">
                                <i class="bi bi-arrow-repeat text-sm"></i>
                            </button>
                            <div class="w-px h-4 bg-gray-300 mx-1"></div>
                            <label class="flex items-center gap-1.5 text-xs cursor-pointer px-2 py-1 hover:bg-gray-200 rounded transition-colors">
                                <input type="checkbox" v-model="imageCompression" class="w-3 h-3" @change="toggleCompression">
                                <span class="text-gray-700">压缩</span>
                            </label>
                        </div>
                        <!-- 图片显示区域 -->
                        <div class="flex-1 overflow-auto flex items-center justify-center bg-gray-100 p-4">
                            <img
                                :src="displayImageUrl"
                                :alt="currentPreviewFile?.name"
                                :style="{
                                    transform: `scale(${imageZoom}) rotate(${imageRotation}deg)`,
                                    transition: 'transform 0.3s ease'
                                }"
                                :class="imageCompression ? 'max-w-[800px]' : 'max-w-full max-h-[calc(85vh-180px)]'"
                                class="object-contain">
                        </div>
                    </div>
                    <div v-else-if="isExcelFile(currentPreviewFile)" class="h-full">
                        <!-- Excel/CSV 表格预览 -->
                        <div class="h-full flex flex-col">
                            <!-- 工作表标签（如果有多个sheet） - 紧凑设计 -->
                            <div v-if="excelSheets.length > 1" class="flex gap-1 px-3 py-2 border-b border-gray-200 bg-gray-50 overflow-x-auto">
                                <button v-for="(sheet, index) in excelSheets" :key="index"
                                        @click="currentSheetIndex = index"
                                        :class="currentSheetIndex === index ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                                        class="px-3 py-1.5 rounded text-xs font-medium whitespace-nowrap transition-all border border-gray-200">
                                    {{ sheet.name }}
                                </button>
                            </div>
                            <!-- 表格容器 -->
                            <div class="flex-1 excel-table-container p-4">
                                <table class="excel-table" v-if="excelSheets[currentSheetIndex]">
                                    <thead>
                                        <tr>
                                            <th v-for="(header, index) in excelSheets[currentSheetIndex].headers" :key="index">
                                                {{ header }}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(row, rowIndex) in excelSheets[currentSheetIndex].rows" :key="rowIndex">
                                            <td v-for="(cell, cellIndex) in row" :key="cellIndex">
                                                {{ cell }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="isMarkdownFile(currentPreviewFile)" class="h-full overflow-auto">
                        <div class="markdown-content p-6 bg-white" v-html="renderedMarkdown"></div>
                    </div>
                    <div v-else-if="isCodeFile(currentPreviewFile)" class="h-full overflow-auto">
                        <pre class="h-full m-0"><code :class="getCodeLanguage(currentPreviewFile)" class="block h-full" v-html="highlightedCode"></code></pre>
                    </div>
                    <div v-else-if="isTextFile(currentPreviewFile)" class="h-full">
                        <pre class="text-sm bg-gray-50 p-4 rounded-lg overflow-auto h-full font-mono text-gray-900">{{ previewContent }}</pre>
                    </div>
                    <div v-else-if="isPdfFile(currentPreviewFile)" class="h-full flex flex-col">
                        <!-- PDF 控制栏 - 紧凑设计 -->
                        <div class="flex items-center justify-between px-3 py-2 border-b border-gray-200 bg-gray-50">
                            <div class="flex items-center gap-2">
                                <button @click="prevPdfPage" :disabled="pdfCurrentPage <= 1"
                                        class="p-1.5 bg-white border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                    <i class="bi bi-chevron-left text-sm"></i>
                                </button>
                                <span class="text-xs text-gray-700 flex items-center gap-1">
                                    <input type="number" v-model.number="pdfCurrentPage" @change="renderPdfPage"
                                             :min="1" :max="pdfTotalPages"
                                             class="w-12 px-1.5 py-1 border border-gray-300 rounded text-center text-xs">
                                    / {{ pdfTotalPages }}
                                </span>
                                <button @click="nextPdfPage" :disabled="pdfCurrentPage >= pdfTotalPages"
                                        class="p-1.5 bg-white border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                    <i class="bi bi-chevron-right text-sm"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button @click="zoomOutPdf" class="p-1.5 bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors">
                                    <i class="bi bi-zoom-out text-sm"></i>
                                </button>
                                <span class="text-xs text-gray-700 min-w-12 text-center">{{ Math.round(pdfScale * 100) }}%</span>
                                <button @click="zoomInPdf" class="p-1.5 bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors">
                                    <i class="bi bi-zoom-in text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <!-- PDF 渲染区域 -->
                        <div class="flex-1 overflow-auto bg-gray-100 flex items-start justify-center p-4">
                            <canvas ref="pdfCanvas" class="shadow-lg"></canvas>
                        </div>
                    </div>
                    <div v-else-if="isVideoFile(currentPreviewFile)" class="h-full flex flex-col">
                        <!-- 视频控制栏 - 紧凑设计 -->
                        <div class="flex items-center gap-3 px-3 py-2 border-b border-gray-200 bg-gray-50">
                            <!-- 播放速度 -->
                            <div class="flex items-center gap-1.5">
                                <i class="bi bi-speedometer text-gray-600 text-sm"></i>
                                <span class="text-xs text-gray-600">速度</span>
                                <select v-model.number="videoPlaybackRate"
                                        @change="updateVideoPlaybackRate"
                                        class="px-1.5 py-1 border border-gray-300 rounded text-xs bg-white">
                                    <option :value="0.25">0.25x</option>
                                    <option :value="0.5">0.5x</option>
                                    <option :value="0.75">0.75x</option>
                                    <option :value="1.0">1.0x</option>
                                    <option :value="1.25">1.25x</option>
                                    <option :value="1.5">1.5x</option>
                                    <option :value="2.0">2.0x</option>
                                </select>
                            </div>

                            <div class="w-px h-4 bg-gray-300"></div>

                            <!-- 音量控制 -->
                            <div class="flex items-center gap-1.5">
                                <i class="bi bi-volume-up text-gray-600 text-sm"></i>
                                <span class="text-xs text-gray-600">音量</span>
                                <input type="range"
                                       v-model.number="videoVolume"
                                       @input="updateVideoVolume"
                                       min="0"
                                       max="1"
                                       step="0.01"
                                       class="w-24">
                                <span class="text-xs text-gray-600 min-w-10">{{ Math.round(videoVolume * 100) }}%</span>
                            </div>
                        </div>

                        <!-- 视频播放器 -->
                        <div class="flex-1 flex items-center justify-center bg-black">
                            <video
                                ref="videoPlayer"
                                :src="previewUrl"
                                controls
                                autoplay
                                class="max-w-full max-h-full"
                                style="max-height: calc(90vh - 250px);">
                                您的浏览器不支持视频播放
                            </video>
                        </div>
                    </div>
                    <div v-else-if="isAudioFile(currentPreviewFile)" class="flex flex-col items-center justify-center h-full p-6">
                        <div class="w-full max-w-xl bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 shadow-md">
                            <div class="flex items-center justify-center mb-4">
                                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                                    <i class="bi bi-music-note-beamed text-white text-3xl"></i>
                                </div>
                            </div>
                            <h3 class="text-sm font-semibold text-center text-gray-900 mb-4 truncate">{{ currentPreviewFile?.name }}</h3>
                            <audio
                                :src="previewUrl"
                                controls
                                autoplay
                                class="w-full rounded-lg">
                                您的浏览器不支持音频播放
                            </audio>
                            <div class="mt-3 text-center text-xs text-gray-600">
                                <p>{{ formatFileSize(currentPreviewFile?.size) }}</p>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="isOfficeFile(currentPreviewFile)" class="flex flex-col items-center justify-center h-full p-6">
                        <div class="w-full max-w-lg bg-white rounded-xl p-6 shadow-md border border-gray-200">
                            <div class="flex items-center justify-center mb-4">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center shadow-md">
                                    <i class="bi bi-file-earmark-word text-white text-2xl"></i>
                                </div>
                            </div>
                            <h3 class="text-sm font-semibold text-center text-gray-900 mb-2 truncate">{{ currentPreviewFile?.name }}</h3>
                            <div class="text-center text-gray-600 mb-4">
                                <p class="text-xs">Office 文档在线预览</p>
                                <p class="text-xs mt-1">{{ formatFileSize(currentPreviewFile?.size) }}</p>
                            </div>
                            <div class="space-y-2">
                                <button
                                    @click="previewOfficeWithGoogleDocs"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 text-sm">
                                    <i class="bi bi-google"></i>
                                    <span>Google Docs 预览</span>
                                </button>
                                <button
                                    @click="previewOfficeWithMicrosoft"
                                    class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 text-sm">
                                    <i class="bi bi-microsoft"></i>
                                    <span>Microsoft Office 预览</span>
                                </button>
                                <button
                                    @click="downloadFile(currentPreviewFile)"
                                    class="w-full bg-gray-100 hover:bg-gray-200 text-gray-900 px-4 py-2.5 rounded-lg transition-all flex items-center justify-center gap-2 text-sm">
                                    <i class="bi bi-download"></i>
                                    <span>下载到本地</span>
                                </button>
                            </div>
                            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <i class="bi bi-info-circle mr-2"></i>
                                    提示：在线预览需要文件URL可公网访问。如果预览失败，请下载到本地查看。
                                </p>
                            </div>
                        </div>
                    </div>
                    <div v-else class="flex flex-col items-center justify-center h-full text-gray-600">
                        <i class="bi bi-file-earmark-x text-6xl mb-4"></i>
                        <p>此文件类型不支持预览</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 批量移动对话框 -->
        <div v-if="showBatchMoveDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showBatchMoveDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[75vh] flex flex-col animate-slide-up">
                <!-- 标题栏 -->
                <div class="flex items-center justify-between p-5">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg shadow-purple-500/30">
                            <i class="bi bi-folder-symlink text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">批量移动文件</h3>
                            <p class="text-xs text-gray-500 mt-0.5">已选择 {{ selectedFilesCount }} 个文件</p>
                        </div>
                    </div>
                    <button @click="showBatchMoveDialog = false" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-lg text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- 主内容区 -->
                <div class="flex-1 overflow-y-auto px-5 pb-5">
                    <!-- 提示信息 -->
                    <div class="flex items-start gap-2 px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                        <i class="bi bi-info-circle text-amber-600 flex-shrink-0 mt-0.5"></i>
                        <p class="text-xs text-amber-900">移动后将从原位置删除</p>
                    </div>

                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                            <i class="bi bi-folder2-open text-purple-600"></i>
                            选择目标文件夹
                        </h4>

                        <!-- 加载状态 -->
                        <div v-if="loadingFolders" class="flex flex-col items-center justify-center py-8">
                            <i class="bi bi-arrow-clockwise text-3xl text-purple-500 animate-spin mb-2"></i>
                            <p class="text-xs text-gray-600">加载文件夹列表...</p>
                        </div>

                        <!-- 文件夹树 -->
                        <div v-else class="space-y-1.5">
                            <!-- 根目录 -->
                            <button
                                @click="selectedTargetFolder = ''"
                                :class="selectedTargetFolder === '' ? 'bg-purple-50 border-purple-300' : 'bg-white border-gray-200 hover:border-purple-200'"
                                class="w-full flex items-center gap-2 px-3 py-2 rounded-lg border transition-all text-left group">
                                <i class="bi bi-house-fill text-gray-600 group-hover:text-purple-600 transition-colors"></i>
                                <span class="text-sm font-medium text-gray-900 flex-1">/ (根目录)</span>
                                <i v-if="selectedTargetFolder === ''" class="bi bi-check-circle-fill text-purple-600"></i>
                                <i v-else class="bi bi-chevron-right text-xs text-gray-400 group-hover:text-purple-600 transition-colors"></i>
                            </button>

                            <!-- 文件夹列表 -->
                            <div v-for="folder in folderTree" :key="folder.key">
                                <div class="flex items-center gap-2"
                                     :style="{ paddingLeft: (folder.level * 24) + 'px' }">
                                    <!-- 展开/折叠按钮 -->
                                    <button
                                        v-if="folder.hasChildren"
                                        @click.stop="toggleFolder(folder)"
                                        class="w-6 h-6 flex items-center justify-center hover:bg-purple-100 rounded transition-colors flex-shrink-0">
                                        <i v-if="loadingSubFolders.has(folder.key)" class="bi bi-arrow-clockwise text-xs animate-spin text-purple-600"></i>
                                        <i v-else :class="expandedFolders.has(folder.key) ? 'bi-chevron-down' : 'bi-chevron-right'" class="text-xs text-gray-500"></i>
                                    </button>
                                    <div v-else class="w-6"></div>

                                    <!-- 文件夹按钮 -->
                                    <button
                                        @click="selectedTargetFolder = folder.key"
                                        :disabled="folder.key === currentPath || selectedFilesList.some(f => f.key === folder.key)"
                                        :class="[
                                            selectedTargetFolder === folder.key ? 'bg-purple-50 border-purple-300' : 'bg-white border-gray-200 hover:border-purple-200',
                                            (folder.key === currentPath || selectedFilesList.some(f => f.key === folder.key)) ? 'opacity-40 cursor-not-allowed' : ''
                                        ]"
                                        class="flex-1 flex items-center gap-2 px-3 py-2 rounded-lg border transition-all text-left group">
                                        <i :class="expandedFolders.has(folder.key) ? 'bi-folder2-open' : 'bi-folder-fill'" class="text-xl text-blue-500"></i>
                                        <span class="text-sm font-medium text-gray-900 flex-1 truncate">{{ folder.name }}</span>
                                        <span v-if="folder.key === currentPath" class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded text-xs">(当前)</span>
                                        <i v-else-if="selectedTargetFolder === folder.key" class="bi bi-check-circle-fill text-purple-600"></i>
                                        <i v-else class="bi bi-chevron-right text-xs text-gray-400 group-hover:text-purple-600 transition-colors"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- 空状态 -->
                            <div v-if="folderTree.length === 0" class="text-center py-8 text-gray-400">
                                <i class="bi bi-folder2-open text-4xl mb-2 opacity-30"></i>
                                <p class="text-xs">当前bucket没有文件夹</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部操作栏 -->
                <div class="flex items-center justify-between p-5 border-t border-gray-100 bg-gray-50">
                    <div></div>
                    <div class="flex gap-2">
                        <button @click="showBatchMoveDialog = false"
                                class="px-4 py-2 text-gray-700 hover:bg-white rounded-lg transition-all border border-transparent hover:border-gray-200">
                            取消
                        </button>
                        <button @click="confirmBatchMove"
                                :disabled="selectedTargetFolder === null"
                                class="px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 disabled:opacity-40 disabled:cursor-not-allowed transition-all shadow-lg shadow-purple-500/20 flex items-center gap-1.5 font-medium text-sm">
                            <i class="bi bi-check-lg"></i>
                            <span>开始移动</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 批量复制到其他Bucket对话框 -->
        <div v-if="showBatchCopyDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showBatchCopyDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[75vh] flex flex-col animate-slide-up">
                <!-- 标题栏 -->
                <div class="flex items-center justify-between p-5">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center shadow-lg shadow-green-500/30">
                            <i class="bi bi-files text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">跨Bucket复制文件</h3>
                            <p class="text-xs text-gray-500 mt-0.5">已选择 {{ selectedFilesCount }} 个文件</p>
                        </div>
                    </div>
                    <button @click="showBatchCopyDialog = false"
                            class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-lg text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- 步骤指示器 -->
                <div class="px-5 pb-3">
                    <div class="flex items-center mb-2">
                        <div v-for="step in 2" :key="step" class="flex items-center" :class="step < 2 ? 'flex-1' : ''">
                            <div :class="[
                                'w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all',
                                copyStep >= step ? 'bg-green-600 text-white shadow-lg shadow-green-500/30' : 'bg-gray-200 text-gray-500'
                            ]">
                                {{ step }}
                            </div>
                            <div v-if="step < 2" :class="[
                                'flex-1 h-1 mx-2 rounded transition-all',
                                copyStep > step ? 'bg-green-600' : 'bg-gray-200'
                            ]"></div>
                        </div>
                    </div>
                    <div class="flex justify-between px-0.5">
                        <span class="text-xs" :class="copyStep === 1 ? 'font-semibold text-green-700' : 'text-gray-500'">确认文件</span>
                        <span class="text-xs" :class="copyStep === 2 ? 'font-semibold text-green-700' : 'text-gray-500'">选择目标Bucket</span>
                    </div>
                </div>

                <!-- 步骤内容 -->
                <div class="flex-1 overflow-y-auto px-5 pb-5">
                    <!-- 步骤1：确认文件列表 -->
                    <div v-if="copyStep === 1" class="space-y-2">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                            <i class="bi bi-files text-green-600"></i>
                            待复制文件
                        </h4>
                        <div class="space-y-1.5 max-h-80 overflow-y-auto">
                            <div v-for="file in selectedFilesList" :key="file.key"
                                 class="flex items-center gap-2 px-3 py-2 bg-white rounded-lg border border-gray-200 hover:border-green-300 transition-all">
                                <i :class="[getFileIcon(file), getFileColor(file)]" class="text-xl flex-shrink-0"></i>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate" :title="file.name">{{ file.name }}</p>
                                    <p class="text-xs text-gray-500">{{ formatFileSize(file.size) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 步骤2：选择Bucket -->
                    <div v-if="copyStep === 2" class="space-y-3">
                        <div>
                            <h4 class="text-xs font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                                <i class="bi bi-bucket text-green-600"></i>
                                选择目标Bucket
                            </h4>
                            <div class="space-y-1.5 max-h-56 overflow-y-auto">
                                <button
                                    v-for="bucket in targetBuckets"
                                    :key="bucket"
                                    @click="selectedTargetBucket = bucket"
                                    :class="selectedTargetBucket === bucket ? 'bg-green-50 border-green-300' : 'bg-white border-gray-200 hover:border-green-200'"
                                    class="w-full flex items-center gap-2 px-3 py-2 rounded-lg border transition-all text-left group">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center flex-shrink-0 shadow-md">
                                        <i class="bi bi-bucket-fill text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900">{{ bucket }}</p>
                                        <p v-if="bucket === currentBucket" class="text-xs text-gray-500">当前Bucket</p>
                                    </div>
                                    <i v-if="selectedTargetBucket === bucket" class="bi bi-check-circle-fill text-green-600"></i>
                                    <i v-else class="bi bi-chevron-right text-xs text-gray-400 group-hover:text-green-600 transition-colors"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-start gap-2 px-3 py-2 bg-green-50 rounded-lg border border-green-200">
                            <input
                                type="checkbox"
                                id="keepPath"
                                v-model="keepPathStructure"
                                class="w-4 h-4 rounded cursor-pointer mt-0.5">
                            <label for="keepPath" class="flex-1 cursor-pointer">
                                <p class="font-medium text-gray-900 text-xs">保留目录结构</p>
                                <p class="text-xs text-gray-600 mt-0.5">复制时保持原有的文件夹层级关系</p>
                            </label>
                        </div>

                        <div class="flex items-start gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-200">
                            <i class="bi bi-info-circle text-blue-600 flex-shrink-0 mt-0.5"></i>
                            <div class="text-xs text-blue-900">
                                <p class="font-medium mb-0.5">复制配置</p>
                                <p class="text-xs text-blue-700">
                                    从 <span class="font-semibold">{{ currentBucket }}</span>
                                    复制到 <span class="font-semibold">{{ selectedTargetBucket || '(未选择)' }}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部操作栏 -->
                <div class="flex items-center justify-between p-5 border-t border-gray-100 bg-gray-50">
                    <button
                        v-if="copyStep > 1"
                        @click="copyStep--"
                        class="px-4 py-2 text-gray-700 hover:bg-white rounded-lg transition-all border border-transparent hover:border-gray-200 flex items-center gap-1.5 text-sm">
                        <i class="bi bi-chevron-left"></i>
                        <span>上一步</span>
                    </button>
                    <div v-else></div>

                    <div class="flex gap-2">
                        <button @click="showBatchCopyDialog = false"
                                class="px-4 py-2 text-gray-700 hover:bg-white rounded-lg transition-all border border-transparent hover:border-gray-200">
                            取消
                        </button>
                        <button
                            v-if="copyStep < 2"
                            @click="copyStep++"
                            class="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 disabled:opacity-40 disabled:cursor-not-allowed transition-all shadow-lg shadow-green-500/20 flex items-center gap-1.5 font-medium text-sm">
                            <span>下一步</span>
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <button
                            v-else
                            @click="confirmBatchCopy"
                            :disabled="!selectedTargetBucket"
                            class="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 disabled:opacity-40 disabled:cursor-not-allowed transition-all shadow-lg shadow-green-500/20 flex items-center gap-1.5 font-medium text-sm">
                            <i class="bi bi-check-lg"></i>
                            <span>开始复制</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 保存筛选条件对话框 -->
        <div v-if="showSaveFilterDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" @click.self="showSaveFilterDialog = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <i class="bi bi-bookmark-plus text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold bg-gradient-to-r from-gray-900 to-blue-900 bg-clip-text text-transparent">保存筛选条件</h3>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">名称</label>
                    <input
                        v-model="filterName"
                        type="text"
                        placeholder="例如：本月图片文件"
                        @keyup.enter="confirmSaveFilter"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all duration-200">
                </div>
                <div class="flex justify-end gap-3">
                    <button @click="showSaveFilterDialog = false" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-all duration-200">取消</button>
                    <button @click="confirmSaveFilter" :disabled="!filterName.trim()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 disabled:opacity-40 disabled:cursor-not-allowed transition-all duration-200 shadow-lg shadow-blue-500/30">保存</button>
                </div>
            </div>
        </div>

        <!-- Toast 通知（右上角） -->
        <div class="fixed top-6 right-6 z-50 space-y-3 w-96">
            <div
                v-for="toast in toasts"
                :key="toast.id"
                class="bg-white rounded-xl shadow-2xl border p-4 flex items-start gap-3 animate-slide-in-right"
                :class="{
                    'border-green-200': toast.type === 'success',
                    'border-red-200': toast.type === 'error',
                    'border-blue-200': toast.type === 'info'
                }">
                <div
                    class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                    :class="{
                        'bg-green-100': toast.type === 'success',
                        'bg-red-100': toast.type === 'error',
                        'bg-blue-100': toast.type === 'info'
                    }">
                    <i
                        class="text-xl"
                        :class="{
                            'bi-check-circle text-green-600': toast.type === 'success',
                            'bi-x-circle text-red-600': toast.type === 'error',
                            'bi-info-circle text-blue-600': toast.type === 'info'
                        }"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h4
                        class="font-semibold text-sm mb-1"
                        :class="{
                            'text-green-900': toast.type === 'success',
                            'text-red-900': toast.type === 'error',
                            'text-blue-900': toast.type === 'info'
                        }">
                        {{ toast.title }}
                    </h4>
                    <p class="text-xs text-gray-700">{{ toast.message }}</p>
                </div>
                <button @click="removeToast(toast.id)" class="text-gray-600 hover:text-gray-800">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- 上传队列卡片（右下角） -->
        <div v-if="showUploadQueue" class="fixed bottom-6 right-6 z-50 w-96 bg-white rounded-xl shadow-2xl border border-blue-200 animate-slide-up">
            <!-- 标题栏 -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <i class="bi bi-cloud-upload text-white text-sm"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-sm text-gray-900">上传队列</h4>
                        <p class="text-xs text-gray-500">{{ uploadQueue.filter(f => f.status === 'completed').length }} / {{ uploadQueue.length }}</p>
                    </div>
                </div>
                <button @click="showUploadQueue = false" class="text-gray-600 hover:text-gray-800">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>

            <!-- 队列列表 -->
            <div class="max-h-80 overflow-y-auto p-3 space-y-2">
                <div v-for="item in uploadQueue" :key="item.id"
                     class="flex items-start gap-2 p-2 rounded-lg"
                     :class="{
                         'bg-blue-50': item.status === 'uploading',
                         'bg-green-50': item.status === 'completed',
                         'bg-red-50': item.status === 'failed',
                         'bg-gray-50': item.status === 'pending'
                     }">
                    <!-- 文件图标/状态 -->
                    <div class="flex-shrink-0 mt-0.5">
                        <i v-if="item.status === 'uploading'" class="bi bi-arrow-clockwise animate-spin text-blue-600"></i>
                        <i v-else-if="item.status === 'completed'" class="bi bi-check-circle-fill text-green-600"></i>
                        <i v-else-if="item.status === 'failed'" class="bi bi-x-circle-fill text-red-600"></i>
                        <i v-else class="bi bi-clock text-gray-400"></i>
                    </div>

                    <!-- 文件信息 -->
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-medium text-gray-900 truncate" :title="item.name">{{ item.name }}</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-gray-600">{{ formatFileSize(item.size) }}</span>
                            <span v-if="item.status === 'uploading'" class="text-xs font-semibold text-blue-600">{{ item.percent }}%</span>
                            <span v-else-if="item.status === 'completed'" class="text-xs text-green-600">完成</span>
                            <span v-else-if="item.status === 'failed'" class="text-xs text-red-600">失败</span>
                            <span v-else class="text-xs text-gray-500">等待中</span>
                        </div>

                        <!-- 进度条（仅上传中时显示） -->
                        <div v-if="item.status === 'uploading'" class="w-full bg-gray-200 rounded-full h-1 mt-1.5 overflow-hidden">
                            <div class="bg-blue-600 h-full transition-all duration-300 rounded-full"
                                 :style="{ width: item.percent + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 底部统计 -->
            <div class="p-3 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                <div class="flex items-center justify-between text-xs text-gray-600">
                    <span>总计: {{ uploadQueue.length }} 个文件</span>
                    <span>成功: <span class="text-green-600 font-semibold">{{ uploadQueue.filter(f => f.status === 'completed').length }}</span></span>
                    <span v-if="uploadQueue.filter(f => f.status === 'failed').length > 0">
                        失败: <span class="text-red-600 font-semibold">{{ uploadQueue.filter(f => f.status === 'failed').length }}</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- 批量移动进度卡片（右下角） -->
        <div v-if="moveProgress.show" class="fixed bottom-6 right-6 z-50 w-96 bg-white rounded-xl shadow-2xl border border-purple-200 p-4 animate-slide-up">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-sm text-gray-900 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                        <i class="bi bi-folder-symlink text-white text-sm"></i>
                    </div>
                    批量移动中...
                </h4>
            </div>
            <div class="flex items-center gap-3 mb-3">
                <i class="bi bi-file-earmark text-purple-600 text-2xl flex-shrink-0"></i>
                <div class="flex-1">
                    <p class="text-sm text-gray-900 truncate mb-1">{{ moveProgress.currentFile }}</p>
                    <div class="flex items-center gap-2 text-xs text-gray-700">
                        <span>{{ moveProgress.current }} / {{ moveProgress.total }}</span>
                        <span class="text-purple-600 font-semibold">{{ Math.round((moveProgress.current / moveProgress.total) * 100) }}%</span>
                    </div>
                </div>
            </div>
            <div class="mb-2">
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div
                        class="bg-gradient-to-r from-purple-600 to-purple-700 h-full transition-all duration-300 rounded-full"
                        :style="{ width: ((moveProgress.current / moveProgress.total) * 100) + '%' }"></div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs text-gray-600">
                <span>成功: {{ moveProgress.succeeded }}</span>
                <span v-if="moveProgress.failed > 0" class="text-red-600">失败: {{ moveProgress.failed }}</span>
            </div>
        </div>

        <!-- 批量复制进度卡片（右下角） -->
        <div v-if="copyProgress.show" class="fixed bottom-6 right-6 z-50 w-96 bg-white rounded-xl shadow-2xl border border-green-200 p-4 animate-slide-up">
            <div class="flex items-center justify-between mb-3">
                <h4 class="font-semibold text-sm text-gray-900 flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center">
                        <i class="bi bi-files text-white text-sm"></i>
                    </div>
                    跨Bucket复制中...
                </h4>
            </div>
            <div class="flex items-center gap-3 mb-3">
                <i class="bi bi-file-earmark text-green-600 text-2xl flex-shrink-0"></i>
                <div class="flex-1">
                    <p class="text-sm text-gray-900 truncate mb-1">{{ copyProgress.currentFile }}</p>
                    <div class="flex items-center gap-2 text-xs text-gray-700">
                        <span>{{ copyProgress.current }} / {{ copyProgress.total }}</span>
                        <span class="text-green-600 font-semibold">{{ Math.round((copyProgress.current / copyProgress.total) * 100) }}%</span>
                    </div>
                </div>
            </div>
            <div class="mb-2">
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div
                        class="bg-gradient-to-r from-green-600 to-green-700 h-full transition-all duration-300 rounded-full"
                        :style="{ width: ((copyProgress.current / copyProgress.total) * 100) + '%' }"></div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs text-gray-600">
                <span>成功: {{ copyProgress.succeeded }}</span>
                <span v-if="copyProgress.failed > 0" class="text-red-600">失败: {{ copyProgress.failed }}</span>
            </div>
        </div>

        <!-- 批量操作浮动工具栏 -->
        <transition name="toolbar-slide">
            <div v-if="batchMode && hasSelectedFiles" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-40">
                <div class="bg-white rounded-full shadow-2xl border border-gray-200 flex items-center px-3 py-2">
                    <!-- 选择计数 -->
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full mr-2">
                        <i class="bi bi-check-lg text-white text-sm"></i>
                        <span class="text-sm font-bold text-white">{{ selectedFilesCount }}</span>
                    </div>

                    <!-- 操作按钮组 -->
                    <div class="flex items-center gap-1">
                        <button
                            @click="batchDownload"
                            class="w-10 h-10 flex items-center justify-center hover:bg-blue-50 text-blue-600 rounded-full transition-all"
                            title="下载">
                            <i class="bi bi-download text-lg"></i>
                        </button>
                        <button
                            @click="batchMove"
                            class="w-10 h-10 flex items-center justify-center hover:bg-purple-50 text-purple-600 rounded-full transition-all"
                            title="移动">
                            <i class="bi bi-folder-symlink text-lg"></i>
                        </button>
                        <button
                            @click="batchCopyToBucket"
                            class="w-10 h-10 flex items-center justify-center hover:bg-green-50 text-green-600 rounded-full transition-all"
                            title="复制">
                            <i class="bi bi-files text-lg"></i>
                        </button>

                        <div class="w-px h-6 bg-gray-300 mx-1"></div>

                        <button
                            @click="batchDelete"
                            class="w-10 h-10 flex items-center justify-center hover:bg-red-50 text-red-600 rounded-full transition-all"
                            title="删除">
                            <i class="bi bi-trash text-lg"></i>
                        </button>

                        <div class="w-px h-6 bg-gray-300 mx-1"></div>

                        <button
                            @click="clearSelection"
                            class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 text-gray-500 rounded-full transition-all"
                            title="取消">
                            <i class="bi bi-x-lg text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 右键菜单 -->
        <div v-if="contextMenu.show"
             class="context-menu"
             :style="{ left: contextMenu.x + 'px', top: contextMenu.y + 'px' }"
             @click.stop>
            <template v-if="contextMenu.type === 'breadcrumb'">
                <div class="context-menu-item" @click="openInNewTab(contextMenu.path)">
                    <i class="bi bi-box-arrow-up-right"></i>
                    <span>在新标签页打开</span>
                </div>
                <div class="context-menu-item" @click="copyPath(contextMenu.path)">
                    <i class="bi bi-clipboard"></i>
                    <span>复制路径</span>
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" @click="refreshFolder">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>刷新</span>
                </div>
            </template>
            <template v-if="contextMenu.type === 'file'">
                <div v-if="!contextMenu.file.isFolder && canPreview(contextMenu.file)"
                     class="context-menu-item" @click="previewFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-eye"></i>
                    <span>预览</span>
                </div>
                <div v-if="contextMenu.file.isFolder"
                     class="context-menu-item" @click="handleFileClick(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-folder-open"></i>
                    <span>打开</span>
                </div>
                <div v-if="contextMenu.file.isFolder"
                     class="context-menu-item" @click="calculateFolderSize(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-hdd"></i>
                    <span>计算大小</span>
                </div>
                <div v-if="!contextMenu.file.isFolder"
                     class="context-menu-item" @click="downloadFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-download"></i>
                    <span>下载</span>
                </div>
                <div v-if="!contextMenu.file.isFolder"
                     class="context-menu-item" @click="shareFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-share"></i>
                    <span>生成分享链接</span>
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" @click="renameFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-pencil"></i>
                    <span>重命名</span>
                </div>
                <div class="context-menu-item" @click="copyFileName(contextMenu.file)">
                    <i class="bi bi-clipboard"></i>
                    <span>复制名称</span>
                </div>
                <div class="context-menu-item" @click="copyFilePath(contextMenu.file)">
                    <i class="bi bi-link-45deg"></i>
                    <span>复制完整路径</span>
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" @click="singleFileMove(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-folder-symlink"></i>
                    <span>移动到...</span>
                </div>
                <div v-if="!contextMenu.file.isFolder" class="context-menu-item" @click="singleFileCopy(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-files"></i>
                    <span>复制到...</span>
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item danger" @click="deleteFile(contextMenu.file); hideContextMenu()">
                    <i class="bi bi-trash"></i>
                    <span>删除</span>
                </div>
            </template>
        </div>
    </div>

    <!-- Vue 3 -->
    <!-- Vue 3 - jsDelivr (主CDN) with Unpkg fallback -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"
            onerror="this.onerror=null;this.src='https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js'"></script>

    <!-- Axios - jsDelivr (主CDN) with Unpkg fallback -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"
            onerror="this.onerror=null;this.src='https://unpkg.com/axios@1.6.7/dist/axios.min.js'"></script>

    <!-- Optimized Loader - v2 API优化加载器 -->
    <script src="/js/optimized-loader.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    viewMode: 'grid', // 'list' 或 'grid'
                    buckets: [],
                    currentBucket: '',
                    currentPath: '',
                    files: [],
                    selectedFile: null,
                    loading: false,
                    searchKeyword: '',
                    showUploadDialog: false,
                    showCreateFolderDialog: false,
                    uploadMode: 'file', // 'file' 或 'folder'
                    uploadFiles: [],
                    uploadFilesList: [], // 上传队列，包含路径信息
                    folderName: '',
                    toasts: [],
                    toastId: 0,
                    showPreviewDialog: false,
                    currentPreviewFile: null,
                    previewLoading: false,
                    previewUrl: '',
                    previewContent: '',
                    renderedMarkdown: '',
                    highlightedCode: '',
                    showDeleteDialog: false,
                    fileToDelete: null,
                    showBatchDeleteDialog: false,
                    showRenameDialog: false,
                    fileToRename: null,
                    newFileName: '',
                    showAdvancedFilters: false,
                    filters: {
                        fileType: '',
                        startDate: '',
                        endDate: ''
                    },
                    // 自定义下拉框状态
                    fileTypeDropdownOpen: false,
                    fileTypeOptions: [
                        { value: '', label: '全部类型', emoji: '📋' },
                        { value: 'folder', label: '文件夹', emoji: '📁' },
                        { value: 'image', label: '图片', emoji: '🖼️' },
                        { value: 'video', label: '视频', emoji: '🎬' },
                        { value: 'audio', label: '音频', emoji: '🎵' },
                        { value: 'document', label: '文档', emoji: '📄' },
                        { value: 'archive', label: '压缩包', emoji: '📦' },
                        { value: 'code', label: '代码', emoji: '💻' },
                        { value: 'other', label: '其他', emoji: '📋' }
                    ],
                    // 自定义日期选择器状态
                    startDatePickerOpen: false,
                    endDatePickerOpen: false,
                    startCalendarYear: new Date().getFullYear(),
                    startCalendarMonth: new Date().getMonth() + 1,
                    endCalendarYear: new Date().getFullYear(),
                    endCalendarMonth: new Date().getMonth() + 1,
                    currentPage: 1,
                    pageSize: 50,
                    // 后端分页相关
                    totalFiles: 0,
                    hasMorePages: false,
                    continuationToken: null,
                    pageTokens: [], // 存储每一页的 token，用于前后翻页
                    cachedFolders: [], // 缓存当前路径下的所有文件夹（文件夹通常不多，全部显示）
                    uploadProgress: {
                        show: false,
                        fileName: '',
                        loaded: 0,
                        total: 0,
                        percent: 0,
                        remainingTime: '计算中...'
                    },
                    // 上传队列
                    uploadQueue: [],
                    showUploadQueue: false,
                    // 保存的筛选条件
                    savedFilters: [],
                    showSaveFilterDialog: false,
                    filterName: '',
                    contextMenu: {
                        show: false,
                        type: '', // 'breadcrumb' or 'file'
                        x: 0,
                        y: 0,
                        path: '',
                        file: null
                    },
                    showShareDialog: false,
                    fileToShare: null,
                    shareExpiration: '3600', // 默认1小时
                    shareUrl: '',
                    shareExpiresAt: null,
                    // 图片控制
                    imageZoom: 1,
                    imageRotation: 0,
                    imageCompression: false,
                    compressedImageUrl: '',
                    // Excel/CSV 表格数据
                    excelSheets: [],
                    currentSheetIndex: 0,
                    // 视频播放控制
                    videoPlaybackRate: 1.0,
                    videoVolume: 1.0,
                    // PDF 预览控制
                    pdfDoc: null,
                    pdfCurrentPage: 1,
                    pdfTotalPages: 0,
                    pdfScale: 1.5,
                    // 文件夹大小缓存
                    folderSizes: {},
                    // 侧边栏宽度
                    sidebarWidth: 256, // 默认256px
                    isResizingSidebar: false,
                    resizeStartX: 0,
                    resizeStartWidth: 0,
                    // 选中的文件
                    selectedFiles: new Set(),
                    // 批量操作模式
                    batchMode: false,
                    // 用于 Shift 多选
                    lastClickedIndex: -1,
                    // 批量移动对话框
                    showBatchMoveDialog: false,
                    folderTree: [],
                    selectedTargetFolder: '',
                    loadingFolders: false,
                    expandedFolders: new Set(),
                    loadingSubFolders: new Set(), // 正在加载子文件夹的路径
                    moveProgress: {
                        show: false,
                        current: 0,
                        total: 0,
                        currentFile: '',
                        succeeded: 0,
                        failed: 0
                    },
                    // 批量复制到其他Bucket对话框
                    showBatchCopyDialog: false,
                    copyStep: 1, // 1: 确认文件, 2: 选择Bucket
                    selectedTargetBucket: '',
                    targetBuckets: [],
                    keepPathStructure: true,
                    copyProgress: {
                        show: false,
                        current: 0,
                        total: 0,
                        currentFile: '',
                        succeeded: 0,
                        failed: 0
                    },
                    // V2 API 优化相关（来自OptimizedLoader）
                    allItems: [],              // 所有已加载的项目（用于无限滚动）
                    loadingMore: false,       // 是否正在加载更多
                    hasMore: true,            // 是否还有更多数据
                    useV2API: true            // 使用v2 API
                }
            },
            computed: {
                // 年份选项（前后各10年）
                yearOptions() {
                    const currentYear = new Date().getFullYear();
                    const years = [];
                    for (let i = currentYear - 10; i <= currentYear + 10; i++) {
                        years.push(i);
                    }
                    return years;
                },
                pathParts() {
                    if (!this.currentPath) return [];
                    return this.currentPath.split('/').filter(part => part);
                },
                filteredFiles() {
                    let result = [...this.files];

                    // 关键词搜索
                    if (this.searchKeyword.trim()) {
                        const keyword = this.searchKeyword.toLowerCase();
                        result = result.filter(f => f.name.toLowerCase().includes(keyword));
                    }

                    // 文件类型筛选
                    if (this.filters.fileType) {
                        result = result.filter(f => this.matchesFileType(f, this.filters.fileType));
                    }

                    // 时间范围筛选
                    if (this.filters.startDate || this.filters.endDate) {
                        result = result.filter(f => this.matchesDateRange(f));
                    }

                    return result;
                },
                hasActiveFilters() {
                    return !!(this.filters.fileType || this.filters.startDate || this.filters.endDate);
                },
                activeFilterCount() {
                    let count = 0;
                    if (this.filters.fileType) count++;
                    if (this.filters.startDate || this.filters.endDate) count++;
                    return count;
                },
                sortedFiles() {
                    // 后端分页：直接返回筛选后的文件，不再做前端排序
                    return this.filteredFiles;
                },
                displayFiles() {
                    // v2 API混合返回所有项目（文件夹已排在前面），直接显示
                    return this.files;
                },
                foldersCount() {
                    return this.cachedFolders.length;
                },
                filesCount() {
                    return this.files.filter(f => !f.isFolder).length;
                },
                totalPages() {
                    // 后端分页：总页数不确定，使用 hasMorePages 判断
                    return this.hasMorePages ? this.currentPage + 1 : this.currentPage;
                },
                displayImageUrl() {
                    return this.imageCompression && this.compressedImageUrl ? this.compressedImageUrl : this.previewUrl;
                },
                hasSelectedFiles() {
                    return this.selectedFiles.size > 0;
                },
                selectedFilesCount() {
                    return this.selectedFiles.size;
                },
                selectedFilesList() {
                    return this.files.filter(f => this.selectedFiles.has(f.key));
                }
            },
            watch: {
                // 监听批量模式切换
                batchMode(newVal) {
                    if (!newVal) {
                        // 关闭批量模式时清空选择
                        this.clearSelection();
                    }
                }
            },
            directives: {
                // 点击外部关闭指令
                clickOutside: {
                    mounted(el, binding) {
                        el.clickOutsideEvent = function(event) {
                            if (!(el === event.target || el.contains(event.target))) {
                                binding.value();
                            }
                        };
                        document.addEventListener('click', el.clickOutsideEvent);
                    },
                    unmounted(el) {
                        document.removeEventListener('click', el.clickOutsideEvent);
                    }
                }
            },
            mounted() {
                this.checkConfigAndLoad();

                // 初始化V2 API优化功能
                if (this.useV2API) {
                    this.initV2API();
                }

                // 点击其他地方隐藏右键菜单
                document.addEventListener('click', () => {
                    this.contextMenu.show = false;
                });
                // 初始化图片懒加载
                this.initLazyLoading();
                // 加载保存的侧边栏宽度
                const savedWidth = localStorage.getItem('sidebarWidth');
                if (savedWidth) {
                    this.sidebarWidth = parseInt(savedWidth);
                }
                // 加载保存的筛选条件
                this.loadSavedFilters();
            },
            beforeUnmount() {
                document.removeEventListener('mousemove', this.handleResizeSidebar);
                document.removeEventListener('mouseup', this.stopResizeSidebar);
            },
            methods: {
                goToConfig() {
                    window.location.href = 'config.html';
                },
                // 自定义下拉框方法
                getFileTypeLabel(value) {
                    const option = this.fileTypeOptions.find(opt => opt.value === value);
                    return option ? `${option.emoji} ${option.label}` : '📋 全部类型';
                },
                selectFileType(value) {
                    this.filters.fileType = value;
                    this.fileTypeDropdownOpen = false;
                },
                // 日历方法
                formatDisplayDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                },
                changeStartMonth(delta) {
                    this.startCalendarMonth += delta;
                    if (this.startCalendarMonth > 12) {
                        this.startCalendarMonth = 1;
                        this.startCalendarYear++;
                    } else if (this.startCalendarMonth < 1) {
                        this.startCalendarMonth = 12;
                        this.startCalendarYear--;
                    }
                },
                changeEndMonth(delta) {
                    this.endCalendarMonth += delta;
                    if (this.endCalendarMonth > 12) {
                        this.endCalendarMonth = 1;
                        this.endCalendarYear++;
                    } else if (this.endCalendarMonth < 1) {
                        this.endCalendarMonth = 12;
                        this.endCalendarYear--;
                    }
                },
                getStartCalendarDates() {
                    return this.getCalendarDates(this.startCalendarYear, this.startCalendarMonth, this.filters.startDate);
                },
                getEndCalendarDates() {
                    return this.getCalendarDates(this.endCalendarYear, this.endCalendarMonth, this.filters.endDate);
                },
                getCalendarDates(year, month, selectedDate) {
                    const firstDay = new Date(year, month - 1, 1);
                    const lastDay = new Date(year, month, 0);
                    const startWeekday = firstDay.getDay();
                    const daysInMonth = lastDay.getDate();

                    const dates = [];
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // 上个月的日期（填充）
                    const prevMonthLastDay = new Date(year, month - 1, 0).getDate();
                    for (let i = startWeekday - 1; i >= 0; i--) {
                        dates.push({
                            day: prevMonthLastDay - i,
                            isCurrentMonth: false,
                            isToday: false,
                            isSelected: false,
                            key: `prev-${prevMonthLastDay - i}`
                        });
                    }

                    // 当月日期
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month - 1, day);
                        date.setHours(0, 0, 0, 0);
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                        dates.push({
                            day,
                            isCurrentMonth: true,
                            isToday: date.getTime() === today.getTime(),
                            isSelected: dateStr === selectedDate,
                            dateStr,
                            key: `current-${day}`
                        });
                    }

                    // 下个月的日期（填充到42个格子）
                    const remainingCells = 42 - dates.length;
                    for (let day = 1; day <= remainingCells; day++) {
                        dates.push({
                            day,
                            isCurrentMonth: false,
                            isToday: false,
                            isSelected: false,
                            key: `next-${day}`
                        });
                    }

                    return dates;
                },
                selectStartDate(date) {
                    if (!date.isCurrentMonth) return;
                    this.filters.startDate = date.dateStr;
                    this.startDatePickerOpen = false;
                },
                selectEndDate(date) {
                    if (!date.isCurrentMonth) return;
                    this.filters.endDate = date.dateStr;
                    this.endDatePickerOpen = false;
                },
                setStartToday() {
                    const today = new Date();
                    this.filters.startDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    this.startDatePickerOpen = false;
                },
                setEndToday() {
                    const today = new Date();
                    this.filters.endDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    this.endDatePickerOpen = false;
                },
                clearStartDate() {
                    this.filters.startDate = '';
                    this.startDatePickerOpen = false;
                },
                clearEndDate() {
                    this.filters.endDate = '';
                    this.endDatePickerOpen = false;
                },
                // 检查配置并加载
                async checkConfigAndLoad() {
                    try {
                        await this.loadBuckets();
                    } catch (error) {
                        // 如果加载失败，检查是否是配置问题
                        this.handleConfigError(error);
                    }
                },
                // 处理配置错误
                handleConfigError(error) {
                    const errorMsg = error.message || error.toString();
                    // 检查是否是配置相关的错误
                    const configErrors = [
                        '存储后端不存在',
                        '未配置默认存储后端',
                        '存储后端未启用',
                        'Access Key',
                        'credentials',
                        'authentication',
                        '认证失败',
                        '配置'
                    ];

                    const isConfigError = configErrors.some(keyword =>
                        errorMsg.toLowerCase().includes(keyword.toLowerCase())
                    );

                    if (isConfigError) {
                        console.log('检测到配置错误，跳转到配置页面');
                        this.showToast('error', '请先配置 S3 连接信息');
                        setTimeout(() => {
                            window.location.href = 'config.html';
                        }, 1500);
                    }
                },
                async loadBuckets() {
                    try {
                        const response = await axios.get('/api/storage/buckets');
                        if (response.data.success) {
                            this.buckets = response.data.data;
                            if (this.buckets.length > 0 && !this.currentBucket) {
                                const savedBucket = localStorage.getItem('currentBucket');
                                if (savedBucket && this.buckets.includes(savedBucket)) {
                                    this.currentBucket = savedBucket;
                                } else {
                                    this.currentBucket = this.buckets[0];
                                }
                                await this.loadFiles();
                            }
                        } else {
                            // 后端返回失败
                            throw new Error(response.data.message || '加载失败');
                        }
                    } catch (error) {
                        console.error('加载存储桶失败:', error);

                        // 检查是否是配置错误
                        if (error.response) {
                            const errorMsg = error.response.data?.message || error.message;
                            throw new Error(errorMsg);
                        } else {
                            this.showToast('error', '无法连接到服务器');
                            throw error;
                        }
                    }
                },
                async selectBucket(bucket) {
                    this.currentBucket = bucket;
                    localStorage.setItem('currentBucket', bucket);
                    this.currentPath = '';
                    // 重置分页和文件夹缓存
                    this.currentPage = 1;
                    this.pageTokens = [];
                    this.hasMorePages = false;
                    this.cachedFolders = [];
                    // 重置所有筛选条件
                    this.filters.fileType = '';
                    this.filters.startDate = '';
                    this.filters.endDate = '';
                    this.searchKeyword = '';
                    this.showAdvancedFilters = false;
                    // 重置日历状态
                    const today = new Date();
                    this.startCalendarYear = today.getFullYear();
                    this.startCalendarMonth = today.getMonth() + 1;
                    this.endCalendarYear = today.getFullYear();
                    this.endCalendarMonth = today.getMonth() + 1;
                    await this.loadFiles(1);
                },
                async loadFiles(pageNum = 1) {
                    if (!this.currentBucket) return;
                    this.loading = true;
                    try {
                        // 第一次加载：先获取所有文件夹（不分页）
                        if (pageNum === 1) {
                            await this.loadAllFolders();
                        }

                        // 然后加载文件（分页）
                        await this.loadPagedFiles(pageNum);

                    } catch (error) {
                        console.error('加载文件列表失败:', error);
                        const errorMsg = error.response?.data?.message || error.message;
                        this.handleConfigError({ message: errorMsg });
                        this.showToast('error', '无法加载文件列表');
                    } finally {
                        this.loading = false;
                    }
                },
                // 加载所有文件夹（不分页）
                async loadAllFolders() {
                    try {
                        this.cachedFolders = [];

                        // 请求只获取文件夹，不要文件
                        const requestData = {
                            bucketName: this.currentBucket,
                            prefix: this.currentPath,
                            delimiter: '/',
                            pageSize: 1000  // 文件夹通常很少，一次获取足够
                        };

                        const response = await axios.post('/api/storage/files/list', requestData);
                        if (response.data.success) {
                            const data = response.data.data;
                            const folders = [];

                            // 只处理文件夹
                            if (data.folders && data.folders.length > 0) {
                                data.folders.forEach(folder => {
                                    folders.push({
                                        key: folder.key,
                                        name: folder.name,
                                        isFolder: true,
                                        size: 0,
                                        lastModified: new Date()
                                    });
                                });
                            }

                            this.cachedFolders = folders;
                        }
                    } catch (error) {
                        console.error('加载文件夹失败:', error);
                        this.cachedFolders = [];
                    }
                },
                // 加载文件（分页）
                async loadPagedFiles(pageNum) {
                    // 获取对应页码的 continuationToken
                    let token = null;
                    if (pageNum > 1 && this.pageTokens[pageNum - 2]) {
                        token = this.pageTokens[pageNum - 2];
                    }

                    const requestData = {
                        bucketName: this.currentBucket,
                        prefix: this.currentPath,
                        delimiter: '/',
                        pageSize: this.pageSize, // 50
                        continuationToken: token
                    };

                    const response = await axios.post('/api/storage/files/list', requestData);
                    if (response.data.success) {
                        const data = response.data.data;
                        const files = [];

                        // 只处理文件
                        if (data.files && data.files.length > 0) {
                            data.files.forEach(file => {
                                let fileName = file.key;
                                if (this.currentPath && fileName.startsWith(this.currentPath)) {
                                    fileName = fileName.substring(this.currentPath.length);
                                }
                                if (fileName.startsWith('/')) {
                                    fileName = fileName.substring(1);
                                }
                                if (fileName && !fileName.includes('/')) {
                                    files.push({
                                        key: file.key,
                                        name: fileName,
                                        size: file.size || 0,
                                        lastModified: file.lastModified,
                                        storageClass: file.storageClass,
                                        isFolder: false
                                    });
                                }
                            });
                        }

                        // 合并：所有文件夹 + 当前页文件
                        this.files = [...this.cachedFolders, ...files];
                        this.totalFiles = this.files.length;

                        // 处理分页信息
                        if (data.pagination) {
                            this.hasMorePages = data.pagination.hasMore || false;
                            const nextToken = data.pagination.nextContinuationToken;

                            // 保存下一页的 token
                            if (nextToken && pageNum === this.currentPage) {
                                this.pageTokens[pageNum] = nextToken;
                            }
                        } else {
                            this.hasMorePages = false;
                        }
                    }
                },
                navigateToPath(path) {
                    this.currentPath = path;
                    // 重置分页和文件夹缓存
                    this.currentPage = 1;
                    this.pageTokens = [];
                    this.hasMorePages = false;
                    this.cachedFolders = [];
                    this.loadFiles(1);
                },
                getPathUpTo(index) {
                    const parts = this.currentPath.split('/').filter(part => part);
                    if (index >= 0 && index < parts.length) {
                        return parts.slice(0, index + 1).join('/') + '/';
                    }
                    return '';
                },

                // ==================== V2 API 优化方法（来自OptimizedLoader）====================
                /**
                 * 加载文件列表（优化版 - v2 API）
                 * @param {boolean} reset - 是否重置列表
                 */
                async loadFilesV2(reset = true, bypassCache = false) {
                    if (!this.currentBucket) {
                        console.warn('未选择bucket');
                        return;
                    }

                    // 重置加载
                    if (reset) {
                        this.allItems = [];
                        this.continuationToken = null;
                        this.hasMore = true;
                    }

                    // 防止重复加载
                    if (this.loading || this.loadingMore || !this.hasMore) {
                        return;
                    }

                    const isInitialLoad = this.allItems.length === 0;
                    if (isInitialLoad) {
                        this.loading = true;
                    } else {
                        this.loadingMore = true;
                    }

                    try {
                        // 构建请求参数
                        const params = new URLSearchParams({
                            bucket: this.currentBucket,
                            prefix: this.currentPath || '',
                            pageSize: 100
                        });

                        if (this.continuationToken) {
                            params.append('continuationToken', this.continuationToken);
                        }

                        // 添加时间戳绕过缓存（用于上传/删除后刷新）
                        if (bypassCache) {
                            params.append('_t', Date.now());
                        }

                        console.log(`🔄 加载文件: ${this.currentPath || '/'} (reset=${reset}, token=${this.continuationToken ? 'yes' : 'no'}, bypassCache=${bypassCache})`);

                        const response = await axios.get(`/api/storage/v2/list?${params}`);

                        if (response.data.success) {
                            const data = response.data.data;

                            // 显示缓存来源
                            const cacheMsg = data.fromCache ? '✅ Caffeine缓存' : '💾 S3';
                            console.log(`来自: ${cacheMsg}`);

                            // 追加新数据
                            const newItems = data.items || [];
                            this.allItems.push(...newItems);
                            console.log(`✅ 加载了 ${newItems.length} 项，总计 ${this.allItems.length} 项`);

                            // 更新分页状态
                            this.continuationToken = data.nextContinuationToken;
                            this.hasMore = data.isTruncated || false;

                            if (this.hasMore) {
                                console.log('📄 还有更多数据');
                            } else {
                                console.log('✔️ 已加载全部数据');
                            }

                            // 更新显示
                            this.updateDisplayFiles();

                        } else {
                            console.error('❌ API返回错误:', response.data.message);
                            this.showToast('error', response.data.message || '加载失败');
                        }

                    } catch (error) {
                        console.error('❌ 加载失败:', error);
                        this.handleConfigError({ message: error.message });
                        this.showToast('error', '无法加载文件列表: ' + error.message);
                    } finally {
                        this.loading = false;
                        this.loadingMore = false;
                    }
                },

                /**
                 * 更新显示的文件列表
                 */
                updateDisplayFiles() {
                    // 转换为旧格式（兼容现有filteredFiles计算属性）
                    this.files = this.allItems.map(item => {
                        const isFolder = item.type === 'folder' || item.folder === true;
                        return {
                            key: item.key,
                            name: item.name,
                            size: item.size || 0,
                            lastModified: item.lastModified,
                            isFolder: isFolder,
                            folderStats: item.folderStats,
                            // 保留原有字段
                            storageClass: item.storageClass
                        };
                    });

                    this.totalFiles = this.files.length;
                    const folderCount = this.files.filter(f => f.isFolder).length;
                    const fileCount = this.files.filter(f => !f.isFolder).length;
                    console.log(`📊 显示 ${this.files.length} 项 (📁${folderCount} 文件夹 + 📄${fileCount} 文件)`);
                },

                /**
                 * 导航到指定路径（v2版本）
                 */
                navigateToPathV2(path) {
                    console.log(`🧭 导航到: ${path || '/'}`);
                    this.currentPath = path;
                    this.loadFilesV2(true); // 重置并重新加载
                },

                /**
                 * 设置无限滚动
                 */
                setupInfiniteScrollV2() {
                    // 主文件列表容器：<div class="flex-1 overflow-y-auto scrollbar-thin p-8">
                    // 需要在$nextTick后查找，确保DOM已渲染
                    this.$nextTick(() => {
                        // 查找主内容区的滚动容器
                        const allScrollContainers = document.querySelectorAll('.overflow-y-auto');

                        // 找到包含文件列表的那个（通常是最大的，包含p-8类）
                        let container = null;
                        for (const el of allScrollContainers) {
                            if (el.classList.contains('p-8') || el.classList.contains('scrollbar-thin')) {
                                // 检查是否包含文件列表元素
                                if (el.querySelector('[v-for]') || el.textContent.includes('加载中') || el.textContent.includes('未找到文件')) {
                                    container = el;
                                    break;
                                }
                            }
                        }

                        if (!container) {
                            console.warn('⚠️ 找不到文件列表容器，无限滚动未启用');
                            console.log('提示：查找的容器应包含 overflow-y-auto 和 p-8 类');
                            return;
                        }

                        console.log('✅ 无限滚动已启用，容器:', container.className);

                        // 节流滚动事件
                        let scrollTimeout = null;
                        let lastScrollTop = 0;

                        const scrollHandler = () => {
                            if (scrollTimeout) clearTimeout(scrollTimeout);

                            scrollTimeout = setTimeout(() => {
                                const { scrollTop, scrollHeight, clientHeight } = container;

                                // 只在向下滚动时触发
                                if (scrollTop < lastScrollTop) {
                                    lastScrollTop = scrollTop;
                                    return;
                                }
                                lastScrollTop = scrollTop;

                                const distanceToBottom = scrollHeight - scrollTop - clientHeight;

                                // 距离底部300px时触发加载
                                if (distanceToBottom < 300 && this.hasMore && !this.loadingMore && !this.loading) {
                                    console.log('🔻 触发无限滚动加载 (距底部 ' + Math.round(distanceToBottom) + 'px)');
                                    this.loadFilesV2(false); // false = 不重置，追加加载
                                }
                            }, 150);
                        };

                        container.addEventListener('scroll', scrollHandler);
                        console.log('👂 监听滚动事件');

                        // 保存清理函数引用
                        this._scrollCleanup = () => {
                            container.removeEventListener('scroll', scrollHandler);
                            console.log('🔇 移除滚动监听');
                        };
                    });
                },

                /**
                 * 切换bucket（v2版本）
                 */
                async selectBucketV2(bucket) {
                    console.log(`🪣 切换bucket: ${bucket}`);
                    this.currentBucket = bucket;
                    localStorage.setItem('currentBucket', bucket);
                    this.currentPath = '';

                    // 重置所有筛选条件
                    this.filters.fileType = '';
                    this.filters.startDate = '';
                    this.filters.endDate = '';
                    this.searchKeyword = '';
                    this.showAdvancedFilters = false;

                    // 重置日历状态
                    const today = new Date();
                    this.startCalendarYear = today.getFullYear();
                    this.startCalendarMonth = today.getMonth() + 1;
                    this.endCalendarYear = today.getFullYear();
                    this.endCalendarMonth = today.getMonth() + 1;

                    await this.loadFilesV2(true);
                },

                /**
                 * 刷新当前目录（v2版本）
                 */
                async refreshV2() {
                    console.log('🔄 刷新当前目录');
                    await this.loadFilesV2(true);
                },

                /**
                 * 清除缓存并刷新（用于上传/删除后）
                 */
                async clearCacheAndRefresh() {
                    try {
                        // 调用后端清除缓存接口
                        await axios.delete('/api/storage/v2/cache');
                        console.log('🗑️ 缓存已清除');
                        // 等待100ms确保缓存清除完成
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (error) {
                        console.warn('清除缓存失败:', error);
                    }
                    // 强制刷新列表（重置状态并绕过缓存）
                    this.allItems = [];
                    this.continuationToken = null;
                    this.hasMore = true;
                    await this.loadFilesV2(true, true);  // 第二个参数true表示绕过缓存
                },

                /**
                 * 清除所有缓存并刷新
                 */
                async clearAllCaches() {
                    try {
                        this.showToast('info', '正在清除缓存...', '清除缓存');

                        // 1. 清除后端Caffeine缓存
                        try {
                            await axios.delete('/api/storage/v2/cache');
                            console.log('✅ 后端缓存已清除');
                        } catch (error) {
                            console.warn('清除后端缓存失败:', error);
                        }

                        // 2. 清除Service Worker浏览器缓存
                        if ('serviceWorker' in navigator) {
                            try {
                                const registration = await navigator.serviceWorker.ready;
                                const messageChannel = new MessageChannel();

                                const swPromise = new Promise((resolve, reject) => {
                                    messageChannel.port1.onmessage = (event) => {
                                        if (event.data.success) {
                                            resolve();
                                        } else {
                                            reject(new Error('清除失败'));
                                        }
                                    };
                                    setTimeout(() => reject(new Error('超时')), 3000);
                                });

                                registration.active.postMessage({
                                    type: 'CLEAR_CACHE'
                                }, [messageChannel.port2]);

                                await swPromise;
                                console.log('✅ 浏览器缓存已清除');
                            } catch (error) {
                                console.warn('清除浏览器缓存失败:', error);
                            }
                        }

                        // 3. 等待缓存清除完成
                        await new Promise(resolve => setTimeout(resolve, 100));

                        // 4. 刷新列表
                        this.allItems = [];
                        this.continuationToken = null;
                        this.hasMore = true;
                        await this.loadFilesV2(true, true);  // 绕过缓存

                        this.showToast('success', '缓存已清除，列表已刷新', '清除成功');
                    } catch (error) {
                        console.error('清除缓存失败:', error);
                        this.showToast('error', '清除缓存失败: ' + error.message, '清除失败');
                    }
                },

                /**
                 * 初始化V2 API
                 */
                initV2API() {
                    console.log('🚀 初始化优化API (v2)');

                    // 替换方法
                    this.loadFiles = this.loadFilesV2;
                    this.navigateToPath = this.navigateToPathV2;
                    this.selectBucket = this.selectBucketV2;
                    this.refresh = this.refreshV2;

                    // 设置无限滚动（内部已有$nextTick）
                    this.setupInfiniteScrollV2();

                    console.log('✅ V2 API 初始化完成');
                },
                // ==================== V2 API 优化方法结束 ====================

                // 分页导航方法
                async goToFirstPage() {
                    if (this.currentPage === 1) return;
                    this.currentPage = 1;
                    await this.loadFiles(1);
                },
                async goToPrevPage() {
                    if (this.currentPage <= 1) return;
                    this.currentPage--;
                    await this.loadFiles(this.currentPage);
                },
                async goToNextPage() {
                    if (!this.hasMorePages) return;
                    this.currentPage++;
                    await this.loadFiles(this.currentPage);
                },
                handleFileClick(file) {
                    if (file.isFolder) {
                        this.navigateToPath(file.key);
                    } else {
                        this.selectedFile = file;
                    }
                },
                handleSearch() {
                    // Search handled by computed property
                },
                handleFileSelect(event) {
                    this.uploadFiles = Array.from(event.target.files);
                    this.uploadFilesList = Array.from(event.target.files).map(file => ({
                        file: file,
                        path: file.name,
                        relativePath: file.name
                    }));
                },
                handleFolderSelect(event) {
                    const files = Array.from(event.target.files);
                    this.uploadFiles = files;
                    this.uploadFilesList = files.map(file => ({
                        file: file,
                        path: file.webkitRelativePath || file.name,
                        relativePath: file.webkitRelativePath || file.name
                    }));
                },
                triggerFileInput() {
                    // 触发隐藏的文件输入框
                    if (this.uploadMode === 'file') {
                        this.$refs.fileInput.click();
                    } else {
                        this.$refs.folderInput.click();
                    }
                },
                async doUploadFiles() {
                    if (this.uploadFiles.length === 0) return;
                    this.showUploadDialog = false;

                    // 使用 uploadFilesList 来支持文件夹上传（保持目录结构）
                    const filesToUpload = this.uploadFilesList.length > 0 ? this.uploadFilesList :
                        this.uploadFiles.map(file => ({ file, relativePath: file.name }));

                    // 初始化上传队列
                    this.uploadQueue = filesToUpload.map((fileItem, index) => ({
                        id: Date.now() + index,
                        name: fileItem.file.name,
                        size: fileItem.file.size,
                        status: 'pending', // pending, uploading, completed, failed
                        percent: 0,
                        fileItem: fileItem
                    }));

                    this.showUploadQueue = true;

                    // 逐个上传文件
                    for (let queueItem of this.uploadQueue) {
                        try {
                            // 更新状态为上传中
                            queueItem.status = 'uploading';
                            queueItem.percent = 0;

                            const formData = new FormData();
                            formData.append('file', queueItem.fileItem.file);
                            formData.append('bucketName', this.currentBucket);

                            // 构建对象键：当前路径 + 文件相对路径（保持文件夹结构）
                            const objectKey = this.currentPath + queueItem.fileItem.relativePath;
                            formData.append('objectKey', objectKey);

                            const response = await axios.post('/api/storage/upload', formData, {
                                headers: { 'Content-Type': 'multipart/form-data' },
                                onUploadProgress: (progressEvent) => {
                                    queueItem.percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                                }
                            });

                            if (response.data.success) {
                                queueItem.status = 'completed';
                            } else {
                                queueItem.status = 'failed';
                            }
                        } catch (error) {
                            console.error(`上传失败: ${queueItem.name}`, error);
                            queueItem.status = 'failed';
                        }
                    }

                    // 所有上传完成后显示统计
                    const successCount = this.uploadQueue.filter(f => f.status === 'completed').length;
                    const failCount = this.uploadQueue.filter(f => f.status === 'failed').length;

                    if (failCount > 0) {
                        this.showToast('warning', `成功 ${successCount} 个，失败 ${failCount} 个`, '上传完成');
                    } else {
                        this.showToast('success', `已成功上传 ${successCount} 个文件`, '上传完成');
                    }

                    this.uploadFiles = [];
                    this.uploadFilesList = [];

                    // 清除缓存并刷新列表
                    if (this.useV2API) {
                        await this.clearCacheAndRefresh();
                    } else {
                        await this.loadFiles();
                    }

                    // 3秒后自动关闭队列窗口
                    setTimeout(() => {
                        if (this.uploadQueue.every(f => f.status === 'completed' || f.status === 'failed')) {
                            this.showUploadQueue = false;
                            this.uploadQueue = [];
                        }
                    }, 3000);
                },
                async downloadFile(file) {
                    try {
                        const url = `/api/storage/download?bucketName=${encodeURIComponent(this.currentBucket)}&objectKey=${encodeURIComponent(file.key)}`;
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = file.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch (error) {
                        console.error('下载文件失败:', error);
                        this.showToast('error', '下载文件失败');
                    }
                },
                deleteFile(file) {
                    this.fileToDelete = file;
                    this.showDeleteDialog = true;
                },
                async confirmDelete() {
                    if (!this.fileToDelete) return;
                    this.showDeleteDialog = false;
                    const fileToDelete = this.fileToDelete;
                    this.fileToDelete = null;

                    try {
                        const response = await axios.delete('/api/storage/files', {
                            params: {
                                bucketName: this.currentBucket,
                                objectKey: fileToDelete.key
                            }
                        });
                        if (response.data.success) {
                            this.showToast('success', '文件已删除', '删除成功');
                            // 清除缓存并刷新列表
                            if (this.useV2API) {
                                await this.clearCacheAndRefresh();
                            } else {
                                await this.loadFiles();
                            }
                        } else {
                            this.showToast('error', '删除失败: ' + response.data.message, '删除失败');
                        }
                    } catch (error) {
                        console.error('删除文件失败:', error);
                        this.showToast('error', '删除文件失败', '删除失败');
                    }
                },
                renameFile(file) {
                    this.fileToRename = file;
                    this.newFileName = file.name;
                    this.showRenameDialog = true;
                },
                async confirmRename() {
                    if (!this.fileToRename || !this.newFileName.trim()) return;

                    const oldName = this.fileToRename.name;
                    const newName = this.newFileName.trim();

                    if (oldName === newName) {
                        this.showToast('error', '新名称与原名称相同');
                        return;
                    }

                    this.showRenameDialog = false;
                    const fileToRename = this.fileToRename;
                    this.fileToRename = null;
                    this.newFileName = '';

                    try {
                        const oldKey = fileToRename.key;
                        let newKey;

                        if (fileToRename.isFolder) {
                            const parentPath = this.currentPath;
                            newKey = parentPath + newName + '/';
                        } else {
                            const lastSlash = oldKey.lastIndexOf('/');
                            const parentPath = lastSlash >= 0 ? oldKey.substring(0, lastSlash + 1) : '';
                            newKey = parentPath + newName;
                        }

                        const response = await axios.put('/api/storage/files/rename', null, {
                            params: {
                                bucketName: this.currentBucket,
                                oldKey: oldKey,
                                newKey: newKey
                            }
                        });

                        if (response.data.success) {
                            this.showToast('success', '重命名成功', '重命名成功');
                            // 清除缓存并刷新列表
                            if (this.useV2API) {
                                await this.clearCacheAndRefresh();
                            } else {
                                await this.loadFiles();
                            }
                        } else {
                            this.showToast('error', '重命名失败: ' + response.data.message, '重命名失败');
                        }
                    } catch (error) {
                        console.error('重命名文件失败:', error);
                        this.showToast('error', '重命名失败: ' + (error.response?.data?.message || error.message), '重命名失败');
                    }
                },
                async createFolder() {
                    if (!this.folderName.trim()) {
                        this.showToast('error', '请输入文件夹名称');
                        return;
                    }
                    try {
                        const folderPath = this.currentPath + this.folderName.trim() + '/';
                        const response = await axios.post('/api/storage/folder', null, {
                            params: {
                                bucketName: this.currentBucket,
                                folderPath: folderPath
                            }
                        });
                        if (response.data.success) {
                            this.showToast('success', '文件夹已创建', '创建成功');
                            this.showCreateFolderDialog = false;
                            this.folderName = '';
                            // 清除缓存并刷新列表
                            if (this.useV2API) {
                                await this.clearCacheAndRefresh();
                            } else {
                                await this.loadFiles();
                            }
                        } else {
                            this.showToast('error', '创建失败: ' + response.data.message, '创建失败');
                        }
                    } catch (error) {
                        console.error('创建文件夹失败:', error);
                        this.showToast('error', '创建文件夹失败', '创建失败');
                    }
                },
                getFileIcon(file) {
                    if (file.isFolder) {
                        return 'bi-folder-fill';
                    }
                    const ext = file.name.split('.').pop().toLowerCase();
                    const iconMap = {
                        'png': 'bi-file-image', 'jpg': 'bi-file-image', 'jpeg': 'bi-file-image', 'gif': 'bi-file-image', 'svg': 'bi-file-image',
                        'pdf': 'bi-file-pdf',
                        'doc': 'bi-file-word', 'docx': 'bi-file-word',
                        'xls': 'bi-file-excel', 'xlsx': 'bi-file-excel',
                        'ppt': 'bi-file-ppt', 'pptx': 'bi-file-ppt',
                        'zip': 'bi-file-zip', 'rar': 'bi-file-zip', '7z': 'bi-file-zip',
                        'mp4': 'bi-file-play', 'avi': 'bi-file-play', 'mov': 'bi-file-play',
                        'mp3': 'bi-file-music', 'wav': 'bi-file-music', 'flac': 'bi-file-music',
                        'txt': 'bi-file-text', 'md': 'bi-file-text',
                        'js': 'bi-file-code', 'ts': 'bi-file-code', 'html': 'bi-file-code',
                        'css': 'bi-file-code', 'json': 'bi-file-code', 'xml': 'bi-file-code'
                    };
                    return iconMap[ext] || 'bi-file-earmark';
                },
                getFileColor(file) {
                    if (file.isFolder) {
                        return 'text-blue-500';
                    }
                    const ext = file.name.split('.').pop().toLowerCase();
                    const colorMap = {
                        'png': 'text-green-500', 'jpg': 'text-green-500', 'jpeg': 'text-green-500', 'gif': 'text-green-500',
                        'pdf': 'text-red-500',
                        'doc': 'text-blue-500', 'docx': 'text-blue-500',
                        'xls': 'text-green-500', 'xlsx': 'text-green-500',
                        'zip': 'text-yellow-500', 'rar': 'text-yellow-500',
                        'mp4': 'text-purple-500', 'avi': 'text-purple-500',
                        'mp3': 'text-pink-500'
                    };
                    return colorMap[ext] || 'text-gray-500';
                },
                getFileTypeLabel(file) {
                    if (file.isFolder) {
                        return '';
                    }
                    const ext = file.name.split('.').pop().toLowerCase();
                    const typeMap = {
                        'png': '图片', 'jpg': '图片', 'jpeg': '图片', 'gif': '图片', 'svg': '图片', 'bmp': '图片', 'webp': '图片',
                        'pdf': 'PDF',
                        'doc': '文档', 'docx': '文档', 'txt': '文本', 'md': '文本',
                        'xls': '表格', 'xlsx': '表格', 'csv': '表格',
                        'ppt': '演示', 'pptx': '演示',
                        'zip': '压缩包', 'rar': '压缩包', '7z': '压缩包', 'tar': '压缩包', 'gz': '压缩包',
                        'mp4': '视频', 'avi': '视频', 'mov': '视频', 'wmv': '视频', 'flv': '视频', 'mkv': '视频',
                        'mp3': '音频', 'wav': '音频', 'flac': '音频', 'aac': '音频',
                        'js': '代码', 'ts': '代码', 'html': '代码', 'css': '代码', 'json': '代码', 'xml': '代码', 'java': '代码', 'py': '代码'
                    };
                    return typeMap[ext] || '文件';
                },
                getFileTypeBadgeClass(file) {
                    if (file.isFolder) {
                        return '';
                    }
                    const ext = file.name.split('.').pop().toLowerCase();
                    const classMap = {
                        'png': 'bg-green-100 text-green-700',
                        'jpg': 'bg-green-100 text-green-700',
                        'jpeg': 'bg-green-100 text-green-700',
                        'gif': 'bg-green-100 text-green-700',
                        'svg': 'bg-green-100 text-green-700',
                        'bmp': 'bg-green-100 text-green-700',
                        'webp': 'bg-green-100 text-green-700',
                        'pdf': 'bg-red-100 text-red-700',
                        'doc': 'bg-blue-100 text-blue-700',
                        'docx': 'bg-blue-100 text-blue-700',
                        'txt': 'bg-gray-100 text-gray-700',
                        'md': 'bg-gray-100 text-gray-700',
                        'xls': 'bg-emerald-100 text-emerald-700',
                        'xlsx': 'bg-emerald-100 text-emerald-700',
                        'csv': 'bg-emerald-100 text-emerald-700',
                        'ppt': 'bg-orange-100 text-orange-700',
                        'pptx': 'bg-orange-100 text-orange-700',
                        'zip': 'bg-yellow-100 text-yellow-700',
                        'rar': 'bg-yellow-100 text-yellow-700',
                        '7z': 'bg-yellow-100 text-yellow-700',
                        'tar': 'bg-yellow-100 text-yellow-700',
                        'gz': 'bg-yellow-100 text-yellow-700',
                        'mp4': 'bg-purple-100 text-purple-700',
                        'avi': 'bg-purple-100 text-purple-700',
                        'mov': 'bg-purple-100 text-purple-700',
                        'wmv': 'bg-purple-100 text-purple-700',
                        'flv': 'bg-purple-100 text-purple-700',
                        'mkv': 'bg-purple-100 text-purple-700',
                        'mp3': 'bg-pink-100 text-pink-700',
                        'wav': 'bg-pink-100 text-pink-700',
                        'flac': 'bg-pink-100 text-pink-700',
                        'aac': 'bg-pink-100 text-pink-700',
                        'js': 'bg-indigo-100 text-indigo-700',
                        'ts': 'bg-indigo-100 text-indigo-700',
                        'html': 'bg-indigo-100 text-indigo-700',
                        'css': 'bg-indigo-100 text-indigo-700',
                        'json': 'bg-indigo-100 text-indigo-700',
                        'xml': 'bg-indigo-100 text-indigo-700',
                        'java': 'bg-indigo-100 text-indigo-700',
                        'py': 'bg-indigo-100 text-indigo-700'
                    };
                    return classMap[ext] || 'bg-gray-100 text-gray-600';
                },
                shouldShowPath(file) {
                    // 如果在根目录，不显示路径
                    return this.currentPath !== '' && this.currentPath !== '/';
                },
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                escapeHtml(text) {
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    };
                    return text.replace(/[&<>"']/g, m => map[m]);
                },
                formatDate(date) {
                    if (!date) return '';
                    try {
                        return new Date(date).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch {
                        return '';
                    }
                },
                showToast(type, message, title = null) {
                    const id = this.toastId++;
                    // 根据类型自动设置默认标题
                    if (!title) {
                        title = type === 'success' ? '操作成功' :
                                type === 'error' ? '操作失败' :
                                '通知';
                    }
                    this.toasts.push({ id, type, message, title });
                    setTimeout(() => {
                        this.removeToast(id);
                    }, 5000);
                },
                removeToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index > -1) {
                        this.toasts.splice(index, 1);
                    }
                },
                canPreview(file) {
                    if (!file || file.isFolder) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const previewableTypes = [
                        'png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg',
                        'txt', 'md', 'json', 'xml', 'csv', 'log',
                        'js', 'ts', 'jsx', 'tsx', 'vue', 'html', 'css', 'scss', 'less',
                        'java', 'py', 'go', 'rs', 'c', 'cpp', 'h', 'hpp',
                        'yml', 'yaml', 'toml', 'ini', 'conf', 'properties',
                        'sh', 'bat', 'ps1', 'sql', 'pdf',
                        'mp4', 'webm', 'ogg', 'avi', 'mov', 'wmv', 'flv', 'mkv',
                        'mp3', 'wav', 'flac', 'aac', 'm4a', 'wma',
                        'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'
                    ];
                    return previewableTypes.includes(ext);
                },
                isImageFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'].includes(ext);
                },
                isTextFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const textTypes = [
                        'txt', 'md', 'json', 'xml', 'log',  // 移除 csv，csv 使用 Excel 预览
                        'js', 'ts', 'jsx', 'tsx', 'vue', 'html', 'css', 'scss', 'less',
                        'java', 'py', 'go', 'rs', 'c', 'cpp', 'h', 'hpp',
                        'yml', 'yaml', 'toml', 'ini', 'conf', 'properties',
                        'sh', 'bat', 'ps1', 'sql'
                    ];
                    return textTypes.includes(ext);
                },
                isPdfFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ext === 'pdf';
                },
                isVideoFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['mp4', 'webm', 'ogg', 'avi', 'mov', 'wmv', 'flv', 'mkv'].includes(ext);
                },
                isAudioFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg', 'wma'].includes(ext);
                },
                isMarkdownFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ext === 'md';
                },
                isCodeFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    const codeTypes = [
                        'js', 'ts', 'jsx', 'tsx', 'vue', 'html', 'css', 'scss', 'less',
                        'java', 'py', 'go', 'rs', 'c', 'cpp', 'h', 'hpp',
                        'json', 'xml', 'yml', 'yaml', 'toml', 'ini', 'conf', 'properties',
                        'sh', 'bat', 'ps1', 'sql'
                    ];
                    return codeTypes.includes(ext);
                },
                isOfficeFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    // Excel 文件单独处理，Office 文件只包含 Word 和 PowerPoint
                    return ['doc', 'docx', 'ppt', 'pptx'].includes(ext);
                },
                isExcelFile(file) {
                    if (!file) return false;
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['csv', 'xls', 'xlsx'].includes(ext);
                },
                getCodeLanguage(file) {
                    if (!file) return 'language-plaintext';
                    const ext = file.name.split('.').pop().toLowerCase();
                    const languageMap = {
                        'js': 'language-javascript',
                        'ts': 'language-typescript',
                        'jsx': 'language-javascript',
                        'tsx': 'language-typescript',
                        'vue': 'language-javascript',
                        'html': 'language-html',
                        'css': 'language-css',
                        'scss': 'language-scss',
                        'less': 'language-less',
                        'java': 'language-java',
                        'py': 'language-python',
                        'go': 'language-go',
                        'rs': 'language-rust',
                        'c': 'language-c',
                        'cpp': 'language-cpp',
                        'h': 'language-c',
                        'hpp': 'language-cpp',
                        'json': 'language-json',
                        'xml': 'language-xml',
                        'yml': 'language-yaml',
                        'yaml': 'language-yaml',
                        'toml': 'language-toml',
                        'ini': 'language-ini',
                        'conf': 'language-plaintext',
                        'properties': 'language-properties',
                        'sh': 'language-bash',
                        'bat': 'language-batch',
                        'ps1': 'language-powershell',
                        'sql': 'language-sql'
                    };
                    return languageMap[ext] || 'language-plaintext';
                },
                async previewFile(file) {
                    this.currentPreviewFile = file;
                    this.showPreviewDialog = true;
                    this.previewLoading = true;
                    this.previewUrl = '';
                    this.previewContent = '';
                    this.renderedMarkdown = '';
                    this.highlightedCode = '';
                    // 重置图片控制状态
                    this.imageZoom = 1;
                    this.imageRotation = 0;
                    this.imageCompression = false;
                    this.compressedImageUrl = '';
                    // 重置 Excel 数据
                    this.excelSheets = [];
                    this.currentSheetIndex = 0;
                    // 重置视频控制
                    this.videoPlaybackRate = 1.0;
                    this.videoVolume = 1.0;
                    // 重置 PDF 控制
                    this.pdfDoc = null;
                    this.pdfCurrentPage = 1;
                    this.pdfTotalPages = 0;
                    this.pdfScale = 1.5;

                    try {
                        const url = `/api/storage/download?bucketName=${encodeURIComponent(this.currentBucket)}&objectKey=${encodeURIComponent(file.key)}`;

                        if (this.isImageFile(file) || this.isVideoFile(file) || this.isAudioFile(file)) {
                            this.previewUrl = url;
                        } else if (this.isPdfFile(file)) {
                            // PDF 文件使用 PDF.js 渲染
                            await this.loadPdf(url);
                        } else if (this.isExcelFile(file)) {
                            // Excel/CSV 文件解析
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('加载文件失败');

                            const ext = file.name.split('.').pop().toLowerCase();

                            if (ext === 'csv') {
                                // CSV 文件解析
                                const text = await response.text();
                                const workbook = XLSX.read(text, { type: 'string' });
                                const sheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[sheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                                if (jsonData.length > 0) {
                                    this.excelSheets = [{
                                        name: sheetName,
                                        headers: jsonData[0],
                                        rows: jsonData.slice(1)
                                    }];
                                }
                            } else {
                                // Excel 文件解析
                                const arrayBuffer = await response.arrayBuffer();
                                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                                this.excelSheets = workbook.SheetNames.map(sheetName => {
                                    const worksheet = workbook.Sheets[sheetName];
                                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                                    return {
                                        name: sheetName,
                                        headers: jsonData.length > 0 ? jsonData[0] : [],
                                        rows: jsonData.length > 1 ? jsonData.slice(1) : []
                                    };
                                });
                            }
                        } else if (this.isMarkdownFile(file)) {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('加载文件失败');
                            const markdownText = await response.text();

                            // Configure marked for better rendering
                            marked.setOptions({
                                breaks: true,
                                gfm: true,
                                highlight: function(code, lang) {
                                    if (lang && hljs.getLanguage(lang)) {
                                        try {
                                            return hljs.highlight(code, { language: lang }).value;
                                        } catch (e) {
                                            console.error('Highlight error:', e);
                                        }
                                    }
                                    return hljs.highlightAuto(code).value;
                                }
                            });

                            this.renderedMarkdown = marked.parse(markdownText);
                        } else if (this.isCodeFile(file)) {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('加载文件失败');
                            const codeText = await response.text();

                            // Get language from file extension
                            const ext = file.name.split('.').pop().toLowerCase();
                            const langMap = {
                                'js': 'javascript', 'ts': 'typescript', 'jsx': 'javascript', 'tsx': 'typescript',
                                'py': 'python', 'java': 'java', 'go': 'go', 'rs': 'rust',
                                'c': 'c', 'cpp': 'cpp', 'h': 'c', 'hpp': 'cpp',
                                'html': 'html', 'css': 'css', 'scss': 'scss', 'less': 'less',
                                'json': 'json', 'xml': 'xml', 'yml': 'yaml', 'yaml': 'yaml',
                                'sh': 'bash', 'bat': 'batch', 'ps1': 'powershell', 'sql': 'sql'
                            };

                            const lang = langMap[ext] || 'plaintext';

                            // 检查 hljs 是否已加载
                            if (typeof hljs !== 'undefined') {
                                if (hljs.getLanguage(lang)) {
                                    this.highlightedCode = hljs.highlight(codeText, { language: lang }).value;
                                } else {
                                    this.highlightedCode = hljs.highlightAuto(codeText).value;
                                }
                            } else {
                                // hljs 未加载时使用纯文本显示
                                this.highlightedCode = this.escapeHtml(codeText);
                            }
                        } else if (this.isTextFile(file)) {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error('加载文件失败');
                            this.previewContent = await response.text();
                        }
                    } catch (error) {
                        console.error('预览文件失败:', error);
                        this.showToast('error', '预览文件失败');
                        this.closePreview();
                    } finally {
                        this.previewLoading = false;
                    }
                },
                closePreview() {
                    // 清理 PDF 资源
                    if (this.pdfDoc) {
                        try {
                            // PDF.js 2.x 使用 destroy 方法
                            if (typeof this.pdfDoc.destroy === 'function') {
                                this.pdfDoc.destroy();
                            }
                        } catch (e) {
                            console.warn('PDF 资源清理失败:', e);
                        }
                        this.pdfDoc = null;
                    }
                    this.pdfCurrentPage = 1;
                    this.pdfTotalPages = 0;

                    // 关闭对话框
                    this.showPreviewDialog = false;
                },
                matchesFileType(file, type) {
                    if (type === 'folder') return file.isFolder;
                    if (file.isFolder) return false;

                    const ext = file.name.split('.').pop().toLowerCase();
                    const typeMap = {
                        'image': ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'],
                        'video': ['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv', 'webm'],
                        'audio': ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg', 'wma'],
                        'document': ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'md'],
                        'archive': ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'],
                        'code': ['js', 'ts', 'jsx', 'tsx', 'vue', 'html', 'css', 'scss', 'less', 'java', 'py', 'go', 'rs', 'c', 'cpp', 'h', 'hpp', 'json', 'xml', 'yml', 'yaml']
                    };

                    if (type === 'other') {
                        for (let key in typeMap) {
                            if (typeMap[key].includes(ext)) return false;
                        }
                        return true;
                    }

                    return typeMap[type] && typeMap[type].includes(ext);
                },
                matchesDateRange(file) {
                    if (!file.lastModified) return false;

                    const fileDate = new Date(file.lastModified);
                    fileDate.setHours(0, 0, 0, 0);

                    if (this.filters.startDate) {
                        const startDate = new Date(this.filters.startDate);
                        startDate.setHours(0, 0, 0, 0);
                        if (fileDate < startDate) return false;
                    }

                    if (this.filters.endDate) {
                        const endDate = new Date(this.filters.endDate);
                        endDate.setHours(23, 59, 59, 999);
                        if (fileDate > endDate) return false;
                    }

                    return true;
                },
                clearFilters() {
                    this.filters.fileType = '';
                    this.filters.startDate = '';
                    this.filters.endDate = '';
                },
                setQuickDateRange(range) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    this.filters.endDate = today.toISOString().split('T')[0];

                    switch (range) {
                        case 'today':
                            this.filters.startDate = today.toISOString().split('T')[0];
                            break;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            this.filters.startDate = weekAgo.toISOString().split('T')[0];
                            break;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setDate(monthAgo.getDate() - 30);
                            this.filters.startDate = monthAgo.toISOString().split('T')[0];
                            break;
                        case 'year':
                            const yearAgo = new Date(today);
                            yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                            this.filters.startDate = yearAgo.toISOString().split('T')[0];
                            break;
                    }
                },
                // 右键菜单方法
                showContextMenu(event, type, data) {
                    event.preventDefault();
                    this.contextMenu.show = true;
                    this.contextMenu.type = type;

                    if (type === 'breadcrumb') {
                        this.contextMenu.path = data;
                    } else if (type === 'file') {
                        this.contextMenu.file = data;
                    }

                    // 在下一帧计算菜单位置，确保DOM已更新
                    this.$nextTick(() => {
                        const menuElement = document.querySelector('.context-menu');
                        if (!menuElement) return;

                        const menuWidth = menuElement.offsetWidth || 180;
                        const menuHeight = menuElement.offsetHeight || 300;
                        const windowWidth = window.innerWidth;
                        const windowHeight = window.innerHeight;
                        const mouseX = event.clientX;
                        const mouseY = event.clientY;

                        // 计算X位置（防止右侧溢出）
                        let x = mouseX;
                        if (mouseX + menuWidth > windowWidth) {
                            x = windowWidth - menuWidth - 10; // 留10px边距
                        }

                        // 计算Y位置（防止底部溢出）
                        let y = mouseY;
                        if (mouseY + menuHeight > windowHeight) {
                            y = windowHeight - menuHeight - 10; // 留10px边距
                        }

                        // 确保不超出顶部和左侧
                        x = Math.max(10, x);
                        y = Math.max(10, y);

                        this.contextMenu.x = x;
                        this.contextMenu.y = y;
                    });
                },
                hideContextMenu() {
                    this.contextMenu.show = false;
                },
                openInNewTab(path) {
                    const url = new URL(window.location.href);
                    url.searchParams.set('bucket', this.currentBucket);
                    url.searchParams.set('path', path);
                    window.open(url.toString(), '_blank');
                    this.hideContextMenu();
                },
                copyPath(path) {
                    const fullPath = this.currentBucket + '/' + path;
                    navigator.clipboard.writeText(fullPath).then(() => {
                        this.showToast('success', '路径已复制到剪贴板', '复制成功');
                    }).catch(() => {
                        this.showToast('error', '复制失败');
                    });
                    this.hideContextMenu();
                },
                copyFileName(file) {
                    navigator.clipboard.writeText(file.name).then(() => {
                        this.showToast('success', '文件名已复制到剪贴板', '复制成功');
                    }).catch(() => {
                        this.showToast('error', '复制失败');
                    });
                    this.hideContextMenu();
                },
                copyFilePath(file) {
                    const fullPath = this.currentBucket + '/' + file.key;
                    navigator.clipboard.writeText(fullPath).then(() => {
                        this.showToast('success', '完整路径已复制到剪贴板', '复制成功');
                    }).catch(() => {
                        this.showToast('error', '复制失败');
                    });
                    this.hideContextMenu();
                },
                refreshFolder() {
                    this.loadFiles();
                    this.showToast('info', '已刷新');
                    this.hideContextMenu();
                },
                // 分享文件
                shareFile(file) {
                    this.fileToShare = file;
                    this.shareUrl = '';
                    this.shareExpiresAt = null;
                    this.shareExpiration = '3600'; // 默认1小时
                    this.showShareDialog = true;
                },
                async generateShareUrl() {
                    try {
                        const response = await axios.get('/api/storage/share', {
                            params: {
                                bucketName: this.currentBucket,
                                objectKey: this.fileToShare.key,
                                expirationSeconds: parseInt(this.shareExpiration)
                            }
                        });

                        if (response.data.success) {
                            this.shareUrl = response.data.data.url;
                            this.shareExpiresAt = response.data.data.expiresAt;
                            this.showToast('success', '分享链接已生成', '生成成功');
                        } else {
                            this.showToast('error', '生成失败: ' + response.data.message, '生成失败');
                        }
                    } catch (error) {
                        console.error('生成分享链接失败:', error);
                        this.showToast('error', '生成分享链接失败', '生成失败');
                    }
                },
                copyShareUrl() {
                    navigator.clipboard.writeText(this.shareUrl).then(() => {
                        this.showToast('success', '链接已复制到剪贴板', '复制成功');
                    }).catch(() => {
                        this.showToast('error', '复制失败');
                    });
                },
                formatExpirationTime(timestamp) {
                    if (!timestamp) return '';
                    return new Date(timestamp).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                // 图片控制方法
                zoomIn() {
                    this.imageZoom = Math.min(this.imageZoom + 0.25, 3);
                },
                zoomOut() {
                    this.imageZoom = Math.max(this.imageZoom - 0.25, 0.25);
                },
                resetZoom() {
                    this.imageZoom = 1;
                    this.imageRotation = 0;
                },
                rotateImage() {
                    this.imageRotation = (this.imageRotation + 90) % 360;
                },
                // 视频播放控制方法
                updateVideoPlaybackRate() {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        video.playbackRate = this.videoPlaybackRate;
                    }
                },
                updateVideoVolume() {
                    const video = this.$refs.videoPlayer;
                    if (video) {
                        video.volume = this.videoVolume;
                    }
                },
                // PDF 预览相关方法
                async loadPdf(url) {
                    if (typeof pdfjsLib === 'undefined') {
                        throw new Error('PDF.js 库未加载');
                    }

                    try {
                        // 加载 PDF 文档 (PDF.js 2.x API)
                        const loadingTask = pdfjsLib.getDocument({
                            url: url,
                            cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/cmaps/',
                            cMapPacked: true
                        });

                        this.pdfDoc = await loadingTask.promise;
                        this.pdfTotalPages = this.pdfDoc.numPages;
                        this.pdfCurrentPage = 1;
                        this.pdfScale = 1.5;

                        // 渲染第一页
                        await this.$nextTick();
                        await this.renderPdfPage();
                    } catch (error) {
                        console.error('加载 PDF 失败:', error);
                        throw new Error('加载 PDF 失败: ' + error.message);
                    }
                },
                async renderPdfPage() {
                    if (!this.pdfDoc || !this.$refs.pdfCanvas) return;

                    // 确保页码在有效范围内
                    if (this.pdfCurrentPage < 1) this.pdfCurrentPage = 1;
                    if (this.pdfCurrentPage > this.pdfTotalPages) this.pdfCurrentPage = this.pdfTotalPages;

                    try {
                        // 重新获取 canvas 引用，确保它存在
                        await this.$nextTick();
                        const canvas = this.$refs.pdfCanvas;
                        if (!canvas) {
                            console.warn('Canvas 元素未找到');
                            return;
                        }

                        const context = canvas.getContext('2d');

                        // 获取页面
                        const page = await this.pdfDoc.getPage(this.pdfCurrentPage);

                        const viewport = page.getViewport({ scale: this.pdfScale });
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;

                        // 清空 canvas
                        context.clearRect(0, 0, canvas.width, canvas.height);

                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };

                        await page.render(renderContext).promise;
                    } catch (error) {
                        console.error('渲染 PDF 页面失败:', error);
                        this.showToast('error', `渲染 PDF 第 ${this.pdfCurrentPage} 页失败`);
                    }
                },
                prevPdfPage() {
                    if (this.pdfCurrentPage > 1) {
                        this.pdfCurrentPage--;
                        this.renderPdfPage();
                    }
                },
                nextPdfPage() {
                    if (this.pdfCurrentPage < this.pdfTotalPages) {
                        this.pdfCurrentPage++;
                        this.renderPdfPage();
                    }
                },
                zoomInPdf() {
                    this.pdfScale = Math.min(this.pdfScale + 0.25, 3.0);
                    this.renderPdfPage();
                },
                zoomOutPdf() {
                    this.pdfScale = Math.max(this.pdfScale - 0.25, 0.5);
                    this.renderPdfPage();
                },
                async toggleCompression() {
                    if (!this.imageCompression) {
                        this.compressedImageUrl = '';
                        return;
                    }

                    // 使用Canvas压缩图片
                    try {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.src = this.previewUrl;

                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = reject;
                        });

                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // 计算压缩后的尺寸（最大800px）
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // 压缩质量0.7
                        this.compressedImageUrl = canvas.toDataURL('image/jpeg', 0.7);
                    } catch (error) {
                        console.error('图片压缩失败:', error);
                        this.showToast('error', '图片压缩失败');
                        this.imageCompression = false;
                    }
                },
                // 计算文件夹大小
                async calculateFolderSize(folder) {
                    // 如果已经有缓存，直接返回
                    if (this.folderSizes[folder.key]) {
                        this.showToast('info', `文件夹大小: ${this.formatFileSize(this.folderSizes[folder.key])}`);
                        return;
                    }

                    try {
                        this.showToast('info', '正在计算文件夹大小...');

                        const response = await axios.get('/api/storage/folder/size', {
                            params: {
                                bucketName: this.currentBucket,
                                folderPath: folder.key
                            }
                        });

                        if (response.data.success) {
                            const totalSize = response.data.data.totalSize;
                            // 缓存结果
                            this.folderSizes[folder.key] = totalSize;
                            this.showToast('success', `文件夹大小: ${this.formatFileSize(totalSize)}`);
                        } else {
                            this.showToast('error', '计算失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('计算文件夹大小失败:', error);
                        this.showToast('error', '计算文件夹大小失败');
                    }
                },
                // 侧边栏宽度调整
                startResizeSidebar(event) {
                    event.preventDefault();
                    this.isResizingSidebar = true;
                    this.resizeStartX = event.clientX;
                    this.resizeStartWidth = this.sidebarWidth;
                    document.addEventListener('mousemove', this.handleResizeSidebar);
                    document.addEventListener('mouseup', this.stopResizeSidebar);
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'ew-resize';
                },
                handleResizeSidebar(event) {
                    if (!this.isResizingSidebar) return;
                    const deltaX = event.clientX - this.resizeStartX;
                    let newWidth = this.resizeStartWidth + deltaX;
                    const minWidth = 200;
                    const maxWidth = 500;
                    if (newWidth < minWidth) newWidth = minWidth;
                    else if (newWidth > maxWidth) newWidth = maxWidth;
                    this.sidebarWidth = newWidth;
                },
                stopResizeSidebar() {
                    if (!this.isResizingSidebar) return;
                    this.isResizingSidebar = false;
                    document.removeEventListener('mousemove', this.handleResizeSidebar);
                    document.removeEventListener('mouseup', this.stopResizeSidebar);
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                    localStorage.setItem('sidebarWidth', this.sidebarWidth.toString());
                },
                // 初始化图片懒加载
                initLazyLoading() {
                    // 创建Intersection Observer
                    this.imageObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.dataset.src;
                                if (src) {
                                    img.src = src;
                                    img.removeAttribute('data-src');
                                    this.imageObserver.unobserve(img);
                                }
                            }
                        });
                    }, {
                        rootMargin: '50px' // 提前50px开始加载
                    });
                },
                // 使用Google Docs Viewer预览Office文档
                async previewOfficeWithGoogleDocs() {
                    try {
                        // 获取文件的预签名URL
                        const response = await axios.get('/api/storage/share', {
                            params: {
                                bucketName: this.currentBucket,
                                objectKey: this.currentPreviewFile.key,
                                expirationSeconds: 3600 // 1小时
                            }
                        });

                        if (response.data.success) {
                            const fileUrl = encodeURIComponent(response.data.data.url);
                            const googleViewerUrl = `https://docs.google.com/viewer?url=${fileUrl}&embedded=true`;
                            window.open(googleViewerUrl, '_blank');
                        } else {
                            this.showToast('error', '获取文件URL失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('使用Google Docs预览失败:', error);
                        this.showToast('error', '预览失败，请确保文件URL可公网访问');
                    }
                },
                // 使用Microsoft Office Online预览Office文档
                async previewOfficeWithMicrosoft() {
                    try {
                        // 获取文件的预签名URL
                        const response = await axios.get('/api/storage/share', {
                            params: {
                                bucketName: this.currentBucket,
                                objectKey: this.currentPreviewFile.key,
                                expirationSeconds: 3600 // 1小时
                            }
                        });

                        if (response.data.success) {
                            const fileUrl = encodeURIComponent(response.data.data.url);
                            const ext = this.currentPreviewFile.name.split('.').pop().toLowerCase();

                            // 根据文件类型选择不同的预览服务
                            let officeViewerUrl;
                            if (['doc', 'docx'].includes(ext)) {
                                officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${fileUrl}`;
                            } else if (['xls', 'xlsx'].includes(ext)) {
                                officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${fileUrl}`;
                            } else if (['ppt', 'pptx'].includes(ext)) {
                                officeViewerUrl = `https://view.officeapps.live.com/op/view.aspx?src=${fileUrl}`;
                            }

                            window.open(officeViewerUrl, '_blank');
                        } else {
                            this.showToast('error', '获取文件URL失败: ' + response.data.message);
                        }
                    } catch (error) {
                        console.error('使用Microsoft Office Online预览失败:', error);
                        this.showToast('error', '预览失败，请确保文件URL可公网访问');
                    }
                },
                // 清除Service Worker缓存
                async clearServiceWorkerCache() {
                    if (!('serviceWorker' in navigator)) {
                        this.showToast('error', '浏览器不支持Service Worker');
                        return;
                    }

                    try {
                        const registration = await navigator.serviceWorker.ready;

                        // 向Service Worker发送清除缓存消息
                        const messageChannel = new MessageChannel();

                        const promise = new Promise((resolve, reject) => {
                            messageChannel.port1.onmessage = (event) => {
                                if (event.data.success) {
                                    resolve();
                                } else {
                                    reject(new Error('清除失败'));
                                }
                            };

                            setTimeout(() => reject(new Error('清除超时')), 5000);
                        });

                        registration.active.postMessage(
                            { type: 'CLEAR_CACHE' },
                            [messageChannel.port2]
                        );

                        await promise;
                        this.showToast('success', '缓存已清除，页面将刷新', '清除成功');

                        // 延迟刷新页面
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } catch (error) {
                        console.error('清除缓存失败:', error);
                        this.showToast('error', '清除缓存失败: ' + error.message, '清除失败');
                    }
                },
                // 文件选择相关方法
                isFileSelected(file) {
                    return this.selectedFiles.has(file.key);
                },
                toggleFileSelection(file, event) {
                    const currentIndex = this.displayFiles.findIndex(f => f.key === file.key);

                    // Ctrl/Cmd 多选
                    if (event?.ctrlKey || event?.metaKey) {
                        if (this.selectedFiles.has(file.key)) {
                            this.selectedFiles.delete(file.key);
                        } else {
                            this.selectedFiles.add(file.key);
                        }
                        this.lastClickedIndex = currentIndex;
                    }
                    // Shift 范围选择
                    else if (event?.shiftKey && this.lastClickedIndex >= 0) {
                        const start = Math.min(this.lastClickedIndex, currentIndex);
                        const end = Math.max(this.lastClickedIndex, currentIndex);
                        for (let i = start; i <= end; i++) {
                            this.selectedFiles.add(this.displayFiles[i].key);
                        }
                    }
                    // 普通单选
                    else {
                        if (this.selectedFiles.has(file.key)) {
                            this.selectedFiles.delete(file.key);
                        } else {
                            this.selectedFiles.add(file.key);
                        }
                        this.lastClickedIndex = currentIndex;
                    }
                },
                clearSelection() {
                    this.selectedFiles.clear();
                    this.lastClickedIndex = -1;
                },
                selectAll() {
                    this.displayFiles.forEach(file => {
                        this.selectedFiles.add(file.key);
                    });
                },
                invertSelection() {
                    const newSelection = new Set();
                    this.displayFiles.forEach(file => {
                        if (!this.selectedFiles.has(file.key)) {
                            newSelection.add(file.key);
                        }
                    });
                    this.selectedFiles = newSelection;
                },
                // 批量操作
                batchDownload() {
                    const selected = this.displayFiles.filter(f => this.selectedFiles.has(f.key));
                    selected.forEach(file => {
                        if (!file.isFolder) {
                            this.downloadFile(file);
                        }
                    });
                    this.showToast('success', `开始下载 ${selected.length} 个文件`, '批量下载');
                },
                batchDelete() {
                    if (this.selectedFilesCount === 0) {
                        this.showToast('error', '请先选择要删除的文件');
                        return;
                    }
                    // 显示批量删除确认对话框
                    this.showBatchDeleteDialog = true;
                },
                async confirmBatchDelete() {
                    const selected = this.selectedFilesList;

                    // 关闭对话框
                    this.showBatchDeleteDialog = false;

                    // 执行删除
                    let successCount = 0;
                    let failCount = 0;

                    for (const file of selected) {
                        try {
                            await axios.delete('/api/storage/files', {
                                params: {
                                    bucketName: this.currentBucket,
                                    objectKey: file.key
                                }
                            });
                            successCount++;
                        } catch (error) {
                            console.error('删除失败:', file.name, error);
                            failCount++;
                        }
                    }

                    if (failCount > 0) {
                        this.showToast('warning', `成功 ${successCount} 个，失败 ${failCount} 个`, '批量删除');
                    } else {
                        this.showToast('success', `已成功删除 ${successCount} 个文件`, '批量删除');
                    }

                    this.clearSelection();
                    // 清除缓存并刷新列表
                    if (this.useV2API) {
                        await this.clearCacheAndRefresh();
                    } else {
                        setTimeout(() => this.loadFiles(), 500);
                    }
                },
                // 批量移动功能
                async batchMove() {
                    if (this.selectedFilesCount === 0) {
                        this.showToast('error', '请先选择要移动的文件');
                        return;
                    }

                    // 打开对话框
                    this.showBatchMoveDialog = true;
                    this.selectedTargetFolder = '';

                    // 加载文件夹列表
                    await this.loadFolderTree();
                },
                async loadFolderTree() {
                    this.loadingFolders = true;
                    this.folderTree = [];
                    this.expandedFolders.clear();
                    this.loadingSubFolders.clear();

                    try {
                        const response = await axios.post('/api/storage/files/list', {
                            bucketName: this.currentBucket,
                            prefix: '',
                            delimiter: '/',
                            pageSize: 1000
                        });

                        if (response.data.success) {
                            const folders = response.data.data.folders || [];

                            // 只加载第一层文件夹
                            this.folderTree = folders.map(folder => ({
                                key: folder.key,
                                name: folder.name,
                                level: 0,
                                hasChildren: true, // 假设都有子文件夹，展开时再检查
                                childrenLoaded: false
                            }));
                        }
                    } catch (error) {
                        console.error('加载文件夹失败:', error);
                        this.showToast('error', '加载文件夹列表失败');
                    } finally {
                        this.loadingFolders = false;
                    }
                },
                async toggleFolder(folder) {
                    const isExpanded = this.expandedFolders.has(folder.key);

                    if (isExpanded) {
                        // 折叠：移除该文件夹的所有子文件夹
                        this.expandedFolders.delete(folder.key);
                        this.folderTree = this.folderTree.filter(f => !f.key.startsWith(folder.key) || f.key === folder.key);
                    } else {
                        // 展开：加载子文件夹
                        if (!folder.childrenLoaded) {
                            await this.loadSubFolders(folder);
                        }
                        this.expandedFolders.add(folder.key);
                    }
                },
                async loadSubFolders(parentFolder) {
                    this.loadingSubFolders.add(parentFolder.key);

                    try {
                        const response = await axios.post('/api/storage/files/list', {
                            bucketName: this.currentBucket,
                            prefix: parentFolder.key,
                            delimiter: '/',
                            pageSize: 1000
                        });

                        if (response.data.success) {
                            const subFolders = response.data.data.folders || [];

                            if (subFolders.length === 0) {
                                // 没有子文件夹，更新hasChildren
                                const folderIndex = this.folderTree.findIndex(f => f.key === parentFolder.key);
                                if (folderIndex !== -1) {
                                    this.folderTree[folderIndex].hasChildren = false;
                                }
                            } else {
                                // 将子文件夹插入到父文件夹后面
                                const parentIndex = this.folderTree.findIndex(f => f.key === parentFolder.key);
                                if (parentIndex !== -1) {
                                    const newFolders = subFolders.map(folder => ({
                                        key: folder.key,
                                        name: folder.name,
                                        level: parentFolder.level + 1,
                                        hasChildren: true,
                                        childrenLoaded: false
                                    }));

                                    // 在父文件夹后插入子文件夹
                                    this.folderTree.splice(parentIndex + 1, 0, ...newFolders);

                                    // 标记已加载
                                    this.folderTree[parentIndex].childrenLoaded = true;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('加载子文件夹失败:', parentFolder.key, error);
                        this.showToast('error', '加载子文件夹失败');
                    } finally {
                        this.loadingSubFolders.delete(parentFolder.key);
                    }
                },
                async confirmBatchMove() {
                    const targetPath = this.selectedTargetFolder === '' ? '' : this.selectedTargetFolder;
                    const filesToMove = this.selectedFilesList;

                    if (filesToMove.length === 0) {
                        this.showToast('error', '没有选择文件');
                        return;
                    }

                    // 关闭对话框，显示进度
                    this.showBatchMoveDialog = false;
                    this.moveProgress.show = true;
                    this.moveProgress.current = 0;
                    this.moveProgress.total = filesToMove.length;
                    this.moveProgress.succeeded = 0;
                    this.moveProgress.failed = 0;

                    // 逐个移动文件
                    for (const file of filesToMove) {
                        this.moveProgress.currentFile = file.name;

                        try {
                            // 计算新的key
                            const fileName = file.name;
                            const newKey = targetPath ? `${targetPath}${fileName}` : fileName;

                            // 调用重命名API（实际上是移动）
                            const response = await axios.put('/api/storage/files/rename', null, {
                                params: {
                                    bucketName: this.currentBucket,
                                    oldKey: file.key,
                                    newKey: newKey
                                }
                            });

                            if (response.data.success) {
                                this.moveProgress.succeeded++;
                            } else {
                                this.moveProgress.failed++;
                                console.error('移动失败:', file.name, response.data.message);
                            }
                        } catch (error) {
                            this.moveProgress.failed++;
                            console.error('移动失败:', file.name, error);
                        }

                        this.moveProgress.current++;
                    }

                    // 完成后显示结果
                    setTimeout(() => {
                        this.moveProgress.show = false;

                        if (this.moveProgress.failed === 0) {
                            this.showToast('success', `成功移动 ${this.moveProgress.succeeded} 个文件`, '移动完成');
                        } else {
                            this.showToast('error', `成功 ${this.moveProgress.succeeded} 个，失败 ${this.moveProgress.failed} 个`, '移动完成');
                        }

                        this.clearSelection();
                        // 清除缓存并刷新列表
                        if (this.useV2API) {
                            this.clearCacheAndRefresh();
                        } else {
                            this.loadFiles();
                        }
                    }, 1000);
                },
                // 批量复制到其他Bucket功能
                async batchCopyToBucket() {
                    if (this.selectedFilesCount === 0) {
                        this.showToast('error', '请先选择要复制的文件');
                        return;
                    }

                    // 打开对话框
                    this.showBatchCopyDialog = true;
                    this.copyStep = 1;
                    this.selectedTargetBucket = '';
                    this.keepPathStructure = true;

                    // 直接加载当前backend的buckets
                    try {
                        const response = await axios.get('/api/storage/buckets');
                        if (response.data.success) {
                            this.targetBuckets = response.data.data;
                        }
                    } catch (error) {
                        console.error('加载bucket列表失败:', error);
                        this.showToast('error', '加载Bucket列表失败');
                    }
                },
                async confirmBatchCopy() {
                    const filesToCopy = this.selectedFilesList;

                    if (filesToCopy.length === 0) {
                        this.showToast('error', '没有选择文件');
                        return;
                    }

                    if (!this.selectedTargetBucket) {
                        this.showToast('error', '请选择目标Bucket');
                        return;
                    }

                    // 关闭对话框，显示进度
                    this.showBatchCopyDialog = false;
                    this.copyProgress.show = true;
                    this.copyProgress.current = 0;
                    this.copyProgress.total = filesToCopy.length;
                    this.copyProgress.succeeded = 0;
                    this.copyProgress.failed = 0;

                    // 逐个复制文件
                    for (const file of filesToCopy) {
                        if (file.isFolder) continue; // 跳过文件夹

                        this.copyProgress.currentFile = file.name;

                        try {
                            // 计算目标key
                            let targetKey;
                            if (this.keepPathStructure) {
                                // 保留路径结构
                                targetKey = file.key;
                            } else {
                                // 只保留文件名
                                targetKey = file.name;
                            }

                            // 调用复制API（先下载再上传）
                            // 1. 下载文件
                            const downloadUrl = `/api/storage/download?bucketName=${encodeURIComponent(this.currentBucket)}&objectKey=${encodeURIComponent(file.key)}`;
                            const downloadResponse = await axios.get(downloadUrl, { responseType: 'blob' });

                            // 2. 上传到目标bucket
                            const formData = new FormData();
                            formData.append('file', new File([downloadResponse.data], file.name));
                            formData.append('bucketName', this.selectedTargetBucket);
                            formData.append('objectKey', targetKey);

                            const uploadResponse = await axios.post('/api/storage/upload', formData, {
                                headers: { 'Content-Type': 'multipart/form-data' }
                            });

                            if (uploadResponse.data.success) {
                                this.copyProgress.succeeded++;
                            } else {
                                this.copyProgress.failed++;
                                console.error('复制失败:', file.name, uploadResponse.data.message);
                            }
                        } catch (error) {
                            this.copyProgress.failed++;
                            console.error('复制失败:', file.name, error);
                        }

                        this.copyProgress.current++;
                    }

                    // 完成后显示结果
                    setTimeout(() => {
                        this.copyProgress.show = false;

                        if (this.copyProgress.failed === 0) {
                            this.showToast('success', `成功复制 ${this.copyProgress.succeeded} 个文件到 ${this.selectedTargetBucket}`, '复制完成');
                        } else {
                            this.showToast('error', `成功 ${this.copyProgress.succeeded} 个，失败 ${this.copyProgress.failed} 个`, '复制完成');
                        }

                        this.clearSelection();
                    }, 1000);
                },
                // 单个文件移动
                async singleFileMove(file) {
                    // 清空之前的选择
                    this.clearSelection();
                    // 选中当前文件
                    this.selectedFiles.add(file.key);
                    // 调用批量移动
                    await this.batchMove();
                },
                // 单个文件复制
                async singleFileCopy(file) {
                    // 清空之前的选择
                    this.clearSelection();
                    // 选中当前文件
                    this.selectedFiles.add(file.key);
                    // 调用批量复制
                    await this.batchCopyToBucket();
                },
                // 保存/加载筛选条件
                loadSavedFilters() {
                    const saved = localStorage.getItem('savedFilters');
                    if (saved) {
                        try {
                            this.savedFilters = JSON.parse(saved);
                        } catch (e) {
                            console.error('加载筛选条件失败:', e);
                            this.savedFilters = [];
                        }
                    }
                },
                confirmSaveFilter() {
                    if (!this.filterName.trim()) return;

                    const newFilter = {
                        name: this.filterName.trim(),
                        filters: {
                            fileType: this.filters.fileType,
                            startDate: this.filters.startDate,
                            endDate: this.filters.endDate
                        },
                        searchKeyword: this.searchKeyword
                    };

                    this.savedFilters.push(newFilter);
                    localStorage.setItem('savedFilters', JSON.stringify(this.savedFilters));

                    this.showSaveFilterDialog = false;
                    this.filterName = '';
                    this.showToast('success', '筛选条件已保存', '保存成功');
                },
                loadSavedFilter(saved) {
                    this.filters.fileType = saved.filters.fileType;
                    this.filters.startDate = saved.filters.startDate;
                    this.filters.endDate = saved.filters.endDate;
                    this.searchKeyword = saved.searchKeyword || '';
                    this.showToast('success', `已加载筛选条件: ${saved.name}`, '加载成功');
                },
                deleteSavedFilter(index) {
                    const filterName = this.savedFilters[index].name;
                    this.savedFilters.splice(index, 1);
                    localStorage.setItem('savedFilters', JSON.stringify(this.savedFilters));
                    this.showToast('success', `已删除筛选条件: ${filterName}`, '删除成功');
                }
            }
        }).mount('#app');

        // Service Worker 注册
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('[App] Service Worker 注册成功:', registration.scope);

                        // 检查更新
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('[App] 发现新的 Service Worker');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[App] 新的 Service Worker 已安装，刷新页面以激活');
                                    // 可以在这里显示提示让用户刷新页面
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('[App] Service Worker 注册失败:', error);
                    });
            });
        } else {
            console.log('[App] 浏览器不支持 Service Worker');
        }
    </script>
</body>
</html>
